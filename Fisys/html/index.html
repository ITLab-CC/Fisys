<!DOCTYPE html>
<html lang="de">
<head>
  
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Filament-System IT-Lab</title>
  
  <link rel="stylesheet" type="text/css" href="/static/assets/style.css" media="all">
  <meta name="theme-color" content="#222">
  <style>
  /* Input validation error visual feedback */
  input.invalid {
    border: 2px solid red;
    background-color: #441111;
  }
  body.popup-open {
    overflow: hidden;
  }
  /* === Gradient-Animation f√ºr Body-Hintergrund (jetzt als ::before Pseudoelement) === */
  html {
    background-color: #222;
    height: 100%;
  }

  body {
    min-height: 100%;
    position: relative;
    margin: 0;
    padding: 0;
    z-index: 0;
  }

  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: linear-gradient(270deg, #111, #222, #333, #222, #111);
    background-size: 400% 400%;
    animation: animated-bg 20s linear infinite;
    z-index: -1;
    pointer-events: none;
  }

  @keyframes animated-bg {
    0% { background-position: 0% 0%; }
    50% { background-position: 100% 0%; }
    100% { background-position: 0% 0%; }
  }

  /* Hinzugef√ºgt: Volle H√∂he f√ºr html und body, Margin/Padding 0 */
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <script>
    let isAdmin = false;

    function setAdminSession() {
      const zehnMinuten = Date.now() + 10 * 60 * 1000;
      localStorage.setItem("adminUntil", zehnMinuten);
      localStorage.setItem("admin", "true");

    // Aktualisiere Seite, damit alles (Stift etc.) neu angezeigt wird
      location.reload();
    }

    function updateAdminStatus() {
      const adminStatus = document.getElementById("admin-status");
      const adminUntil = localStorage.getItem("adminUntil");
      if (adminUntil && Date.now() < parseInt(adminUntil) && localStorage.getItem("admin") === "true") {
        isAdmin = true;
      } else {
        isAdmin = false;
      }

      if (isAdmin) {
        adminStatus.style.display = "block";
        enableAdminInputs();
      } else {
        adminStatus.style.display = "none";
      }

      fetchAndDisplayFilamente(); // <- Liste immer neu laden
    }

    document.addEventListener("DOMContentLoaded", () => {
      const adminUntil = localStorage.getItem("adminUntil");
      isAdmin = adminUntil && Date.now() < parseInt(adminUntil) && localStorage.getItem("admin") === "true";

      updateAdminStatus();
      if (isAdmin) enableAdminInputs();

      const settingsIcon = document.querySelector(".settings-icon");
      if (settingsIcon) {
        settingsIcon.addEventListener("click", () => {
          const login = document.getElementById("admin-login");
          const panel = document.getElementById("admin-panel");
          const imageSettings = document.getElementById("image-settings");

          if (login.style.display === "block" || panel.style.display === "block" || imageSettings.style.display === "block") {
            hideOverlay();
            login.style.display = "none";
            panel.style.display = "none";
            imageSettings.style.display = "none";
          } else {
            if (isAdmin) {
              panel.style.display = "block";
            } else {
              login.style.display = "block";
            }
            showOverlay();
          }
        });
      }

      fetchAndDisplayFilamente(); // Initiale Anzeige
    });
  </script>
</head>


<body>
  <div id="admin-status" style="display:none; position:fixed; top:0; left:50%; transform:translateX(-50%); background:#333; color:white; padding:0.3em 1em; border-radius:0 0 6px 6px; z-index:9999;">
    ‚úÖ Admin angemeldet
  </div>

  <div id="blur-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; backdrop-filter: blur(5px); background-color: rgba(0, 0, 0, 0.3); z-index: 999;"></div>

  <div class="top-bar">
    <div class="logo">
      <a href="/">
        <img src="/static/assets/Fisys Logo.png" alt="Fisys Logo">
      </a>
    </div>
    <div class="settings-icon">‚öôÔ∏è</div>
  </div>

  <div id="admin-login" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(51, 51, 51, 0.9); padding:2em; border-radius:10px; z-index:1001; width: 400px; backdrop-filter: blur(8px);">
    <p style="margin:0 0 0.5em 0;">üîí Admin-Passwort</p>
    <input type="password" id="admin-password" placeholder="Passwort eingeben" style="padding:0.5em; border-radius:5px; width:100%;">
    <script>
      document.getElementById("admin-password").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          checkAdminPassword();
        }
      });
    </script>
    <div style="margin-top:0.5em; text-align:right;">
      <button onclick="checkAdminPassword()" style="margin-right:0.5em;">OK</button>
      <button onclick='document.getElementById("admin-login").style.display="none"; hideOverlay();'>Abbrechen</button>
    </div>
  </div>

  <div id="admin-panel" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(51, 51, 51, 0.9); padding:2em; border-radius:10px; z-index:1001; width: 400px; backdrop-filter: blur(8px);">
    <h3 style="margin:0 0 1em 0;">‚öôÔ∏è Admin-Einstellungen</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
      <button style="padding: 1em; font-size: 1em;" onclick="openImageSettings()">üñºÔ∏è Bild-Einstellungen</button>
      <button style="padding: 1em; font-size: 1em;" onclick="logoutAdmin()">üö™ Abmelden</button>
      <button style="grid-column: span 2; padding: 1em; font-size: 1em;" onclick="showAddMultipleSpoolsPopup()">‚ûï Spulen hinzuf√ºgen</button>
      <button style="grid-column: span 2; padding: 1em; font-size: 1em;" onclick='document.getElementById("admin-panel").style.display="none"; hideOverlay();'>‚ùå Schlie√üen</button>
    </div>
  </div>

  <!-- Popup f√ºr mehrere Spulen hinzuf√ºgen -->
  <div id="multiple-spools-popup" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(51,51,51,0.95); padding:2em; border-radius:10px; z-index:1003; width:500px; max-width:90vw; backdrop-filter: blur(8px); color:#fff;">
    <h3>‚ûï Mehrere Spulen hinzuf√ºgen</h3>
    <label for="spool-type-select">Filament-Typ:</label>
    <select id="spool-type-select" style="width:100%; margin-bottom:1em;"></select>
    <label for="spool-count-input">Anzahl Spulen:</label>
    <input type="number" id="spool-count-input" min="1" value="1" style="width:100%; margin-bottom:1em;">
    <div style="display:flex; justify-content:space-between; gap:0.5em;">
      <button onclick="addMultipleSpools()" style="flex:1;">üíæ Hinzuf√ºgen</button>
      <button onclick="document.getElementById('multiple-spools-popup').style.display='none'; hideOverlay();" style="flex:1;">‚ùå Schlie√üen</button>
    </div>
  </div>

  <div id="image-settings" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:rgba(51, 51, 51, 0.95); padding:2em; border-radius:10px; z-index:1002; width: 500px; height: 80vh; overflow-y: auto; backdrop-filter: blur(8px);">
    <h3 style="margin-top:0; text-align:center;">üñºÔ∏è Bildverwaltung</h3>
    <p style="font-size: 0.9em; color: #ccc; text-align: center;">Lade, benenne um oder ordne Bilder Filament-Typen zu</p>

    <div style="margin-bottom: 1em; display: flex; justify-content: center; gap: 1em;">
      <button onclick="switchImageTab('upload')" style="margin-right: 0.5em;">‚¨ÜÔ∏è Bild hochladen</button>
      <button onclick="switchImageTab('manage')">üóÇÔ∏è Bild-Verwaltung</button>
    </div>

    <div id="image-upload-tab">
      <p>Bild hochladen:</p>
      <input type="file" id="upload-image" accept="image/*">
      <p style="margin-top:1em;">Neuer Dateiname (optional):</p>
      <input type="text" id="new-image-name" placeholder="z.‚ÄØB. bambu_weiss.jpg" style="width:100%; margin-bottom:0.5em;">
      <button id="save-image-btn" style="width:100%; margin-bottom:1em;">üíæ Bild speichern</button>

      <div style="width: 100%; aspect-ratio: 1 / 1; overflow: hidden; margin: 1em auto;">
        <img id="preview-image" src="" alt="Bildvorschau" style="display:none; width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
      </div>
    </div>

    <div id="image-manage-tab" style="display:none;">
      <p>Bild umbenennen:</p>
      <input type="text" id="rename-old-name" placeholder="Aktueller Dateiname" style="width:100%; margin-bottom:0.5em;">
      <input type="text" id="rename-new-name" placeholder="Neuer Dateiname" style="width:100%; margin-bottom:0.5em;">
      <button id="rename-image-btn" style="width:100%; margin-bottom:1em;">üîÑ Bild umbenennen</button>

      <p>üìÇ Bild-Verwaltung:</p>
      <div id="image-management" style="max-height:140px; overflow-y:auto; border:1px solid #666; padding:0.5em; border-radius:8px;">
        <p style="font-size:0.9em;">(Lade Bilder...)</p>
      </div>
      <p style="margin-top:1em;">Bild einem Filament-Typ zuweisen:</p>
      <select id="zuweis-name" style="width:100%; margin-bottom:0.5em;"></select>
      <input type="text" id="zuweis-bildname" placeholder="Bild-Dateiname (z.‚ÄØB. bambu.jpg)" style="width:100%;">
    </div>

    <div style="margin-top:1em; text-align:center;">
      <button onclick='document.getElementById("image-settings").style.display="none"; hideOverlay();'>Schlie√üen</button>
    </div>
  </div>
  
    <div class="center-container">
    
        <h1>Filament-System IT-Lab</h1>
        <h3></h3>
        <div class="search-bar">
  <input type="text" placeholder="Suche nach Filament" />
  <button id="show-form-button" class="action-bar" style="margin-left: 1em; padding: 0.3em 0.8em; font-size: 0.85em;">
    <span class="icon">+</span>
    <span class="label">Hinzuf√ºgen</span>
  </button>
  <a href="/status" style="margin-left: 1em; padding: 0.5em 1em; font-size: 1em; background: #3a3a3a; color: white; border: 1px solid #666; border-radius: 15px; height: 22px; line-height: 1.2em; text-decoration: none; display: inline-flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.4); font-family: inherit; font-weight: normal;">
    Lagerstatus
  </a>
</div>
<div id="pagination"></div>


<div class="gray-box">
  <div id="filament-list-wrapper">
    <div id="filament-list"></div>
  </div>
</div>


<!-- Popup f√ºr vorhandene Filament-Typen Auswahl -->
<div id="type-select-popup" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:rgba(51,51,51,0.95); padding:2em; border-radius:10px; z-index:1003; width: 500px; max-height: 80vh; overflow-y: auto; backdrop-filter: blur(8px); border: 2px solid white;">
  <h3>Vorhandene Filament-Typen</h3>
  <div id="existing-type-list" style="border: 1px solid #666; padding: 0.5em; border-radius: 8px; margin-top: 0.5em; background-color: #2b2b2b;"></div>
  <div style="margin-top:1em; text-align:right;">
    <button onclick='document.getElementById("type-select-popup").style.display="none";'>Schlie√üen</button>
  </div>
</div>

<script>
  // let isAdmin = false; // Entfernt: doppelte Deklaration, da bereits im oberen Scriptblock vorhanden.

  function checkAdminPassword() {
    const input = document.getElementById("admin-password").value;
    if (input === "Lu#@Mu23") {
      setAdminSession();
      localStorage.setItem("admin", "true");

      document.getElementById("admin-password").value = "";

      // ‚õî Fenster ausblenden (jetzt sicher)
      const login = document.getElementById("admin-login");
      const panel = document.getElementById("admin-panel");

      if (login) login.style.display = "none";
      if (panel) panel.style.display = "none";

      hideOverlay();
      enableAdminInputs();
      fetchAndDisplayFilamente();
    } else {
      alert("‚ùå Falsches Passwort");
    }
  }

  function enableAdminInputs() {
    if (!isAdmin) return;
    const fields = ["name","material","farbe","durchmesser","hersteller","leergewicht"];
    fields.forEach(id => {
      const el = document.getElementById(id + "-input");
      if (el) el.disabled = false;
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const fields = ["name","material","farbe","durchmesser","hersteller","leergewicht"];
    fields.forEach(id => {
      const el = document.getElementById(id + "-input");
      if (el) el.disabled = true;
    });
  });
function logoutAdmin() {
  localStorage.removeItem("adminUntil");
  localStorage.removeItem("admin");

  // Aktualisiere Seite ‚Äì verhindert Anzeigefehler
  location.reload();
}
</script>

<div id="popup-form">
  <!-- Button zum √ñffnen des vorhandenen Typen-Popups -->
  <div style="margin-bottom:1em;">
    <label>Vorhandenen Filament-Typ w√§hlen:</label>
    <button type="button" onclick='document.getElementById("type-select-popup").style.display="block"; showOverlay();' style="margin-top: 0.5em;">Typ ausw√§hlen</button>
  </div>
  <!-- Hinweis f√ºr Nutzer bzgl. Auswahl/Bearbeitung -->
  <p style="color: lightgray; margin-bottom: 1em;">‚ÑπÔ∏è Als normaler Nutzer kannst du nur bestehende Filament-Typen ausw√§hlen. Eigene Typen kannst du nur als Admin hinzuf√ºgen.</p>
  <form id="filament-form">
    <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
      <span style="margin-right: 0.5em;">üîí</span>
      <input type="text" name="name" id="name-input" placeholder="Name" required autocomplete="off">
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
      <span style="margin-right: 0.5em;">üîí</span>
      <input type="text" name="material" id="material-input" placeholder="Material" required autocomplete="off" >
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
      <span style="margin-right: 0.5em;">üîí</span>
      <input type="text" name="farbe" id="farbe-input" placeholder="Farbe" required autocomplete="off" >
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
      <span style="margin-right: 0.5em;">üîí</span>
      <input type="text" name="durchmesser" id="durchmesser-input" inputmode="decimal" placeholder="Durchmesser (z. B. 1,75)" autocomplete="off">
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
      <span style="margin-right: 0.5em;">üîí</span>
      <input type="text" name="hersteller" id="hersteller-input" placeholder="Hersteller (optional)" autocomplete="off" >
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
      <span style="margin-right: 0.5em;">üîí</span>
      <input type="number" name="leergewicht" id="leergewicht-input" step="1" min="0" placeholder="Leergewicht (g)" required inputmode="decimal" autocomplete="off">
    </div>
    <input type="number" name="gesamtmenge" step="10" placeholder="Gesamtmenge (g)" autocomplete="off">
    <input type="number" name="restmenge" step="10" placeholder="Restmenge (g)" autocomplete="off">
    <button type="submit" class="action-bar">
      <span class="icon">+</span>
      <span class="label">Speichern</span>
    </button>
    <button type="button" onclick="document.getElementById('popup-form').style.display='none'; hideOverlay();" style="margin-left:1em;">Abbrechen</button>
  </form>
</div>

<script>
function showOverlay() {
  document.getElementById("blur-overlay").style.display = "block";
  document.body.classList.add("popup-open");
}
function hideOverlay() {
  document.getElementById("blur-overlay").style.display = "none";
  document.body.classList.remove("popup-open");
}


function openImageSettings() {
  document.getElementById("admin-panel").style.display = "none";
  document.getElementById("image-settings").style.display = "block";
}

document.addEventListener("DOMContentLoaded", () => {
  // Setze isAdmin anhand localStorage, bevor fetchAndDisplayFilamente aufgerufen wird
  const isAdminLocal = localStorage.getItem("admin") === "true" && Date.now() < parseInt(localStorage.getItem("adminUntil") || "0");
  if (isAdminLocal) {
    isAdmin = true;
    enableAdminInputs();
  }
  // Settings-Icon Event-Listener (erneut sicherstellen, dass er gesetzt ist und nicht √ºberschrieben wird)
  const settingsIcon = document.querySelector(".settings-icon");
  if (settingsIcon) {
    settingsIcon.addEventListener("click", () => {
      const login = document.getElementById("admin-login");
      const panel = document.getElementById("admin-panel");
      const imageSettings = document.getElementById("image-settings");

      if (login.style.display === "block" || panel.style.display === "block" || imageSettings.style.display === "block") {
        hideOverlay();
        login.style.display = "none";
        panel.style.display = "none";
        imageSettings.style.display = "none";
      } else {
        if (isAdmin) {
          panel.style.display = "block";
        } else {
          login.style.display = "block";
        }
        showOverlay();
      }
    });
  }
  let filamentData = [];
  const form = document.getElementById("filament-form");
    const saveButton = form.querySelector('button[type="submit"]');
    function validateFilamentForm() {
      let valid = true;
      const stillAdmin = localStorage.getItem("admin") === "true" && Date.now() < parseInt(localStorage.getItem("adminUntil") || "0");

      ['name','material','farbe'].forEach(field => {
        const input = form.querySelector(`[name="${field}"]`);
        if (!input || input.disabled) return;
        const value = input.value.trim();
        if (!value && input.dataset.touched === "true") {
          valid = false;
          input.classList.add('invalid');
          return;
        }

        if ((field === "material" || field === "farbe") && !/^[A-Za-z√Ñ√ñ√ú√§√∂√º√ü\s\-]+$/.test(value)) {
          valid = false;
          input.classList.add('invalid');
          return;
        }

        input.classList.remove('invalid');
      });

      ['durchmesser','leergewicht','gesamtmenge','restmenge'].forEach(field => {
        const input = form.querySelector(`[name="${field}"]`);
        if (!input || input.disabled) return;
        const raw = input.value.trim().replace(',', '.');

        // Neue Pr√ºfung f√ºr durchmesser: Nur ganze Zahlen und Kommazahlen, keine Buchstaben
        if (field === "durchmesser") {
          if (!/^\d+([.,]\d+)?$/.test(raw)) {
            valid = false;
            input.classList.add('invalid');
            return;
          }
        }

        if ((field === "gesamtmenge" || field === "restmenge") && raw === "") {
          if (!stillAdmin) {
            valid = false;
            input.classList.add('invalid');
          } else {
            input.classList.remove('invalid');
          }
          return;
        }

        const num = parseFloat(raw);
        if (isNaN(num) || num <= 0) {
          if (!(stillAdmin && (field === "gesamtmenge" || field === "restmenge") && raw === "")) {
            valid = false;
            input.classList.add('invalid');
          }
        } else {
          input.classList.remove('invalid');
        }
      });

      saveButton.disabled = !valid;
    }
    form.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', validateFilamentForm);
      input.addEventListener('focus', () => {
        if (!input.disabled) {
          input.dataset.touched = "true";
        }
      });
    });
    // Mark all inputs as touched initially so validation styles are applied on load,
    // but skip gesamtmenge and restmenge for admins
    form.querySelectorAll('input').forEach(input => {
      const name = input.getAttribute("name");
      if (!input.disabled && (!localStorage.getItem("admin") || (name !== "gesamtmenge" && name !== "restmenge"))) {
        input.dataset.touched = "true";
      }
    });
    validateFilamentForm(); // Trigger initial validation
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    // Pr√ºfe, ob Admin beide Felder leer l√§sst, dann setze auf null (Adminstatus wird zum Zeitpunkt des Sendens gepr√ºft)
    const stillAdmin = localStorage.getItem("admin") === "true" && Date.now() < parseInt(localStorage.getItem("adminUntil") || "0");
    const isTypeOnly = stillAdmin && !form.gesamtmenge.value.trim() && !form.restmenge.value.trim();
    const payload = {
      name: form.name.value,
      material: form.material.value,
      farbe: form.farbe.value,
      durchmesser: parseFloat(form.durchmesser.value.trim().replace(',', '.')),
      leergewicht: parseFloat(form.leergewicht.value),
      hersteller: form.hersteller.value || null,
      gesamtmenge: isTypeOnly ? null : parseFloat(form.gesamtmenge.value),
      restmenge: isTypeOnly ? null : parseFloat(form.restmenge.value),
      verpackt: true
    };
    try {
      const res = await fetch("/spulen/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        alert("‚úÖ Hinzugef√ºgt!");
        fetchAndDisplayFilamente();
        document.getElementById("popup-form").style.display = "none";
        form.reset();
        const stillVisible = ["admin-login", "admin-panel", "image-settings", "type-select-popup", "popup-form"].some(id => {
          const el = document.getElementById(id);
          return el && el.style.display === "block";
        });
        if (!stillVisible) hideOverlay();
      } else {
        const err = await res.json();
        alert("‚ùå Fehler: " + JSON.stringify(err.detail));
      }
    } catch (err) {
      alert("‚ùå Netzwerkfehler");
      console.error(err);
    }
  });

  const ITEMS_PER_PAGE = 10;
  let currentPage = 1;

  function renderPage(data, page = 1) {
    const container = document.getElementById("filament-list");
    container.innerHTML = "";
    const start = (page - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const items = data.slice(start, end);

    items.forEach((typ) => {
      const box = document.createElement("div");
      // Rahmenfarbe pro Karte anhand der Farbe setzen
      const farbe = typ.farbe?.toLowerCase().replace(/\s+/g, "") || "";
      let farbschl√ºssel = "";
      if (farbe.includes("blau")) farbschl√ºssel = "blau";
      else if (farbe.includes("rot")) farbschl√ºssel = "rot";
      else if (farbe.includes("grau")) farbschl√ºssel = "grau";
      else if (farbe.includes("magenta")) farbschl√ºssel = "magenta";
      else if (farbe.includes("pink")) farbschl√ºssel = "pink";
      else if (farbe.includes("cyan")) farbschl√ºssel = "cyan";
      else if (farbe.includes("birke")) farbschl√ºssel = "birke";
      else if (farbe.includes("gelb")) farbschl√ºssel = "gelb";
      else if (farbe.includes("schwarz")) farbschl√ºssel = "schwarz";
      else if (farbe.includes("wei√ü") || farbe.includes("weiss")) farbschl√ºssel = "wei√ü";
      else if (farbe.includes("gr√ºn")) farbschl√ºssel = "gr√ºn";
      else if (farbe.includes("orange")) farbschl√ºssel = "orange";
      else if (farbe.includes("violett")) farbschl√ºssel = "violett";
      else if (farbe.includes("silber")) farbschl√ºssel = "silber";
      else if (farbe.includes("gold")) farbschl√ºssel = "gold";
      else if (farbe.includes("kupfer")) farbschl√ºssel = "kupfer";
      else if (farbe.includes("transparent")) farbschl√ºssel = "transparent";
      else if (farbe.includes("natur")) farbschl√ºssel = "natur";
      else if (farbe.includes("braun")) farbschl√ºssel = "braun";
      if (farbschl√ºssel) box.classList.add("border-" + farbschl√ºssel);
      // Neues Styling f√ºr die Karten-Boxen
      box.style.background = "linear-gradient(135deg, rgba(40, 40, 40, 0.95), rgba(30, 30, 30, 0.95))";
      box.style.boxShadow = "0 8px 20px rgba(0, 0, 0, 0.4)";
      box.style.borderRadius = "20px";
      box.style.backdropFilter = "blur(5px)";
      box.style.transition = "transform 0.2s ease, box-shadow 0.3s ease";
      box.style.overflow = "hidden";
      box.style.color = "#fff";
      box.style.padding = "1em";
      // Dynamische Breite je nach Bildschirmgr√∂√üe
      if (window.innerWidth < 600) {
        box.style.width = "35vw";
      } else {
        box.style.width = "200px";
      }
      box.style.textAlign = "left";
      box.style.margin = "0.5em";
      box.onmouseenter = () => {
        box.style.transform = "translateY(-5px)";
        box.style.boxShadow = "0 12px 24px rgba(0, 0, 0, 0.5)";
      };
      box.onmouseleave = () => {
        box.style.transform = "none";
        box.style.boxShadow = "0 8px 20px rgba(0, 0, 0, 0.4)";
      };

      const bildName = typ.bildname || "platzhalter.jpg";
      // Bild mit Fallback falls nicht gefunden
      box.innerHTML = `
        <div style="width: 100%; aspect-ratio: 1 / 1; overflow: hidden; margin-bottom: 1em;">
          <img src="/static/assets/images/${bildName}" alt="${typ.name}" onerror="this.onerror=null; this.src='/static/assets/images/platzhalter.jpg';" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
        </div>
        <h3 style="margin-top: 0;">${typ.name}</h3>
        <p><strong>Material:</strong> ${typ.material}</p>
        <p><strong>Farbe:</strong> ${typ.farbe}</p>
        <p><strong>Durchmesser:</strong> ${typ.durchmesser} mm</p>
        <p><strong>Hersteller:</strong> ${typ.hersteller || "-"}</p>
        <p><strong>Anzahl Spulen:</strong> ${typ.spulen.length}</p>
      `;
      // --- Admin-Button f√ºr Typ-Bearbeiten/L√∂schen ---
      if (localStorage.getItem("admin") === "true" && Date.now() < parseInt(localStorage.getItem("adminUntil") || "0")) {
        // Bearbeiten-Button mit SVG-Icon
        const editBtn = document.createElement("button");
        editBtn.className = "bearbeiten-button";
        editBtn.setAttribute("data-id", typ.id);
        editBtn.setAttribute("title", "Bearbeiten");
        editBtn.style.position = "absolute";
        editBtn.style.top = "10px";
        editBtn.style.right = "10px";
        editBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18" fill="#ffffff">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
          </svg>
        `;
        editBtn.onclick = () => {
          showOverlay();
          const popup = document.createElement("div");
          popup.id = "edit-type-popup";
          popup.style.position = "fixed";
          popup.style.top = "10%";
          popup.style.left = "50%";
          popup.style.transform = "translateX(-50%)";
          popup.style.background = "rgba(51, 51, 51, 0.95)";
          popup.style.padding = "2em";
          popup.style.borderRadius = "10px";
          popup.style.zIndex = "1003";
          popup.style.width = "400px";
          popup.style.color = "#fff";
          popup.style.backdropFilter = "blur(8px)";

          popup.innerHTML = `
            <h3>Typ bearbeiten</h3>
            <label>Name:</label>
            <input type="text" id="edit-name" value="${typ.name}" style="width:100%; margin-bottom:0.5em;">
            <label>Material:</label>
            <input type="text" id="edit-material" value="${typ.material}" style="width:100%; margin-bottom:0.5em;">
            <label>Farbe:</label>
            <input type="text" id="edit-farbe" value="${typ.farbe}" style="width:100%; margin-bottom:0.5em;">
            <label>Durchmesser:</label>
            <input type="text" id="edit-durchmesser" value="${typ.durchmesser}" style="width:100%; margin-bottom:0.5em;">
            <label>Hersteller:</label>
            <input type="text" id="edit-hersteller" value="${typ.hersteller || ""}" style="width:100%; margin-bottom:1em;">

            <label>Leergewicht (g):</label>
            <input type="number" id="edit-leergewicht" value="${typ.leergewicht}" step="1" min="0" style="width:100%; margin-bottom:1em;">

            <div style="display:flex; justify-content:space-between; gap:0.5em;">
              <button id="save-edit-btn" style="flex:1;">üíæ Speichern</button>
              <button id="delete-type-btn" style="flex:1;">üóëÔ∏è L√∂schen</button>
              <button id="close-edit-btn" style="flex:1;">‚ùå Schlie√üen</button>
            </div>
          `;

          document.body.appendChild(popup);

          document.getElementById("close-edit-btn").onclick = () => {
            popup.remove();
            hideOverlay();
          };

          document.getElementById("save-edit-btn").onclick = async () => {
            const payload = {
              name: document.getElementById("edit-name").value,
              material: document.getElementById("edit-material").value,
              farbe: document.getElementById("edit-farbe").value,
              durchmesser: parseFloat(document.getElementById("edit-durchmesser").value.replace(",", ".")),
              leergewicht: parseFloat(document.getElementById("edit-leergewicht").value),
              hersteller: document.getElementById("edit-hersteller").value.trim() || null,
              bildname: typ.bildname // ‚Üê damit der alte Bildname beibehalten wird
            };
            try {
              const res = await fetch("/typs/" + encodeURIComponent(typ.id), {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });
              if (res.ok) {
                alert("‚úÖ Typ aktualisiert.");
                popup.remove();
                hideOverlay();
                fetchAndDisplayFilamente();
              } else {
                const err = await res.json();
                alert("‚ùå Fehler: " + JSON.stringify(err.detail || "Unbekannter Fehler"));
              }
            } catch (err) {
              alert("‚ùå Netzwerkfehler");
              console.error(err);
            }
          };

          document.getElementById("delete-type-btn").onclick = async () => {
            try {
              // Pr√ºfe zuerst, ob Typ Spulen hat
              if (typ.spulen && typ.spulen.length > 0) {
                alert("‚ùå Typ kann nicht gel√∂scht werden, da noch Spulen vorhanden sind.");
                return;
              }

              if (!confirm("‚ö†Ô∏è Wirklich l√∂schen?")) return;

              const res = await fetch("/typs/" + encodeURIComponent(typ.id), { method: "DELETE" });
              if (res.ok) {
                alert("‚úÖ Typ gel√∂scht.");
                popup.remove();
                hideOverlay();
                fetchAndDisplayFilamente();
              } else {
                const err = await res.json();
                alert("‚ùå Fehler: " + (err.detail || "Unbekannter Fehler"));
              }
            } catch {
              alert("‚ùå Netzwerkfehler");
            }
          };
        };
        box.appendChild(editBtn);
        box.style.position = "relative";
      }
      box.style.cursor = "pointer";
      box.addEventListener("click", (event) => {
        if (event.target.closest("button")) return; // Verhindere Navigation bei Klick auf einen Button (wie ‚úèÔ∏è)
        window.location.href = "/typ/" + encodeURIComponent(typ.id);
      });
      container.appendChild(box);
    });

    const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    if (page > 1) {
      const prevBtn = document.createElement("button");
      prevBtn.textContent = "¬´";
      prevBtn.onclick = () => {
        currentPage = page - 1;
        renderPage(data, currentPage);
      };
      pagination.appendChild(prevBtn);
    }

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.style.margin = "0 5px";
      btn.disabled = i === page;
      btn.onclick = () => {
        currentPage = i;
        renderPage(data, i);
      };
      pagination.appendChild(btn);
    }

    if (page < totalPages) {
      const nextBtn = document.createElement("button");
      nextBtn.textContent = "¬ª";
      nextBtn.onclick = () => {
        currentPage = page + 1;
        renderPage(data, currentPage);
      };
      pagination.appendChild(nextBtn);
    }
  }

  async function fetchAndDisplayFilamente() {
    const stillAdmin = localStorage.getItem("admin") === "true" && Date.now() < parseInt(localStorage.getItem("adminUntil") || "0");
    isAdmin = stillAdmin;
    try {
      const response = await fetch("/typs/");
      const data = await response.json();

      data.sort((a, b) => a.name.localeCompare(b.name));
      filamentData = data;

      renderPage(filamentData, currentPage);

      // F√ºlle das Dropdown f√ºr vorhandene Typen
      const typeListContainer = document.getElementById("existing-type-list");
      if (typeListContainer) {
        typeListContainer.innerHTML = "";
        data.forEach(t => {
          const item = document.createElement("div");
          item.style.border = "1px solid #999";
          item.style.borderRadius = "6px";
          item.style.padding = "0.5em";
          item.style.marginBottom = "0.5em";
          item.style.background = "#3a3a3a";
          item.style.cursor = "pointer";

          item.innerHTML = `
            <strong>${t.name}</strong><br/>
            <small>${t.material}, ${t.farbe}, ${t.durchmesser}mm, ${t.hersteller || "-"}</small><br/>
            <button type="button" style="margin-top: 0.5em;">Ausw√§hlen</button>
          `;

          item.querySelector("button").addEventListener("click", () => {
            form.name.value = t.name;
            form.material.value = t.material;
            form.farbe.value = t.farbe;
            form.durchmesser.value = t.durchmesser;
            form.hersteller.value = t.hersteller || "";
            form.leergewicht.value = t.leergewicht || 0;
            // Felder als g√ºltig markieren (rot entfernen)
            [form.name, form.material, form.farbe, form.durchmesser, form.hersteller].forEach(input => {
              input.classList.remove("invalid");
            });
            form.gesamtmenge.value = "";
            form.restmenge.value = "";

            // Schlie√üe nur das Popup, lasse Overlay sichtbar
            document.getElementById("type-select-popup").style.display = "none";
          });

          typeListContainer.appendChild(item);
        });
      }
    } catch (err) {
      console.error("Fehler beim Abrufen der Filamenttypen:", err);
    }
  }

  fetchAndDisplayFilamente();

  const searchInput = document.querySelector(".search-bar input");
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.trim().toLowerCase();
    const filtered = filamentData.filter(typ =>
      typ.name.toLowerCase().includes(query) ||
      typ.material.toLowerCase().includes(query) ||
      typ.farbe.toLowerCase().includes(query) ||
      String(typ.durchmesser).toLowerCase().includes(query) ||
      (typ.hersteller && typ.hersteller.toLowerCase().includes(query))
    );
    currentPage = 1;
    renderPage(filtered, currentPage);
  });

  document.getElementById("show-form-button").addEventListener("click", () => {
    const popup = document.getElementById("popup-form");
    popup.style.display = "block";
    showOverlay();
    updateAdminStatus();
    enableAdminInputs();
    validateFilamentForm();
  });
});

// --- Mehrere Spulen hinzuf√ºgen (Admin) ---
function showAddMultipleSpoolsPopup() {
  document.getElementById("admin-panel").style.display = "none";
  hideOverlay();
  fetch('/typs/')
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("spool-type-select");
      select.innerHTML = "";
      data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.name} (${t.material}, ${t.farbe}, ${t.durchmesser}mm)`;
        select.appendChild(opt);
      });
      document.getElementById("multiple-spools-popup").style.display = "block";
      showOverlay();
    })
    .catch(err => {
      console.error("Fehler beim Laden der Typen:", err);
      alert("‚ùå Typen konnten nicht geladen werden.");
    });
}

async function addMultipleSpools() {
  const typId = document.getElementById("spool-type-select").value;
  const count = parseInt(document.getElementById("spool-count-input").value);
  if (!typId || isNaN(count) || count <= 0) {
    alert("‚ùå Bitte g√ºltige Anzahl und Typ ausw√§hlen.");
    return;
  }

  let menge = 1000;
  let typ = null;
  if (window.filamentData && Array.isArray(filamentData)) {
    typ = filamentData.find(t => t.id == typId);
  }
  if (!typ) {
    try {
      const data = await fetch('/typs/').then(res => res.json());
      typ = data.find(t => t.id == typId);
    } catch {}
  }
  if (typ && typ.spulen && typ.spulen.length > 0 && typ.spulen[0].gesamtmenge) {
    menge = typ.spulen[0].gesamtmenge;
  }

  for (let i = 0; i < count; i++) {
    await fetch("/spulen/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: typ.name,
        material: typ.material,
        farbe: typ.farbe,
        durchmesser: typ.durchmesser,
        leergewicht: typ.leergewicht || 0,
        hersteller: typ.hersteller || null,
        gesamtmenge: menge,
        restmenge: menge,
        verpackt: true
      })
    });
  }

  alert(`‚úÖ ${count} Spulen hinzugef√ºgt.`);
  document.getElementById("multiple-spools-popup").style.display = "none";
  hideOverlay();
  fetchAndDisplayFilamente();
  location.reload();
}

// Funktion: Spule zu vorhandenem Typ hinzuf√ºgen (ORIGINAL)
async function addSpoolToExistingType() {
  const selected = document.getElementById("existing-type").value;
  if (!selected) {
    alert("‚ùå Bitte w√§hle einen Filament-Typ aus.");
    return;
  }

  const payload = {
    name: selected,
    material: null,
    farbe: null,
    durchmesser: null,
    hersteller: null,
    gesamtmenge: 0,
    restmenge: 0
  };

  try {
    const res = await fetch("/spulen/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      alert("‚úÖ Spule wurde dem vorhandenen Typ hinzugef√ºgt.");
      // Aktualisiere die Filamentliste
      if (typeof fetchAndDisplayFilamente === "function") {
        fetchAndDisplayFilamente();
      }
    } else {
      const err = await res.json();
      alert("‚ùå Fehler: " + JSON.stringify(err.detail));
    }
  } catch (err) {
    alert("‚ùå Netzwerkfehler");
    console.error(err);
  }
}

// Funktion zum Entfernen der Typ-Zuweisung von einem Bild
async function unassignImage(bildname) {
  if (!confirm(`M√∂chtest du die Zuweisung f√ºr das Bild "${bildname}" wirklich entfernen?`)) return;

  const response = await fetch(`/bilder/${encodeURIComponent(bildname)}/entferne-typ`, {
    method: "PATCH"
  });

  if (response.ok) {
    alert(`‚úÖ Zuweisung entfernt.`);
    await loadImageManagement();
    await fetchAndDisplayFilamente();
  } else {
    alert("‚ùå Fehler beim Entfernen der Zuweisung.");
  }
}

async function deleteImage(name) {
  if (!confirm(`M√∂chtest du das Bild "${name}" wirklich l√∂schen?`)) return;

  try {
    const response = await fetch(`/bilder/${encodeURIComponent(name)}`, {
      method: "DELETE"
    });

    if (response.ok) {
      alert("‚úÖ Bild wurde gel√∂scht.");
      await loadImageManagement();
      await fetchAndDisplayFilamente(); // <- nach erfolgreichem L√∂schen
    } else {
      const errorData = await response.json();
      console.error("Fehler beim L√∂schen:", errorData);
      alert("‚ùå Fehler beim L√∂schen: " + (errorData.detail || "Unbekannter Fehler."));
    }
  } catch (err) {
    console.error("Netzwerkfehler beim L√∂schen:", err);
    if (!err instanceof Response) {
      alert("‚ùå Netzwerkfehler beim L√∂schen.");
    }
  }
}

// ESC schlie√üt nur das oberste sichtbare Popup, Blur wird entfernt wenn kein Popup mehr offen ist
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    const overlays = [
      "admin-login",
      "admin-panel",
      "image-settings",
      "type-select-popup",
      "popup-form"
    ];
    let closedOne = false;
    for (const id of overlays) {
      const el = document.getElementById(id);
      if (el && el.style.display === "block") {
        el.style.display = "none";
        closedOne = true;
        break; // close only the first visible one
      }
    }

    if (closedOne) {
      const stillVisible = overlays.some(id => {
        const el = document.getElementById(id);
        return el && el.style.display === "block";
      });
      if (!stillVisible) hideOverlay();
    }
  }
});
document.getElementById("upload-image").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const img = document.getElementById("preview-image");
    img.src = e.target.result;
    img.style.display = "block";
  };
  reader.readAsDataURL(file);
});

document.getElementById("save-image-btn").addEventListener("click", async function () {
  const fileInput = document.getElementById("upload-image");
  const file = fileInput.files[0];
  const customName = document.getElementById("new-image-name").value.trim();

  if (!file) {
    alert("‚ùå Bitte w√§hle ein Bild aus.");
    return;
  }

  // Dateityp-Pr√ºfung: Nur JPG oder PNG erlauben
  const allowedTypes = ['image/jpeg', 'image/png'];
  if (!allowedTypes.includes(file.type)) {
    alert("‚ùå Nur JPG- oder PNG-Dateien erlaubt.");
    return;
  }

  let finalFileName;
  if (customName) {
    finalFileName = customName.endsWith(".jpg") || customName.endsWith(".png") ? customName : customName + ".jpg";
  } else {
    finalFileName = file.name;
  }

  // NEU: Pr√ºfe, ob der Name bereits existiert
  const responseCheck = await fetch("/bilder/");
  const images = await responseCheck.json();
  if (images.some(img => img.bildname === finalFileName)) {
    alert("‚ùå Es existiert bereits ein Bild mit diesem Namen.");
    return;
  }

  const renamedFile = new File([file], finalFileName, { type: file.type });

  const formData = new FormData();
  formData.append("file", renamedFile);

  const response = await fetch("/upload-image/", {
    method: "POST",
    body: formData
  });

  if (response.ok) {
    alert("‚úÖ Bild erfolgreich gespeichert.");
    document.getElementById("new-image-name").value = "";
    document.getElementById("preview-image").style.display = "none";
    fileInput.value = "";
    fetchAvailableImages();
  } else {
    alert("‚ùå Fehler beim Speichern.");
  }
});

// Bild einem Typ zuweisen
document.getElementById("zuweis-bildname").addEventListener("keydown", async function (e) {
  if (e.key === "Enter") {
    const id = document.getElementById("zuweis-name").value.trim();
    const bildname = document.getElementById("zuweis-bildname").value.trim();
    if (!id || !bildname) {
      alert("Bitte Typname und Bildname angeben.");
      return;
    }

    const response = await fetch(`/typs/${encodeURIComponent(id)}/bild?bildname=${encodeURIComponent(bildname)}`, {
      method: "PATCH"
    });

    if (response.ok) {
      alert("‚úÖ Bild wurde zugewiesen.");
      fetchAndDisplayFilamente();
    } else {
      alert("‚ùå Fehler beim Zuweisen.");
    }
  }
});

async function fetchAvailableImages() {
  try {
    const response = await fetch("/bilder/");
    const images = await response.json();
    // Functionality for populating image selection removed
  } catch (err) {
    console.error("Fehler beim Abrufen der Bildliste:", err);
  }
}

// NEU: Funktion zum Laden der Typenliste f√ºr das Dropdown
async function fetchAvailableTypen() {
  try {
    const response = await fetch("/typs/");
    const data = await response.json();
    const select = document.getElementById("zuweis-name");
    const previouslySelected = select.value; // speichere alten Wert

    select.innerHTML = "";
    data.forEach(typ => {
      const opt = document.createElement("option");
      opt.value = typ.id;
      opt.textContent = `${typ.name} (${typ.material}, ${typ.farbe}, ${typ.durchmesser}mm)`;
      if (String(typ.id) === previouslySelected) {
        opt.selected = true;
      }
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Fehler beim Abrufen der Typenliste:", err);
  }
}

// --- Bildverwaltung: Funktion zum Laden der Bildmanagement-Ansicht ---
async function loadImageManagement() {
  try {
    const files = await (await fetch("/bilder/")).json();

    const container = document.getElementById("image-management");
    container.innerHTML = "";

    for (const file of files) {
      // Skip placeholder image so it cannot be deleted
      if (file.bildname === "platzhalter.jpg") {
        continue;
      }
      const name = file.bildname;
      const typname = file.typ_name && file.typ_farbe ? `${file.typ_name} (${file.typ_farbe})` : "-";
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.marginBottom = "0.5em";
      row.innerHTML = `
        <img src="/static/assets/images/${name}" alt="${name}" style="width:32px; height:32px; object-fit:cover; border-radius:4px; margin-right:0.5em;">
        <div style="flex-grow:1;">
          <div style="font-size:0.9em;">${name}</div>
          <div style="font-size:0.8em; color:#ccc;">Typ: ${typname}</div>
        </div>
        <button style="margin-left:0.5em;" onclick="document.getElementById('rename-old-name').value='${name}'; document.getElementById('zuweis-bildname').value='${name}'; document.getElementById('zuweis-name').value='${file.typ_id || ""}';">‚úèÔ∏è</button>
        <button style="margin-left:0.5em;" onclick="unassignImage('${name}')">üö´</button>
        <button style="margin-left:0.5em;" onclick="deleteImage('${name}')">üóëÔ∏è</button>
      `;
      container.appendChild(row);
    }
  } catch (err) {
    console.error("Fehler beim Laden der Bildverwaltung:", err);
  }
}

document.getElementById("image-settings").addEventListener("click", () => {
  fetchAvailableTypen();
  fetchAvailableImages();
  loadImageManagement();
});
function switchImageTab(tab) {
  document.getElementById("image-upload-tab").style.display = tab === "upload" ? "block" : "none";
  document.getElementById("image-manage-tab").style.display = tab === "manage" ? "block" : "none";
  
  if (tab === "manage") {
    fetchAvailableImages();
    loadImageManagement();
  }
}
// --- Bild-Typ Dropdown: Speichere Auswahl und halte sie beim Bildname-Fokus ---
let selectedTypName = "";

document.getElementById("zuweis-name").addEventListener("change", function () {
  selectedTypName = this.value;
});

// Entferne den Fokus-Handler, da er den Wert √ºberschreibt
</script>

<script>
document.getElementById("rename-image-btn").addEventListener("click", async function () {
  const oldName = document.getElementById("rename-old-name").value.trim();
  const newName = document.getElementById("rename-new-name").value.trim();

  if (!oldName || !newName) {
    alert("Bitte sowohl alten als auch neuen Namen angeben.");
    return;
  }

  const response = await fetch(`/bilder/rename?old=${encodeURIComponent(oldName)}&new=${encodeURIComponent(newName)}`, {
    method: "PATCH"
  });

  if (response.ok) {
    alert("‚úÖ Bild wurde umbenannt.");
    fetchAvailableImages();
    document.getElementById("rename-old-name").value = "";
    document.getElementById("rename-new-name").value = "";
  } else {
    alert("‚ùå Fehler beim Umbenennen.");
  }
});


// Helper zum Bild-Typ-Zuweisen direkt im Bildmanagement
async function assignImageToType(bildname, typname) {
  if (!bildname || !typname) {
    alert("‚ùå Bitte Bildname und Typname angeben.");
    return;
  }

  const response = await fetch(`/typs/${encodeURIComponent(typname)}/bild?bildname=${encodeURIComponent(bildname)}`, {
    method: "PATCH"
  });

  if (response.ok) {
    alert(`‚úÖ Bild wurde dem Typ "${typname}" zugewiesen.`);
    await loadImageManagement();
    fetchAndDisplayFilamente();
  } else {
    alert("‚ùå Fehler beim Zuweisen.");
  }
}
