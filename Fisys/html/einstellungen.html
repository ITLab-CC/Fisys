<!DOCTYPE html>
<html lang="de">
  <head>
    <style>
      .menu-highlight {
        transition: background-color 0.2s ease, transform 0.3s ease;
      }

      .highlight-bar {
        transition: all 0.3s ease;
        position: absolute;
        left: 0;
        width: 4px;
        height: 100%;
        background-color: #cbd5e1; /* Tailwind's gray-300 */
        border-radius: 2px;
      }

      .highlight-container {
        position: relative;
      }
    </style>
    <meta charset="UTF-8" />
    <title>Einstellungen | Fisys</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen flex bg-gray-50">
    <!-- Sidebar -->
    <aside class="w-64 bg-[#0f172a] text-white flex flex-col justify-between fixed h-full">
      <div>
        <div class="pt-1 pb-1">
          <img src="/static/assets/Fisys Logo.png" alt="Fisys Logo" class="h-20 mx-auto">
        </div>
        <nav class="px-4 space-y-2">
          <a href="/" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Dashboard</a>
          <a href="/spulen.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Spulen</a>
          <a href="/filamentseite.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Filamenttypen</a>
          <hr class="my-2 border-gray-700" />
          <a href="/status" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Status</a>
          <a href="/einstellungen.html" class="block px-4 py-2 rounded bg-gray-800 font-semibold text-white">Einstellungen</a>
        </nav>
      </div>
      <div class="mt-auto">
        <div class="px-4 pb-2" id="authBereich">
          <!-- Wird per JavaScript ersetzt durch Login- oder Logout-Button -->
        </div>
        <div class="p-4 text-xs text-center text-gray-400">© 2025 Fisys</div>
      </div>
    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col ml-64">
      <header class="bg-gray-50 px-10 py-10 relative">
        <h1 class="text-3xl font-bold">Einstellungen</h1>
        <p class="text-sm text-gray-500 mt-1">Verwalte globale Optionen und Systemeinstellungen</p>
      </header>

      <section class="flex-1 pt-2 px-10 pb-10">
        <div class="flex flex-col xl:flex-row gap-8">
          <!-- Seitenmenü -->
          <aside class="w-full xl:w-1/4 bg-white shadow rounded p-4">
            <nav id="einstellungsMenue" class="space-y-4 highlight-container">
              <div id="highlightBar" class="highlight-bar hidden"></div>
              <div>
                <p class="text-sm font-semibold text-gray-500 mb-1">Bildeinstellungen</p>
                <button data-ziel="bilderVerwaltung" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">Bild hochladen</button>
                <button data-ziel="vorhandeneBilderBlock" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">Vorhandene Bilder</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-gray-500 mb-1">Tokens</p>
                <button data-ziel="tokenBlockContainer" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">Token erstellen</button>
                <button data-ziel="tokenUebersichtBlockContainer" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">Token Übersicht</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-gray-500 mb-1">User</p>
                <button data-ziel="userVerwaltungBlock" class="block w-full text-left px-3 py-2 rounded hover:bg-gray-100 text-sm">User verwalten</button>
              </div>
            </nav>
          </aside>

          <!-- Inhalt -->
          <div class="flex-1 space-y-10">
            <!-- Filamentbild hochladen -->
            <div id="bilderVerwaltung" class="hidden bg-white p-6 rounded shadow">
              <h2 class="text-xl font-semibold mb-4">Filamentbild hochladen</h2>
              <form id="uploadForm" class="space-y-4">
                <div>
                  <label for="bild" class="block text-sm font-medium text-gray-700 mb-1">Bild auswählen</label>
                  <input type="file" id="bild" name="file" accept="image/*" class="block w-full text-sm text-gray-700 border rounded px-3 py-2">
                </div>
                <div id="bildVorschauContainer" class="mt-2 hidden">
                  <p class="text-sm text-gray-600 mb-1">Vorschau:</p>
                  <img id="bildVorschau" src="" alt="Bildvorschau" class="h-24 rounded border">
                </div>
                <div>
                  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">Bild hochladen</button>
                </div>
              </form>
            </div>

            <!-- Token erstellen -->
            <div id="tokenBlockContainer" class="hidden"></div>

            <!-- Vorhandene Bilder -->
            <div id="vorhandeneBilderBlock" class="hidden bg-white p-6 rounded shadow">
              <h2 class="text-xl font-semibold mb-4">Vorhandene Bilder verwalten</h2>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left border">
                  <thead class="bg-gray-100 border-b">
                    <tr>
                      <th class="px-4 py-2">Bild</th>
                      <th class="px-4 py-2">Zugewiesener Typ</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="bildVerwaltungTabelle"></tbody>
                </table>
              </div>
            </div>

            <!-- Token-Tabelle -->
            <div id="tokenUebersichtBlockContainer" class="hidden"></div>

            <!-- User-Verwaltung -->
            <div id="userVerwaltungBlock" class="hidden bg-white p-6 rounded shadow">
              <h2 class="text-xl font-semibold mb-4">User verwalten</h2>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left border">
                  <thead class="bg-gray-100 border-b">
                    <tr>
                      <th class="px-4 py-2">Benutzername</th>
                      <th class="px-4 py-2">Rolle</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="userTabelleBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Highlight-Bar-Referenz
      const highlightBar = document.getElementById("highlightBar");
      // Wechsel zwischen Einstellungsbereichen mit Highlight-Bar
      document.getElementById("einstellungsMenue").addEventListener("click", (e) => {
        const ziel = e.target.dataset.ziel;
        if (!ziel || !e.target.matches("button")) return;

        // Vorheriges Highlight entfernen
        document.querySelectorAll('#einstellungsMenue button').forEach(btn => {
          btn.classList.remove('bg-gray-100', 'menu-highlight');
        });
        e.target.classList.add('bg-gray-100', 'menu-highlight');

        // Highlight-Bar-Animation
        const buttonRect = e.target.getBoundingClientRect();
        const containerRect = e.currentTarget.getBoundingClientRect();
        const offsetTop = e.target.offsetTop;

        highlightBar.style.top = offsetTop + "px";
        highlightBar.style.height = e.target.offsetHeight + "px";
        highlightBar.classList.remove("hidden");

        // Bereiche verstecken und Ziel anzeigen
        const bereiche = ["bilderVerwaltung", "vorhandeneBilderBlock", "tokenBlockContainer", "tokenUebersichtBlockContainer", "userVerwaltungBlock"];
        bereiche.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });

        const zielElement = document.getElementById(ziel);
        if (zielElement) zielElement.classList.remove("hidden");
      });
      // Anfangs alle Bereiche verstecken
      const bereiche = ["bilderVerwaltung", "vorhandeneBilderBlock", "tokenBlockContainer", "tokenUebersichtBlockContainer", "userVerwaltungBlock"];
      bereiche.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });
      let benutzerRolle = null;
      const tokenBlock = document.createElement("div");
      tokenBlock.className = "bg-white p-6 rounded shadow max-w-xl mt-10";
      tokenBlock.innerHTML = `
        <h2 class="text-xl font-semibold mb-4">Registrierungstoken erstellen</h2>
        <form id="tokenForm" class="space-y-4">
          <div>
            <label for="rolle" class="block text-sm font-medium text-gray-700 mb-1">Rolle auswählen</label>
            <select id="rolle" name="rolle" required class="block w-full text-sm text-gray-700 border rounded px-3 py-2">
              <option value="">-- auswählen --</option>
              <option value="user">User</option>
              <option value="helper">Helper</option>
              <option value="mod">Mod</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div>
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">Token generieren</button>
          </div>
        </form>
        <div id="tokenAnzeige" class="mt-4 hidden">
          <p class="text-sm text-gray-700">Token:</p>
          <code id="generierterToken" class="block text-center mt-1 text-lg font-mono text-blue-600 bg-blue-100 p-2 rounded">________</code>
        </div>
      `;
      // Token-Übersicht-Block erstellen
      const tokenUebersichtBlock = document.createElement("div");
      tokenUebersichtBlock.className = "bg-white p-6 rounded shadow max-w-xl mt-6";
      tokenUebersichtBlock.innerHTML = `
        <h2 class="text-xl font-semibold mb-4">Alle Tokens</h2>
        <div id="tokenTabelleWrapper" class="overflow-x-auto">
          <table class="min-w-full text-sm text-left border">
            <thead class="bg-gray-100 border-b">
              <tr>
                <th class="px-4 py-2">Token</th>
                <th class="px-4 py-2">Rolle</th>
                <th class="px-4 py-2">Verwendet</th>
                <th class="px-4 py-2">Aktion</th>
              </tr>
            </thead>
            <tbody id="tokenTabelleBody"></tbody>
          </table>
        </div>
      `;
      const authBereich = document.getElementById("authBereich");
      try {
        const res = await fetch("/api/userinfo");
        if (!res.ok) throw new Error("Nicht eingeloggt");
        const daten = await res.json();
        benutzerRolle = daten.rolle;
        // Auth-Bereich dynamisch anpassen (Login/Logout, Benutzername)
        authBereich.innerHTML = `
          <form id="logoutForm" class="flex flex-col items-center">
            <span class="text-sm text-gray-300 mb-1">Angemeldet als ${daten.username}</span>
            <button type="submit" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition w-full">Logout</button>
          </form>
        `;
        document.getElementById("logoutForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const res = await fetch("/logout", { method: "POST" });
            if (res.ok) {
              window.location.href = "/login";
            }
          } catch (err) {
            console.error("Logout fehlgeschlagen", err);
          }
        });
      } catch (err) {
        console.warn("Nicht eingeloggt – Weiterleitung zur Login-Seite");
        window.location.href = "/login";
        return;
      }

      const tableBody = document.getElementById("bildVerwaltungTabelle");

      function zeigeBenachrichtigung(text, farbe = "blue") {
        const box = document.getElementById("benachrichtigung");
        box.textContent = text;
        box.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-${farbe}-600 text-white px-4 py-2 rounded shadow z-50 text-sm`;
        box.classList.remove("hidden");
        setTimeout(() => box.classList.add("hidden"), 3000);
      }

      async function ladeBilder() {
        try {
          const response = await fetch("/bilder/");
          const bilder = await response.json();

          tableBody.innerHTML = "";

          bilder.forEach((bild) => {
            if (bild.bildname === "platzhalter.jpg") return;
            const row = document.createElement("tr");
            row.classList.add("border-b");

            const imgCell = document.createElement("td");
            imgCell.className = "px-4 py-2";
            imgCell.innerHTML = `<img src="/static/assets/images/${bild.bildname}" alt="${bild.bildname}" class="h-16 rounded object-contain" />`;

            const typCell = document.createElement("td");
            typCell.className = "px-4 py-2";
            typCell.innerText = bild.zugewiesen_an
              ? `${bild.zugewiesen_an.name} (${bild.zugewiesen_an.material}, ${bild.zugewiesen_an.farbe}, ${bild.zugewiesen_an.durchmesser}mm)`
              : "Nicht zugewiesen";

            const actionsCell = document.createElement("td");
            actionsCell.className = "px-4 py-2 space-x-2";

            const entknopf = document.createElement("button");
            entknopf.innerText = "Zuweisung entfernen";
            entknopf.className = "px-2 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600";

            entknopf.addEventListener("click", async () => {
              zeigePopup("Zuweisung dieses Bildes entfernen?", async () => {
                try {
                  const res = await fetch(`/bilder/${bild.bildname}/entferne-typ`, { method: "PATCH" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Zuweisung entfernt", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Entfernen der Zuweisung:", err);
                  zeigeBenachrichtigung("Fehler beim Entfernen der Zuweisung.", "red");
                }
              });
            });

            const typwechsel = document.createElement("button");
            typwechsel.innerText = "Typ ändern";
            typwechsel.className = "px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600";

            typwechsel.addEventListener("click", async () => {
              zeigeTypPopup(async (typId) => {
                try {
                  const formData = new FormData();
                  formData.append("bildname", bild.bildname);
                  const res = await fetch(`/typs/${typId}/bild`, {
                    method: "PATCH",
                    body: formData,
                  });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Typ erfolgreich zugewiesen.", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Typwechsel:", err);
                  zeigeBenachrichtigung("Fehler beim Zuweisen des Typs.", "red");
                }
              });
            });

            const löschen = document.createElement("button");
            löschen.innerText = "Löschen";
            löschen.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";

            löschen.addEventListener("click", async () => {
              zeigePopup("Dieses Bild wirklich löschen?", async () => {
                try {
                  const res = await fetch(`/bilder/${bild.bildname}`, { method: "DELETE" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Bild gelöscht.", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Löschen:", err);
                  zeigeBenachrichtigung("Fehler beim Löschen des Bildes.", "red");
                }
              });
            });

            actionsCell.append(entknopf, typwechsel, löschen);
            row.append(imgCell, typCell, actionsCell);
            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Fehler beim Laden der Bilder:", err);
        }
      }

      ladeBilder();

      function zeigePopup(text, onConfirm) {
        const overlay = document.getElementById("popupOverlay");
        const popupText = document.getElementById("popupText");
        const popupConfirm = document.getElementById("popupConfirm");
        const popupCancel = document.getElementById("popupCancel");

        popupText.innerText = text;
        overlay.classList.remove("hidden");

        const confirmHandler = () => {
          overlay.classList.add("hidden");
          onConfirm();
          popupConfirm.removeEventListener("click", confirmHandler);
        };

        popupConfirm.addEventListener("click", confirmHandler);
        popupCancel.onclick = () => overlay.classList.add("hidden");
      }

      const uploadForm = document.getElementById("uploadForm");
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        const file = formData.get("file");
        if (!file || !file.name) {
          zeigeBenachrichtigung("Bitte ein Bild auswählen.", "red");
          return;
        }
        try {
          const response = await fetch("/upload-image/", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) {
            const error = await response.text();
            throw new Error(error);
          }
          zeigeBenachrichtigung("Bild erfolgreich hochgeladen!", "blue");
          uploadForm.reset();
          ladeBilder();
        } catch (err) {
          console.error("Fehler beim Hochladen:", err);
          zeigeBenachrichtigung("Fehler beim Hochladen des Bildes.", "red");
        }
      });

      // Bild-Vorschau anzeigen
      const bildInput = document.getElementById("bild");
      const vorschauContainer = document.getElementById("bildVorschauContainer");
      const vorschauBild = document.getElementById("bildVorschau");

      bildInput.addEventListener("change", () => {
        const file = bildInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            vorschauBild.src = reader.result;
            vorschauContainer.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          vorschauContainer.classList.add("hidden");
        }
      });
    // Modales Popup zum Eingeben der Typ-ID
    function zeigeTypPopup(onConfirm) {
      const overlay = document.getElementById("typPopupOverlay");
      const select = document.getElementById("typPopupSelect");
      const confirmBtn = document.getElementById("typPopupConfirm");
      const cancelBtn = document.getElementById("typPopupCancel");

      // Vorherige Optionen löschen
      select.innerHTML = `<option value="">-- Typ auswählen --</option>`;

      // Typen laden
      fetch("/typs/")
        .then((res) => res.json())
        .then((typen) => {
          typen.forEach((typ) => {
            const option = document.createElement("option");
            option.value = typ.id;
            option.textContent = `${typ.name} (${typ.material}, ${typ.farbe}, ${typ.durchmesser}mm)`;
            select.appendChild(option);
          });
        });

      overlay.classList.remove("hidden");

      const confirmHandler = () => {
        const typId = select.value;
        if (!typId) return;
        overlay.classList.add("hidden");
        onConfirm(typId);
        confirmBtn.removeEventListener("click", confirmHandler);
      };

      confirmBtn.addEventListener("click", confirmHandler);
      cancelBtn.onclick = () => overlay.classList.add("hidden");
    }

      if (["helper", "mod", "admin"].includes(benutzerRolle)) {
        // Bereiche beim Laden weiterhin versteckt lassen, keine .classList.remove("hidden")!
        // Token-Blöcke nur DOM hinzufügen, aber nicht sichtbar machen
        if (["mod", "admin"].includes(benutzerRolle)) {
          document.getElementById("tokenBlockContainer").appendChild(tokenBlock);
          document.getElementById("tokenUebersichtBlockContainer").appendChild(tokenUebersichtBlock);
          // Sichtbarkeit wird durch Menü gesteuert, nicht hier!
          // Nach dem Erzeugen des Tokenblocks: Rollen-Optionen beschränken
          const rolleSelect = tokenBlock.querySelector("#rolle");
          const erlaubteOptionen = benutzerRolle === "admin" ? ["user", "helper", "mod", "admin"] : ["user", "helper"];
          [...rolleSelect.options].forEach(opt => {
            if (opt.value && !erlaubteOptionen.includes(opt.value)) {
              opt.remove();
            }
          });
          ladeTokenTabelle();
          const tokenForm = document.getElementById("tokenForm");
          tokenForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const rolle = document.getElementById("rolle").value;
            if (!rolle) {
              zeigeBenachrichtigung("Bitte eine Rolle auswählen", "red");
              return;
            }
            const erlaubteRollen = benutzerRolle === "admin" ? ["user", "helper", "mod", "admin"] : ["user", "helper"];
            if (!erlaubteRollen.includes(rolle)) {
              zeigeBenachrichtigung("Du darfst nur Tokens für niedrigere Rollen erstellen.", "red");
              return;
            }
            try {
              const res = await fetch("/admin/create-token", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ rolle })
              });
              if (!res.ok) throw new Error(await res.text());
              const daten = await res.json();
              document.getElementById("generierterToken").textContent = daten.token;
              document.getElementById("tokenAnzeige").classList.remove("hidden");
              zeigeBenachrichtigung("Token erfolgreich erstellt.", "blue");
            } catch (err) {
              console.error("Token-Erstellung fehlgeschlagen", err);
              zeigeBenachrichtigung("Fehler beim Erstellen des Tokens.", "red");
            }
          });
        }
      } else {
        document.getElementById("bilderVerwaltung").remove();
        document.getElementById("vorhandeneBilderBlock").remove();
      }
  // Funktion zum Laden der Token-Tabelle
  async function ladeTokenTabelle() {
    try {
      const res = await fetch("/admin/tokens");
      const tokens = await res.json();
      const tbody = document.getElementById("tokenTabelleBody");
      tbody.innerHTML = "";
      tokens.forEach(t => {
        const row = document.createElement("tr");
        row.className = "border-b";
        // Token
        const tokenCell = document.createElement("td");
        tokenCell.className = "px-4 py-2 font-mono";
        tokenCell.textContent = t.token;
        // Rolle
        const rolleCell = document.createElement("td");
        rolleCell.className = "px-4 py-2";
        rolleCell.textContent = t.rolle;
        // Verwendet
        const verwendetCell = document.createElement("td");
        verwendetCell.className = "px-4 py-2";
        verwendetCell.textContent = t.verwendet ? "✅" : "❌";
        // Aktion
        const loeschBtn = document.createElement("button");
        loeschBtn.textContent = "Löschen";
        loeschBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
        loeschBtn.addEventListener("click", async () => {
          zeigePopup("Diesen Token wirklich löschen?", async () => {
            try {
              const res = await fetch(`/admin/token/${t.token}`, { method: "DELETE" });
              if (!res.ok) throw new Error(await res.text());
              zeigeBenachrichtigung("Token gelöscht.", "blue");
              ladeTokenTabelle();
            } catch (err) {
              console.error("Fehler beim Löschen des Tokens:", err);
              zeigeBenachrichtigung("Fehler beim Löschen des Tokens.", "red");
            }
          });
        });
        const aktionCell = document.createElement("td");
        aktionCell.className = "px-4 py-2";
        aktionCell.appendChild(loeschBtn);
        // Zeile zusammenbauen
        row.appendChild(tokenCell);
        row.appendChild(rolleCell);
        row.appendChild(verwendetCell);
        row.appendChild(aktionCell);
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error("Fehler beim Laden der Tokens:", err);
    }
  }
  // User-Tabelle laden und anzeigen
  // Modales Popup für Rollenbearbeitung
  function zeigeRollenPopup(username, aktuelleRolle, onConfirm) {
    const overlay = document.getElementById("rollePopupOverlay");
    const select = document.getElementById("rollePopupSelect");
    const confirmBtn = document.getElementById("rollePopupConfirm");
    const cancelBtn = document.getElementById("rollePopupCancel");

    select.value = aktuelleRolle;
    overlay.classList.remove("hidden");

    const confirmHandler = () => {
      const neueRolle = select.value;
      if (!neueRolle || neueRolle === aktuelleRolle) return;
      overlay.classList.add("hidden");
      onConfirm(neueRolle);
      confirmBtn.removeEventListener("click", confirmHandler);
    };

    confirmBtn.addEventListener("click", confirmHandler);
    cancelBtn.onclick = () => overlay.classList.add("hidden");
  }

      async function ladeBenutzerTabelle() {
        try {
          const res = await fetch("/admin/users");
          if (!res.ok) throw new Error(await res.text());
          const users = await res.json();
          const tbody = document.getElementById("userTabelleBody");
          tbody.innerHTML = "";
          users.forEach(user => {
            const tr = document.createElement("tr");
            tr.className = "border-b";
            // Benutzername
            const nameTd = document.createElement("td");
            nameTd.className = "px-4 py-2";
            nameTd.textContent = user.username;
            // Rolle
            const rolleTd = document.createElement("td");
            rolleTd.className = "px-4 py-2";
            rolleTd.textContent = user.rolle;
            // Aktionen
            const aktionTd = document.createElement("td");
            aktionTd.className = "px-4 py-2 space-x-2";
            // Rollen-Logik für Aktionen
            const rollenReihenfolge = { user: 0, helper: 1, mod: 2, admin: 3 };
            const eigeneStufe = rollenReihenfolge[benutzerRolle];
            const zielStufe = rollenReihenfolge[user.rolle];

            if (
              (benutzerRolle === "admin") ||
              (benutzerRolle === "mod" && zielStufe < eigeneStufe)
            ) {
              // Button Rolle bearbeiten
              const rolleBtn = document.createElement("button");
              rolleBtn.textContent = "Rolle bearbeiten";
              rolleBtn.className = "px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600";
              rolleBtn.addEventListener("click", () => {
                zeigeRollenPopup(user.username, user.rolle, async (neueRolle) => {
                  try {
                    const res = await fetch(`/admin/user/${encodeURIComponent(user.username)}/rolle`, {
                      method: "PATCH",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ rolle: neueRolle })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    zeigeBenachrichtigung("Rolle geändert.", "blue");
                    ladeBenutzerTabelle();
                  } catch (err) {
                    zeigeBenachrichtigung("Fehler beim Ändern der Rolle.", "red");
                  }
                });
              });
              aktionTd.appendChild(rolleBtn);

              // Button Löschen
              const loeschBtn = document.createElement("button");
              loeschBtn.textContent = "Löschen";
              loeschBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
              loeschBtn.addEventListener("click", () => {
                zeigePopup(`Benutzer ${user.username} wirklich löschen?`, async () => {
                  try {
                    const res = await fetch(`/admin/users/${encodeURIComponent(user.username)}`, { method: "DELETE" });
                    if (!res.ok) throw new Error(await res.text());
                    zeigeBenachrichtigung("Benutzer gelöscht.", "blue");
                    ladeBenutzerTabelle();
                  } catch (err) {
                    zeigeBenachrichtigung("Fehler beim Löschen des Benutzers.", "red");
                  }
                });
              });
              aktionTd.appendChild(loeschBtn);
            } else {
              aktionTd.textContent = "-";
            }

            tr.appendChild(nameTd);
            tr.appendChild(rolleTd);
            tr.appendChild(aktionTd);
            tbody.appendChild(tr);
          });
        } catch (err) {
          const tbody = document.getElementById("userTabelleBody");
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-2 text-gray-500">Fehler beim Laden der Benutzerliste.</td></tr>`;
          }
        }
      }

  // User-Tabelle beim Laden anzeigen, wenn Rolle mod oder admin
  if (["mod", "admin"].includes(benutzerRolle)) {
    ladeBenutzerTabelle();
  }
});
  </script>
  <div id="popupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p id="popupText" class="mb-4 text-sm text-gray-800">Bist du sicher?</p>
      <div class="flex justify-center gap-4">
        <button id="popupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="popupConfirm" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Ja, bestätigen</button>
      </div>
    </div>
  </div>
  <div id="typPopupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p class="mb-2 text-sm text-gray-800">Wähle einen neuen Typ aus:</p>
      <select id="typPopupSelect" class="w-full mb-4 px-3 py-2 border rounded text-sm focus:outline-none focus:ring">
        <option value="">-- Typ auswählen --</option>
      </select>
      <div class="flex justify-center gap-4">
        <button id="typPopupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="typPopupConfirm" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Typ ändern</button>
      </div>
    </div>
  </div>
  <div id="rollePopupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p class="mb-2 text-sm text-gray-800">Wähle eine neue Rolle:</p>
      <select id="rollePopupSelect" class="w-full mb-4 px-3 py-2 border rounded text-sm focus:outline-none focus:ring">
        <option value="">-- Rolle auswählen --</option>
        <option value="user">User</option>
        <option value="helper">Helper</option>
        <option value="mod">Mod</option>
        <option value="admin">Admin</option>
      </select>
      <div class="flex justify-center gap-4">
        <button id="rollePopupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="rollePopupConfirm" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Rolle ändern</button>
      </div>
    </div>
  </div>
  <div id="benachrichtigung" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded shadow hidden z-50 text-sm"></div>
  </body>
</html>