<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Einstellungen | Fisys</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/assets/css/tailwind.css" />
  </head>
  <style>
    .menu-highlight {
      transition: background-color 0.2s ease, transform 0.3s ease;
    }

    .highlight-bar {
      transition: all 0.3s ease;
      position: absolute;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: #0073ffaa; 
      border-radius: 2px;
    }

    .highlight-container {
      position: relative;
    }
  </style>
  <body class="min-h-screen flex bg-gray-800">
    <!-- Sidebar -->
    <aside class="w-64 bg-[#0f172a] text-white flex flex-col justify-between fixed h-full">
      <div>
        <div class="pt-1 pb-1">
          <img src="/static/assets/Fisys Logo.png" alt="Fisys Logo" class="h-20 mx-auto">
        </div>
        <nav class="px-4 space-y-2">
          <a href="/" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Dashboard</a>
          <a href="/spulen.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Spulen</a>
          <a href="/filamentseite.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Filamenttypen</a>
          <hr class="my-2 border-gray-700" />
          <a href="/status" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Status</a>
          <a href="/einstellungen.html" class="block px-4 py-2 rounded bg-gray-800 font-semibold text-white">Einstellungen</a>
        </nav>
      </div>
      <div class="mt-auto">
        <div class="px-4 pb-2" id="authBereich">
          <!-- Wird per JavaScript ersetzt durch Login- oder Logout-Button -->
        </div>
        <div class="p-4 text-xs text-center text-gray-400">© 2025 Fisys</div>
      </div>
    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col ml-64">
      <header class="bg-gray-800 px-10 py-10 relative">
        <h1 class="text-3xl text-white font-bold">Einstellungen</h1>
        <p class="text-sm text-gray-200 mt-1">Verwalte globale Optionen und Systemeinstellungen</p>
      </header>

      <section class="flex-1 pt-2 px-10 pb-10">
        <div class="flex flex-col xl:flex-row gap-8">
          <!-- Seitenmenü -->
          <aside class="w-full xl:w-1/4 bg-gray-700 border border-gray-600 rounded p-4 self-start">
            <nav id="einstellungsMenue" class="space-y-4 highlight-container">
              <div id="highlightBar" class="highlight-bar hidden"></div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Mein Profil</p>
                <button data-ziel="userSettingsBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Benutzereinstellungen</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Bildeinstellungen</p>
                <button data-ziel="bilderVerwaltung" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Bild hochladen</button>
                <button data-ziel="vorhandeneBilderBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Vorhandene Bilder</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Drucker</p>
                <button data-ziel="printerVerwaltungBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Drucker verwalten</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Tokens</p>
                <button data-ziel="tokenBlockContainer" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Token erstellen</button>
                <button data-ziel="tokenUebersichtBlockContainer" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Token Übersicht</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Integrationen</p>
                <button data-ziel="discordBotConfigBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Discord Bot</button>
                <button data-ziel="discordSubscriptionsBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Benachrichtigungen</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">User</p>
                <button data-ziel="userVerwaltungBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">User verwalten</button>
              </div>
              <div id="verbrauchNavBlock" class="hidden">
                <p class="text-sm font-semibold text-white mb-1">Filamentverbrauch</p>
                <button data-ziel="verbrauchVerwaltungBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Verbrauch verwalten</button>
              </div>
            </nav>
          </aside>

          <!-- Inhalt -->
          <div class="flex-1 space-y-10">
            <div id="userSettingsBlock" class="hidden bg-gray-700 p-6 rounded shadow max-w-3xl mt-10">
              <h2 class="text-xl text-white font-semibold mb-4">Benutzereinstellungen</h2>
              <form id="userSettingsForm" class="space-y-5 max-w-xl">
                <div>
                  <div class="flex items-center justify-between gap-2 mb-1">
                    <label for="userDiscordId" class="text-sm font-medium text-gray-200">Discord ID</label>
                    <button type="button" id="discordIdHelpButton" class="text-xs text-blue-300 hover:text-blue-200 hover:underline focus:outline-none focus:ring-2 focus:ring-blue-400/40 rounded px-1 py-0.5">Wo finde ich meine Discord ID?</button>
                  </div>
                  <input id="userDiscordId" name="discord_id" type="text" class="w-full px-3 py-2 rounded border border-gray-500 bg-gray-800 text-white focus:outline-none focus:ring focus:border-blue-500" placeholder="123456789012345678">
                  <p class="text-xs text-gray-400 mt-1">Gib deine Discord Benutzer-ID ein (nur Ziffern, keine @Mention).</p>
                </div>
                <div class="flex items-center gap-3">
                  <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-sm text-white rounded transition">Speichern</button>
                  <button type="button" id="userDiscordClear" class="px-4 py-2 text-sm text-gray-200 border border-gray-500 rounded hover:bg-gray-600 transition">Entfernen</button>
                </div>
                <p id="userSettingsFeedback" class="text-xs hidden"></p>
              </form>
            </div>
            <div id="discordBotConfigBlock" class="hidden bg-gray-700 p-6 rounded shadow max-w-3xl mt-10">
              <h2 class="text-xl text-white font-semibold mb-4">Discord Bot Einstellungen</h2>
              <form id="discordBotForm" class="space-y-5 max-w-2xl">
                <div class="flex items-center gap-3">
                  <input type="checkbox" id="discordBotEnabled" class="h-4 w-4">
                  <label for="discordBotEnabled" class="text-sm text-gray-200">Benachrichtigungen über Discord aktivieren</label>
                </div>
                <div class="flex items-start gap-3">
                  <input type="checkbox" id="discordBotUseDm" class="mt-1 h-4 w-4">
                  <label for="discordBotUseDm" class="text-sm text-gray-200 leading-relaxed">Direktnachricht an Nutzer senden (erfordert Bot Token und erlaubte DMs)</label>
                </div>
                <div>
                  <label for="discordWebhookUrl" class="block text-sm font-medium text-gray-200 mb-1">Webhook URL</label>
                  <input id="discordWebhookUrl" type="url" class="w-full px-3 py-2 rounded border border-gray-500 bg-gray-800 text-white focus:outline-none focus:ring focus:border-blue-500" placeholder="https://discord.com/api/webhooks/...">
                  <p class="text-xs text-gray-400 mt-1">Optional: Wenn gesetzt, wird der Bot über diesen Webhook benachrichtigen.</p>
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                  <div>
                    <label for="discordBotToken" class="block text-sm font-medium text-gray-200 mb-1">Bot Token</label>
                    <input id="discordBotToken" type="text" class="w-full px-3 py-2 rounded border border-gray-500 bg-gray-800 text-white focus:outline-none focus:ring focus:border-blue-500" placeholder="Bot Token">
                  </div>
                  <div>
                    <label for="discordChannelId" class="block text-sm font-medium text-gray-200 mb-1">Channel ID</label>
                    <input id="discordChannelId" type="text" class="w-full px-3 py-2 rounded border border-gray-500 bg-gray-800 text-white focus:outline-none focus:ring focus:border-blue-500" placeholder="123456789012345678">
                  </div>
                </div>
                <div>
                  <label for="discordMessageTemplate" class="block text-sm font-medium text-gray-200 mb-1">Nachrichtenvorlage</label>
                  <textarea id="discordMessageTemplate" rows="4" class="w-full px-3 py-2 rounded border border-gray-500 bg-gray-800 text-white focus:outline-none focus:ring focus:border-blue-500" placeholder="Hey {username}, dein Druckauftrag {job_name} auf {printer_name} ist fertig!"></textarea>
                  <p class="text-xs text-gray-400 mt-1">Verfügbare Platzhalter: {username}, {printer_name}, {printer_serial}, {job_name}, {status}, {discord_id}, {discord_mention}. Für Fehlschläge zusätzlich: {failure_reason}</p>
                </div>
                <div>
                  <label for="discordFailureTemplate" class="block text-sm font-medium text-gray-200 mb-1">Nachrichtenvorlage (Fehlschlag)</label>
                  <textarea id="discordFailureTemplate" rows="4" class="w-full px-3 py-2 rounded border border-gray-500 bg-gray-800 text-white focus:outline-none focus:ring focus:border-blue-500" placeholder="Hey {username}, dein Druckauftrag {job_name} auf {printer_name} ist fehlgeschlagen: {failure_reason}"></textarea>
                  <p class="text-xs text-gray-400 mt-1">Nutze diese Vorlage für fehlgeschlagene Drucke. Verfügbare Platzhalter wie oben; {failure_reason} beschreibt den Fehler.</p>
                </div>
                <div class="flex items-center gap-3">
                  <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-sm text-white rounded transition">Speichern</button>
                  <button type="button" id="discordBotReload" class="px-4 py-2 text-sm text-gray-200 border border-gray-500 rounded hover:bg-gray-600 transition">Neu laden</button>
                </div>
                <p id="discordBotFeedback" class="text-xs hidden"></p>
              </form>
            </div>
            <div id="discordSubscriptionsBlock" class="hidden bg-gray-700 p-6 rounded shadow max-w-4xl mt-10">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                <div>
                  <h2 class="text-xl text-white font-semibold">Discord-Benachrichtigungen</h2>
                  <p class="text-sm text-gray-300">Bestehende Abonnements einsehen und entfernen.</p>
                </div>
                <div class="flex items-center gap-2">
                  <select id="discordSubscriptionsFilter" class="px-3 py-2 text-sm bg-gray-800 border border-gray-600 rounded text-gray-200">
                    <option value="">Alle Status</option>
                    <option value="pending">Ausstehend</option>
                    <option value="sent">Gesendet</option>
                    <option value="failed">Fehlgeschlagen</option>
                    <option value="skipped">Übersprungen</option>
                  </select>
                  <button id="discordSubscriptionsReload" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 text-sm">Aktualisieren</button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left text-gray-200 border border-gray-600">
                  <thead class="bg-gray-600 border-b border-gray-500 text-xs uppercase tracking-wide text-gray-200">
                    <tr>
                      <th class="px-3 py-2">User</th>
                      <th class="px-3 py-2">Discord ID</th>
                      <th class="px-3 py-2">Drucker</th>
                      <th class="px-3 py-2">Job</th>
                      <th class="px-3 py-2">Status</th>
                      <th class="px-3 py-2">Erstellt</th>
                      <th class="px-3 py-2">Gesendet</th>
                      <th class="px-3 py-2">Fehler</th>
                      <th class="px-3 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="discordSubscriptionsBody">
                    <tr>
                      <td colspan="9" class="px-4 py-6 text-center text-gray-400">Keine Daten geladen</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Drucker verwalten -->
            <div id="printerVerwaltungBlock" class="hidden bg-gray-700 p-6 rounded shadow max-w-3xl mt-10">
              <h2 class="text-xl text-white font-semibold mb-4">Drucker</h2>
              <form id="printerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">Name</label>
                  <input type="text" id="pr-name" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="Mein Drucker" required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">IP</label>
                  <input type="text" id="pr-ip" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="192.168.1.10" required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">Serial</label>
                  <input type="text" id="pr-serial" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="X1C123..." required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">Access-Token</label>
                  <input type="text" id="pr-access" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="Access Token" required />
                </div>
                <div class="md:col-span-2 flex items-center gap-3 mt-2">
                  <input type="checkbox" id="pr-show" class="h-4 w-4" checked />
                  <label for="pr-show" class="text-sm text-gray-100">Auf Dashboard anzeigen</label>
                </div>
                <div class="md:col-span-2 mt-2">
                  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">Speichern</button>
                </div>
              </form>
              <div>
                <h3 class="text-sm font-medium text-white mb-2">Gespeicherte Drucker</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-sm text-gray-100 text-left border">
                    <thead class="bg-gray-600 border-b">
                      <tr>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">IP</th>
                        <th class="px-4 py-2">Serial</th>
                        <th class="px-4 py-2">Auf Dashboard</th>
                        <th class="px-4 py-2">Aktionen</th>
                      </tr>
                    </thead>
                    <tbody id="printerTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <!-- Filamentbild hochladen -->
            <div id="bilderVerwaltung" class="hidden bg-gray-700 p-6 rounded shadow max-w-xl mt-10">
              <h2 class="text-xl text-white font-semibold mb-4">Filamentbild hochladen</h2>
              <form id="uploadForm" class="space-y-3">
                <div>
                  <label for="bild" class="block text-sm font-medium text-gray-100 mb-1">Bild auswählen</label>
                  <input type="file" id="bild" name="file" accept="image/*" class="block w-full text-sm text-gray-200 border border-gray-400 rounded px-3 py-2">
                </div>
                <div id="bildVorschauContainer" class="mt-1 hidden">
                  <p class="text-sm font-medium text-gray-100 mb-1">Vorschau:</p>
                  <img id="bildVorschau" src="" alt="Bildvorschau" class="h-24 rounded border">
                </div>
                <div>
                  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">Bild hochladen</button>
                </div>
              </form>
            </div>

            <!-- Token erstellen -->
            <div id="tokenBlockContainer" class="hidden"></div>

            <!-- Vorhandene Bilder -->
            <div id="vorhandeneBilderBlock" class="hidden bg-gray-700 p-6 rounded shadow">
              <h2 class="text-xl text-white font-semibold mb-4">Vorhandene Bilder verwalten</h2>
              <div class="overflow-x-auto">
                <table class="min-w-full text-gray-200 text-sm text-left border border-gray-400">
                  <thead class="bg-gray-600 border-b">
                    <tr>
                      <th class="px-4 py-2">Bild</th>
                      <th class="px-4 py-2">Zugewiesener Typ</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="bildVerwaltungTabelle"></tbody>
                </table>
              </div>
            </div>

            <!-- Token-Tabelle -->
            <div id="tokenUebersichtBlockContainer" class="hidden"></div>

            <!-- User-Verwaltung -->
            <div id="userVerwaltungBlock" class="hidden bg-gray-700 p-6 rounded shadow">
              <h2 class="text-xl text-white font-semibold mb-4">User verwalten</h2>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-gray-100 text-left border">
                  <thead class="bg-gray-600 border-b">
                    <tr>
                      <th class="px-4 py-2">Benutzername</th>
                      <th class="px-4 py-2">Rolle</th>
                      <th class="px-4 py-2">Erstellt am</th>
                      <th class="px-4 py-2">Zuletzt aktiv</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="userTabelleBody"></tbody>
                </table>
              </div>
            </div>

            <!-- Verbrauch verwalten -->
            <div id="verbrauchVerwaltungBlock" class="hidden bg-gray-700 p-6 rounded shadow">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                <div>
                  <h2 class="text-xl text-white font-semibold">Filamentverbrauch verwalten</h2>
                  <p class="text-sm text-gray-300">Entferne Testeinträge und passe fehlerhafte Werte an.</p>
                </div>
                <button id="verbrauchNeuLaden" class="self-start md:self-center bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500 text-sm">Aktualisieren</button>
              </div>
              <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 mb-6">
                <div class="bg-gray-800 p-4 rounded border border-gray-600">
                  <p class="text-xs uppercase text-gray-400 tracking-wide">Gesamtverbrauch</p>
                  <p id="verbrauchSum" class="text-lg font-semibold text-white mt-1">–</p>
                </div>
                <div class="bg-gray-800 p-4 rounded border border-gray-600">
                  <p class="text-xs uppercase text-gray-400 tracking-wide">Einträge im Log</p>
                  <p id="verbrauchCount" class="text-lg font-semibold text-white mt-1">–</p>
                </div>
                <div class="bg-gray-800 p-4 rounded border border-gray-600">
                  <p class="text-xs uppercase text-gray-400 tracking-wide">Hinweis</p>
                  <p class="text-sm text-gray-300 mt-1">Änderungen wirken sich direkt auf alle Statistiken aus.</p>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-gray-100 text-left border">
                  <thead class="bg-gray-600 border-b">
                    <tr>
                      <th class="px-4 py-2">Datum</th>
                      <th class="px-4 py-2">Eintrag</th>
                      <th class="px-4 py-2">Verbrauch</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="verbrauchTabelleBody">
                    <tr>
                      <td colspan="4" class="px-4 py-6 text-center text-gray-400">Noch keine Daten geladen</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div id="discordIdHelpModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/70 px-4" role="dialog" aria-modal="true" aria-labelledby="discordIdHelpTitle" tabindex="-1" aria-hidden="true">
      <div class="relative w-full max-w-xl rounded-lg bg-gray-900 p-6 text-gray-200 shadow-2xl">
        <button type="button" id="discordIdHelpClose" class="absolute right-3 top-3 text-gray-400 hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400/40 rounded" aria-label="Hilfe schließen">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <h3 id="discordIdHelpTitle" class="text-lg font-semibold text-white">So findest du deine Discord-ID</h3>
        <p class="mt-3 text-sm text-gray-300">Aktiviere zuerst den Entwicklermodus, damit du IDs kopieren kannst.</p>
        <div class="mt-4 space-y-4">
          <div>
            <p class="text-sm font-semibold text-white">Desktop</p>
            <ol class="mt-2 list-decimal list-inside space-y-1 text-sm text-gray-300">
              <li>Klicke unten links auf das Zahnrad <span class="text-gray-100">„Benutzer-Einstellungen“</span>.</li>
              <li>Öffne den Abschnitt <span class="text-gray-100">„Erweitert“</span> und aktiviere <span class="text-gray-100">„Entwicklermodus“</span>.</li>
              <li>Rechtsklicke anschließend auf deinen Namen oder Avatar und wähle <span class="text-gray-100">„ID kopieren“</span>.</li>
            </ol>
          </div>
          <div>
            <p class="text-sm font-semibold text-white">Mobil</p>
            <ol class="mt-2 list-decimal list-inside space-y-1 text-sm text-gray-300">
              <li>Öffne dein Profil, tippe auf <span class="text-gray-100">„Erscheinungsbild &amp; App-Verhalten“</span> und aktiviere den <span class="text-gray-100">„Entwicklermodus“</span>.</li>
              <li>Gehe zu deinem Profil oder einem Chat, tippe auf die drei Punkte neben deinem Namen.</li>
              <li>Wähle <span class="text-gray-100">„ID kopieren“</span>.</li>
            </ol>
          </div>
        </div>
        <p class="mt-4 text-xs text-gray-400">Die kopierte Zahl kannst du hier in das Feld „Discord ID“ einfügen.</p>
      </div>
    </div>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
      const highlightBar = document.getElementById("highlightBar");
      const settingsMenu = document.getElementById("einstellungsMenue");
      if (settingsMenu) {
        settingsMenu.style.visibility = "hidden";
      }
      const ALL_SECTION_IDS = [
        "userSettingsBlock",
        "bilderVerwaltung",
        "vorhandeneBilderBlock",
        "printerVerwaltungBlock",
        "tokenBlockContainer",
        "tokenUebersichtBlockContainer",
        "discordBotConfigBlock",
        "discordSubscriptionsBlock",
        "userVerwaltungBlock",
        "verbrauchVerwaltungBlock"
      ];
      let availableSectionIds = [...ALL_SECTION_IDS];
      let autoActivatedInitialSection = false;
      let discordSubscriptionsLoaded = false;

      const userSettingsForm = document.getElementById("userSettingsForm");
      const userDiscordInput = document.getElementById("userDiscordId");
      const userDiscordClearBtn = document.getElementById("userDiscordClear");
      const userSettingsFeedback = document.getElementById("userSettingsFeedback");
      const discordIdHelpButton = document.getElementById("discordIdHelpButton");
      const discordIdHelpModal = document.getElementById("discordIdHelpModal");
      const discordIdHelpClose = document.getElementById("discordIdHelpClose");
      const discordBotForm = document.getElementById("discordBotForm");
      const discordBotEnabledInput = document.getElementById("discordBotEnabled");
      const discordBotUseDmInput = document.getElementById("discordBotUseDm");
      const discordWebhookInput = document.getElementById("discordWebhookUrl");
      const discordBotTokenInput = document.getElementById("discordBotToken");
      const discordChannelIdInput = document.getElementById("discordChannelId");
      const discordMessageTemplateInput = document.getElementById("discordMessageTemplate");
      const discordFailureTemplateInput = document.getElementById("discordFailureTemplate");
      const discordBotFeedback = document.getElementById("discordBotFeedback");
      const discordBotReloadBtn = document.getElementById("discordBotReload");
      const discordSubscriptionsBlockEl = document.getElementById("discordSubscriptionsBlock");
      const discordSubscriptionsBody = document.getElementById("discordSubscriptionsBody");
      const discordSubscriptionsReloadBtn = document.getElementById("discordSubscriptionsReload");
      const discordSubscriptionsFilter = document.getElementById("discordSubscriptionsFilter");
      let lastFocusedBeforeDiscordHelp = null;

      const navigationPermissions = {
        userSettingsBlock: ["user", "helper", "mod", "admin"],
        bilderVerwaltung: ["helper", "mod", "admin"],
        vorhandeneBilderBlock: ["helper", "mod", "admin"],
        printerVerwaltungBlock: ["helper", "mod", "admin"],
        tokenBlockContainer: ["mod", "admin"],
        tokenUebersichtBlockContainer: ["mod", "admin"],
        discordBotConfigBlock: ["admin"],
        discordSubscriptionsBlock: ["mod", "admin"],
        userVerwaltungBlock: ["mod", "admin"],
        verbrauchVerwaltungBlock: ["mod", "admin"]
      };

      const normalizeRole = (role) => (typeof role === "string" ? role.toLowerCase().trim() : "");

      const removeAvailableSection = (id) => {
        const idx = availableSectionIds.indexOf(id);
        if (idx !== -1) {
          availableSectionIds.splice(idx, 1);
        }
      };

      const hideAllSections = () => {
        availableSectionIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });
      };

      const activateFirstAvailableSection = () => {
        if (autoActivatedInitialSection) return;
        const firstButton = settingsMenu?.querySelector("button");
        if (firstButton) {
          autoActivatedInitialSection = true;
          firstButton.click();
        }
      };

      const filterSettingsMenuForRole = (role) => {
        const normalizedRole = normalizeRole(role);
        Object.entries(navigationPermissions).forEach(([sectionId, allowedRoles]) => {
          if (!allowedRoles.includes(normalizedRole)) {
            if (settingsMenu) {
              const button = settingsMenu.querySelector(`button[data-ziel="${sectionId}"]`);
              if (button) {
                const parentSection = button.closest("div");
                button.remove();
                if (parentSection && parentSection.querySelectorAll("button").length === 0) {
                  parentSection.remove();
                }
              }
            }
            const area = document.getElementById(sectionId);
            if (area) {
              area.remove();
            }
            removeAvailableSection(sectionId);
          }
        });
        if (settingsMenu) {
          settingsMenu.style.visibility = "visible";
          if (highlightBar && settingsMenu.querySelectorAll("button").length === 0) {
            highlightBar.classList.add("hidden");
          }
        }
      };

      if (settingsMenu) {
        settingsMenu.addEventListener("click", (e) => {
          const ziel = e.target?.dataset?.ziel;
          if (!ziel || !e.target.matches("button")) return;

          settingsMenu.querySelectorAll("button").forEach((btn) => {
            btn.classList.remove("bg-gray-600", "menu-highlight");
          });
          e.target.classList.add("bg-gray-600", "menu-highlight");

          const offsetTop = e.target.offsetTop;
          if (highlightBar) {
            highlightBar.style.top = offsetTop + "px";
            highlightBar.style.height = e.target.offsetHeight + "px";
            highlightBar.classList.remove("hidden");
          }

          hideAllSections();

          const zielElement = document.getElementById(ziel);
          if (zielElement) {
            zielElement.classList.remove("hidden");
            if (ziel === "discordSubscriptionsBlock") {
              if (!discordSubscriptionsLoaded) {
                discordSubscriptionsLoaded = true;
                loadDiscordSubscriptions({ showStatus: true });
              }
            }
          }
        });
      }

      hideAllSections();
      let benutzerRolle = null;
      const tokenBlock = document.createElement("div");
      tokenBlock.className = "bg-gray-700 p-6 rounded shadow max-w-xl mt-10";
      tokenBlock.innerHTML = `
        <h2 class="text-xl text-white font-semibold mb-4">Registrierungstoken erstellen</h2>
        <p class="text-sm text-gray-300 mb-4">Erzeuge einmalige Tokens, um neuen Accounts gezielt Rechte zu geben.</p>
        <div class="mb-6 bg-gray-800/60 border border-gray-600 rounded-lg p-4">
          <h3 class="text-sm font-semibold text-white uppercase tracking-wide mb-3">Rollen & Berechtigungen</h3>
          <dl class="space-y-3 text-sm text-gray-200">
            <div>
              <dt class="font-semibold text-white">User</dt>
              <dd class="mt-1 text-gray-300">Kann Daten einsehen und die eigenen Einstellungen (zum Beispiel die Discord-ID) pflegen, hat aber keine Schreibrechte.</dd>
            </div>
            <div>
              <dt class="font-semibold text-white">Helper</dt>
              <dd class="mt-1 text-gray-300">Darf Spulen anlegen und aktualisieren, neue Filamenttypen hinzufügen sowie Bilder und Druckerkonfigurationen verwalten.</dd>
            </div>
            <div>
              <dt class="font-semibold text-white">Mod</dt>
              <dd class="mt-1 text-gray-300">Besitzt alle Helper-Rechte, kann Filamenttypen bearbeiten oder löschen, Verbrauchsdaten korrigieren, Benutzer verwalten (Rollen bis Helper anpassen) und Tokens für User oder Helper erzeugen.</dd>
            </div>
            <div>
              <dt class="font-semibold text-white">Admin</dt>
              <dd class="mt-1 text-gray-300">Hat Vollzugriff: alle Mod-Aufgaben, Tokens für jede Rolle, die Discord-Bot-Konfiguration und das Anpassen beliebiger Benutzerrollen.</dd>
            </div>
          </dl>
        </div>
        <form id="tokenForm" class="space-y-4">
          <div>
            <label for="rolle" class="block text-sm font-medium text-gray-200 mb-1">Rolle auswählen</label>
            <select id="rolle" name="rolle" required class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2">
              <option value="">-- auswählen --</option>
              <option value="user">User</option>
              <option value="helper">Helper</option>
              <option value="mod">Mod</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div>
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">Token generieren</button>
          </div>
        </form>
        <div id="tokenAnzeige" class="mt-4 hidden">
          <p class="text-sm text-gray-700">Token:</p>
          <code id="generierterToken" class="block text-center mt-1 text-lg font-mono text-blue-600 bg-blue-200 p-2 rounded">________</code>
        </div>
      `;
      // Token-Übersicht-Block erstellen
      const tokenUebersichtBlock = document.createElement("div");
      tokenUebersichtBlock.className = "bg-gray-700 p-6 rounded shadow max-w-xl mt-6";
      tokenUebersichtBlock.innerHTML = `
        <h2 class="text-xl font-semibold text-white mb-4">Alle Tokens</h2>
        <div id="tokenTabelleWrapper" class="overflow-x-auto">
          <table class="min-w-full text-sm text-gray-100 text-left border">
            <thead class="bg-gray-600 border-b">
              <tr>
                <th class="px-4 py-2">Token</th>
                <th class="px-4 py-2">Rolle</th>
                <th class="px-4 py-2">Verwendet</th>
                <th class="px-4 py-2">Aktion</th>
              </tr>
            </thead>
            <tbody id="tokenTabelleBody"></tbody>
          </table>
        </div>
      `;
      const authBereich = document.getElementById("authBereich");
      try {
        const res = await fetch("/api/userinfo");
        if (!res.ok) throw new Error("Nicht eingeloggt");
        const daten = await res.json();
        benutzerRolle = daten.rolle;
        filterSettingsMenuForRole(benutzerRolle);
        hideAllSections();
        activateFirstAvailableSection();
        if (userDiscordInput) {
          userDiscordInput.value = daten.discord_id || '';
        }
        showUserSettingsMessage('', 'info');
        // Auth-Bereich dynamisch anpassen (Login/Logout, Benutzername)
        authBereich.innerHTML = `
          <form id="logoutForm" class="flex flex-col items-center">
            <span class="text-sm text-gray-300 mb-1">Angemeldet als ${daten.username}</span>
            <button type="submit" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition w-full">Logout</button>
          </form>
        `;
        document.getElementById("logoutForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const res = await fetch("/logout", { method: "POST" });
            if (res.ok) {
              window.location.href = "/login";
            }
          } catch (err) {
            console.error("Logout fehlgeschlagen", err);
          }
        });
      } catch (err) {
        console.warn("Nicht eingeloggt – Weiterleitung zur Login-Seite");
        window.location.href = "/login";
        return;
      }

      const tableBody = document.getElementById("bildVerwaltungTabelle");

      function zeigeBenachrichtigung(text, farbe = "blue") {
        const box = document.getElementById("benachrichtigung");
        box.textContent = text;
        box.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-${farbe}-600 text-white px-4 py-2 rounded shadow z-50 text-sm`;
        box.classList.remove("hidden");
        setTimeout(() => box.classList.add("hidden"), 3000);
      }

      function showUserSettingsMessage(message, tone = 'info') {
        if (!userSettingsFeedback) return;
        if (!message) {
          userSettingsFeedback.classList.add('hidden');
          userSettingsFeedback.textContent = '';
          return;
        }
        userSettingsFeedback.textContent = message;
        userSettingsFeedback.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-gray-300');
        let toneClass = 'text-gray-300';
        if (tone === 'success') toneClass = 'text-green-400';
        if (tone === 'error') toneClass = 'text-red-400';
        userSettingsFeedback.classList.add(toneClass);
      }

      function setUserSettingsLoading(isLoading) {
        if (!userSettingsForm) return;
        userSettingsForm.classList.toggle('opacity-60', isLoading);
        userSettingsForm.querySelectorAll('button, input').forEach(element => {
          element.disabled = isLoading;
        });
      }

      const setDiscordIdHelpVisibility = (shouldShow) => {
        if (!discordIdHelpModal) return;
        const body = document.body;
        const display = Boolean(shouldShow);
        if (display) {
          if (document.activeElement instanceof HTMLElement) {
            lastFocusedBeforeDiscordHelp = document.activeElement;
          }
          discordIdHelpModal.classList.remove('hidden');
          discordIdHelpModal.setAttribute('aria-hidden', 'false');
          if (body) body.classList.add('overflow-hidden');
          const focusTarget = discordIdHelpModal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          if (focusTarget instanceof HTMLElement) {
            focusTarget.focus({ preventScroll: true });
          } else {
            discordIdHelpModal.focus({ preventScroll: true });
          }
        } else {
          discordIdHelpModal.classList.add('hidden');
          discordIdHelpModal.setAttribute('aria-hidden', 'true');
          if (body) body.classList.remove('overflow-hidden');
          const fallbackTarget = lastFocusedBeforeDiscordHelp instanceof HTMLElement ? lastFocusedBeforeDiscordHelp : discordIdHelpButton;
          if (fallbackTarget instanceof HTMLElement) {
            fallbackTarget.focus({ preventScroll: true });
          }
          lastFocusedBeforeDiscordHelp = null;
        }
      };

      const closeDiscordIdHelp = () => setDiscordIdHelpVisibility(false);

      if (discordIdHelpButton && discordIdHelpModal) {
        discordIdHelpButton.addEventListener('click', () => setDiscordIdHelpVisibility(true));
      }

      if (discordIdHelpClose) {
        discordIdHelpClose.addEventListener('click', closeDiscordIdHelp);
      }

      if (discordIdHelpModal) {
        discordIdHelpModal.addEventListener('click', (event) => {
          if (event.target === discordIdHelpModal) {
            closeDiscordIdHelp();
          }
        });
      }

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && discordIdHelpModal && !discordIdHelpModal.classList.contains('hidden')) {
          closeDiscordIdHelp();
        }
      });

      async function persistUserDiscord(value) {
        if (!userSettingsForm) return false;
        setUserSettingsLoading(true);
        try {
          const trimmed = value && value.trim() ? value.trim() : '';
          if (trimmed && !/^\d+$/.test(trimmed)) {
            showUserSettingsMessage('Die Discord-ID darf nur aus Ziffern bestehen.', 'error');
            return false;
          }
          const payload = { discord_id: trimmed || null };
          const res = await fetch('/api/me/settings', {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(() => ({}));
          if (res.status === 401) {
            window.location.href = '/login';
            return false;
          }
          if (!res.ok) {
            showUserSettingsMessage(data?.detail || 'Speichern fehlgeschlagen.', 'error');
            return false;
          }
          const storedId = data?.discord_id || null;
          if (userDiscordInput) {
            userDiscordInput.value = storedId || '';
          }
          showUserSettingsMessage(storedId ? 'Discord-ID gespeichert.' : 'Discord-ID entfernt.', 'success');
          return true;
        } catch (error) {
          console.error('Discord-ID konnte nicht gespeichert werden:', error);
          showUserSettingsMessage('Es ist ein Fehler aufgetreten. Bitte versuche es erneut.', 'error');
          return false;
        } finally {
          setUserSettingsLoading(false);
        }
      }

      function formatDateTimeShort(value) {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '—';
        return date.toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' });
      }

      async function loadDiscordSubscriptions({ showStatus = false } = {}) {
        if (!discordSubscriptionsBody) return;
        if (showStatus && discordSubscriptionsBlockEl) {
          discordSubscriptionsBlockEl.classList.add('opacity-60');
        }
        const selectedStatus = discordSubscriptionsFilter ? discordSubscriptionsFilter.value : '';
        const query = selectedStatus ? `?status=${encodeURIComponent(selectedStatus)}` : '';
        try {
          const res = await fetch(`/api/discord/subscriptions${query}`, { credentials: 'same-origin' });
          if (res.status === 401) {
            window.location.href = '/login';
            return;
          }
          if (res.status === 403) {
            discordSubscriptionsBody.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-center text-red-400">Keine Berechtigung.</td></tr>';
            return;
          }
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          const items = Array.isArray(data?.items) ? data.items : [];
          if (!items.length) {
            discordSubscriptionsBody.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-center text-gray-400">Keine Abonnements vorhanden.</td></tr>';
            return;
          }
          discordSubscriptionsBody.innerHTML = items.map(sub => {
            const user = sub.user || {};
            const statusLabel = (sub.status || '').toUpperCase();
            const errorText = sub.last_error ? sub.last_error : '—';
            const jobName = sub.job_name || '—';
            return `
              <tr class="border-b border-gray-700">
                <td class="px-3 py-2 whitespace-nowrap">${user.username || '—'}</td>
                <td class="px-3 py-2 whitespace-nowrap">${user.discord_id || '—'}</td>
                <td class="px-3 py-2">${sub.printer_serial || '—'}</td>
                <td class="px-3 py-2">${jobName}</td>
                <td class="px-3 py-2 whitespace-nowrap">${statusLabel}</td>
                <td class="px-3 py-2 whitespace-nowrap">${formatDateTimeShort(sub.created_at)}</td>
                <td class="px-3 py-2 whitespace-nowrap">${formatDateTimeShort(sub.notified_at)}</td>
                <td class="px-3 py-2">${errorText}</td>
                <td class="px-3 py-2 whitespace-nowrap">
                  <button data-subscription-id="${sub.id}" class="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-xs">Entfernen</button>
                </td>
              </tr>`;
          }).join('');
          discordSubscriptionsLoaded = true;
        } catch (error) {
          console.error('Benachrichtigungen konnten nicht geladen werden:', error);
          discordSubscriptionsBody.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-center text-red-400">Fehler beim Laden der Liste.</td></tr>';
        } finally {
          if (showStatus && discordSubscriptionsBlockEl) {
            discordSubscriptionsBlockEl.classList.remove('opacity-60');
          }
        }
      }

      async function removeDiscordSubscription(id) {
        try {
          const res = await fetch(`/api/discord/subscriptions/${id}`, { method: 'DELETE', credentials: 'same-origin' });
          if (res.status === 401) {
            window.location.href = '/login';
            return;
          }
          if (res.status === 403) {
            zeigeBenachrichtigung('Keine Berechtigung zum Entfernen.', 'red');
            return;
          }
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || 'Entfernen fehlgeschlagen');
          }
          await loadDiscordSubscriptions();
          zeigeBenachrichtigung('Abonnement entfernt.', 'blue');
        } catch (error) {
          console.error('Entfernen fehlgeschlagen:', error);
          zeigeBenachrichtigung('Entfernen fehlgeschlagen.', 'red');
        }
      }

      function showDiscordBotFeedback(message, tone = 'info') {
        if (!discordBotFeedback) return;
        if (!message) {
          discordBotFeedback.classList.add('hidden');
          discordBotFeedback.textContent = '';
          return;
        }
        discordBotFeedback.textContent = message;
        discordBotFeedback.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-gray-300');
        let toneClass = 'text-gray-300';
        if (tone === 'success') toneClass = 'text-green-400';
        if (tone === 'error') toneClass = 'text-red-400';
        discordBotFeedback.classList.add(toneClass);
      }

      function setDiscordBotFormLoading(isLoading) {
        if (!discordBotForm) return;
        discordBotForm.classList.toggle('opacity-60', isLoading);
        discordBotForm.querySelectorAll('button, input, textarea').forEach(element => {
          element.disabled = isLoading;
        });
      }

      function updateDiscordBotFieldState() {
        const useDm = discordBotUseDmInput ? !!discordBotUseDmInput.checked : false;
        if (discordWebhookInput) {
          discordWebhookInput.disabled = useDm;
          discordWebhookInput.classList.toggle('opacity-50', useDm);
        }
        if (discordChannelIdInput) {
          discordChannelIdInput.disabled = useDm;
          discordChannelIdInput.classList.toggle('opacity-50', useDm);
        }
      }

      async function loadDiscordBotConfig({ showStatus = false } = {}) {
        if (!discordBotForm) return;
        setDiscordBotFormLoading(true);
        if (showStatus) {
          showDiscordBotFeedback('Lade Einstellungen …', 'info');
        } else {
          showDiscordBotFeedback('', 'info');
        }
        try {
          const res = await fetch('/api/discord/config', { credentials: 'same-origin' });
          if (res.status === 401) {
            window.location.href = '/login';
            return;
          }
          if (res.status === 403) {
            showDiscordBotFeedback('Keine Berechtigung für Discord-Einstellungen.', 'error');
            return;
          }
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          const data = await res.json();
          if (discordBotEnabledInput) discordBotEnabledInput.checked = !!data.enabled;
          if (discordBotUseDmInput) discordBotUseDmInput.checked = !!data.use_dm;
          if (discordWebhookInput) discordWebhookInput.value = data.webhook_url || '';
          if (discordBotTokenInput) discordBotTokenInput.value = data.bot_token || '';
          if (discordChannelIdInput) discordChannelIdInput.value = data.channel_id || '';
          if (discordMessageTemplateInput) discordMessageTemplateInput.value = data.message_template || '';
          if (discordFailureTemplateInput) discordFailureTemplateInput.value = data.failure_message_template || '';
          updateDiscordBotFieldState();
          if (showStatus) {
            showDiscordBotFeedback('Einstellungen geladen.', 'success');
          } else {
            showDiscordBotFeedback('', 'info');
          }
        } catch (error) {
          console.error('Discord-Konfiguration konnte nicht geladen werden:', error);
          showDiscordBotFeedback('Fehler beim Laden der Discord-Konfiguration.', 'error');
        } finally {
          setDiscordBotFormLoading(false);
          updateDiscordBotFieldState();
        }
      }

      async function submitDiscordBotConfig(event) {
        event.preventDefault();
        if (!discordBotForm) return;
        setDiscordBotFormLoading(true);
        showDiscordBotFeedback('Speichere …', 'info');
        try {
          const payload = {
            enabled: discordBotEnabledInput ? !!discordBotEnabledInput.checked : false,
            use_dm: discordBotUseDmInput ? !!discordBotUseDmInput.checked : false,
            webhook_url: discordWebhookInput && discordWebhookInput.value ? discordWebhookInput.value.trim() : null,
            bot_token: discordBotTokenInput && discordBotTokenInput.value ? discordBotTokenInput.value.trim() : null,
            channel_id: discordChannelIdInput && discordChannelIdInput.value ? discordChannelIdInput.value.trim() : null,
            message_template: discordMessageTemplateInput ? discordMessageTemplateInput.value : '',
            failure_message_template: discordFailureTemplateInput ? discordFailureTemplateInput.value : ''
          };
          if (payload.use_dm) {
            payload.webhook_url = null;
            payload.channel_id = null;
          }
          const res = await fetch('/api/discord/config', {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(() => ({}));
          if (res.status === 401) {
            window.location.href = '/login';
            return;
          }
          if (res.status === 403) {
            showDiscordBotFeedback('Keine Berechtigung für Discord-Einstellungen.', 'error');
            return;
          }
          if (!res.ok) {
            showDiscordBotFeedback(data?.detail || 'Speichern fehlgeschlagen.', 'error');
            return;
          }
          if (discordBotEnabledInput) discordBotEnabledInput.checked = !!data.enabled;
          if (discordWebhookInput) discordWebhookInput.value = data.webhook_url || '';
          if (discordBotTokenInput) discordBotTokenInput.value = data.bot_token || '';
          if (discordChannelIdInput) discordChannelIdInput.value = data.channel_id || '';
          if (discordMessageTemplateInput) discordMessageTemplateInput.value = data.message_template || '';
          if (discordFailureTemplateInput) discordFailureTemplateInput.value = data.failure_message_template || '';
          if (discordBotUseDmInput) discordBotUseDmInput.checked = !!data.use_dm;
          updateDiscordBotFieldState();
          showDiscordBotFeedback('Einstellungen gespeichert.', 'success');
        } catch (error) {
          console.error('Discord-Konfiguration konnte nicht gespeichert werden:', error);
          showDiscordBotFeedback('Es ist ein Fehler aufgetreten. Bitte versuche es erneut.', 'error');
        } finally {
          setDiscordBotFormLoading(false);
        }
      }

      async function ladeBilder() {
        try {
          const response = await fetch("/bilder/");
          const bilder = await response.json();

          tableBody.innerHTML = "";

          bilder.forEach((bild) => {
            if (bild.bildname === "platzhalter.jpg") return;
            const row = document.createElement("tr");
            row.classList.add("border-b");

            const imgCell = document.createElement("td");
            imgCell.className = "px-4 py-2";
            imgCell.innerHTML = `<img src="/static/assets/images/${bild.bildname}" alt="${bild.bildname}" class="h-16 rounded object-contain" />`;

            const typCell = document.createElement("td");
            typCell.className = "px-4 py-2";
            typCell.innerText = bild.zugewiesen_an
              ? `${bild.zugewiesen_an.name} (${bild.zugewiesen_an.material}, ${bild.zugewiesen_an.farbe}, ${bild.zugewiesen_an.durchmesser}mm)`
              : "Nicht zugewiesen";

            const actionsCell = document.createElement("td");
            actionsCell.className = "px-4 py-2 space-x-2";

            const entknopf = document.createElement("button");
            entknopf.innerText = "Zuweisung entfernen";
            entknopf.className = "px-2 py-1 bg-orange-600 text-white rounded text-xs hover:bg-yellow-600";

            entknopf.addEventListener("click", async () => {
              zeigePopup("Zuweisung dieses Bildes entfernen?", async () => {
                try {
                  const res = await fetch(`/bilder/${bild.bildname}/entferne-typ`, { method: "PATCH" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Zuweisung entfernt", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Entfernen der Zuweisung:", err);
                  zeigeBenachrichtigung("Fehler beim Entfernen der Zuweisung.", "red");
                }
              });
            });

            const typwechsel = document.createElement("button");
            typwechsel.innerText = "Typ ändern";
            typwechsel.className = "px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600";

            typwechsel.addEventListener("click", async () => {
              zeigeTypPopup(async (typId) => {
                try {
                  const formData = new FormData();
                  formData.append("bildname", bild.bildname);
                  const res = await fetch(`/typs/${typId}/bild`, {
                    method: "PATCH",
                    body: formData,
                  });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Typ erfolgreich zugewiesen.", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Typwechsel:", err);
                  zeigeBenachrichtigung("Fehler beim Zuweisen des Typs.", "red");
                }
              });
            });

            const löschen = document.createElement("button");
            löschen.innerText = "Löschen";
            löschen.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";

            löschen.addEventListener("click", async () => {
              zeigePopup("Dieses Bild wirklich löschen?", async () => {
                try {
                  const res = await fetch(`/bilder/${bild.bildname}`, { method: "DELETE" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Bild gelöscht.", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Löschen:", err);
                  zeigeBenachrichtigung("Fehler beim Löschen des Bildes.", "red");
                }
              });
            });

            actionsCell.append(entknopf, typwechsel, löschen);
            row.append(imgCell, typCell, actionsCell);
            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Fehler beim Laden der Bilder:", err);
        }
      }

      ladeBilder();

      if (userSettingsForm) {
        userSettingsForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const value = userDiscordInput ? userDiscordInput.value : '';
          await persistUserDiscord(value);
        });
      }
      if (userDiscordClearBtn) {
        userDiscordClearBtn.addEventListener('click', async (event) => {
          event.preventDefault();
          if (userDiscordInput) userDiscordInput.value = '';
          await persistUserDiscord('');
        });
      }

      if (discordSubscriptionsReloadBtn) {
        discordSubscriptionsReloadBtn.addEventListener('click', async (event) => {
          event.preventDefault();
          await loadDiscordSubscriptions({ showStatus: true });
        });
      }
      if (discordSubscriptionsFilter) {
        discordSubscriptionsFilter.addEventListener('change', () => {
          loadDiscordSubscriptions({ showStatus: true });
        });
      }
      if (discordSubscriptionsBody) {
        discordSubscriptionsBody.addEventListener('click', (event) => {
          const button = event.target.closest('button[data-subscription-id]');
          if (!button) return;
          const id = button.dataset.subscriptionId;
          if (!id) return;
          zeigePopup('Dieses Abonnement wirklich entfernen?', async () => {
            await removeDiscordSubscription(id);
          });
        });
      }

      // Drucker-Verwaltung
      const printerForm = document.getElementById("printerForm");
      const prName = document.getElementById("pr-name");
      const prIp = document.getElementById("pr-ip");
      const prSerial = document.getElementById("pr-serial");
      const prAccess = document.getElementById("pr-access");
      const prShow = document.getElementById("pr-show");
      const prTableBody = document.getElementById("printerTableBody");

      async function ladePrinter() {
        try {
          const res = await fetch('/api/printers');
          const list = await res.json();
          prTableBody.innerHTML = '';
          (list || []).forEach(p => {
            const tr = document.createElement('tr');
            tr.className = 'border-b';
            tr.innerHTML = `
              <td class="px-4 py-2">${p.name}</td>
              <td class="px-4 py-2">${p.ip}</td>
              <td class="px-4 py-2">${p.serial}</td>
              <td class="px-4 py-2">
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" ${p.show_on_dashboard ? 'checked' : ''} data-action="toggle" data-id="${p.id}" class="h-4 w-4" />
                  <span>anzeigen</span>
                </label>
              </td>
              <td class="px-4 py-2 space-x-2">
                <button data-action="delete" data-id="${p.id}" class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Löschen</button>
              </td>`;
            prTableBody.appendChild(tr);
          });

          // Events zuweisen
          prTableBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', async (e) => {
              const id = e.target.dataset.id;
              const checked = e.target.checked;
              try {
                const res = await fetch(`/api/printers/${id}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ show_on_dashboard: checked })
                });
                if (!res.ok) throw new Error(await res.text());
                zeigeBenachrichtigung('Drucker aktualisiert', 'blue');
              } catch (err) {
                zeigeBenachrichtigung('Fehler beim Aktualisieren', 'red');
              }
            });
          });

          prTableBody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.dataset.id;
              zeigePopup('Drucker wirklich löschen?', async () => {
                try {
                  const res = await fetch(`/api/printers/${id}`, { method: 'DELETE' });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung('Drucker gelöscht', 'blue');
                  ladePrinter();
                } catch (err) {
                  zeigeBenachrichtigung('Fehler beim Löschen', 'red');
                }
              });
            });
          });
        } catch (err) {
          console.error('Fehler beim Laden der Drucker', err);
        }
      }

      if (printerForm) {
        printerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          try {
            const res = await fetch('/api/printers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: prName.value.trim(),
                ip: prIp.value.trim(),
                serial: prSerial.value.trim(),
                access_token: prAccess.value.trim(),
                show_on_dashboard: !!prShow.checked
              })
            });
            if (!res.ok) throw new Error(await res.text());
            prName.value = '';
            prIp.value = '';
            prSerial.value = '';
            prAccess.value = '';
            prShow.checked = true;
            zeigeBenachrichtigung('Drucker gespeichert', 'blue');
            ladePrinter();
          } catch (err) {
            console.error('Fehler beim Speichern des Druckers', err);
            zeigeBenachrichtigung('Fehler beim Speichern', 'red');
          }
        });
        // Beim Start die Liste laden
        ladePrinter();
      }

      function zeigePopup(text, onConfirm) {
        const overlay = document.getElementById("popupOverlay");
        const popupText = document.getElementById("popupText");
        const popupConfirm = document.getElementById("popupConfirm");
        const popupCancel = document.getElementById("popupCancel");

        popupText.innerText = text;
        overlay.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");

        const confirmHandler = () => {
          overlay.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
          onConfirm();
          popupConfirm.removeEventListener("click", confirmHandler);
        };

        popupConfirm.addEventListener("click", confirmHandler);
        popupCancel.onclick = () => { overlay.classList.add("hidden"); document.body.classList.remove("overflow-hidden"); };
      }

      const uploadForm = document.getElementById("uploadForm");
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        const file = formData.get("file");
        if (!file || !file.name) {
          zeigeBenachrichtigung("Bitte ein Bild auswählen.", "red");
          return;
        }
        try {
          const response = await fetch("/upload-image/", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) {
            const error = await response.text();
            throw new Error(error);
          }
          zeigeBenachrichtigung("Bild erfolgreich hochgeladen!", "blue");
          uploadForm.reset();
          ladeBilder();
        } catch (err) {
          console.error("Fehler beim Hochladen:", err);
          zeigeBenachrichtigung("Fehler beim Hochladen des Bildes.", "red");
        }
      });

      // Bild-Vorschau anzeigen
      const bildInput = document.getElementById("bild");
      const vorschauContainer = document.getElementById("bildVorschauContainer");
      const vorschauBild = document.getElementById("bildVorschau");

      bildInput.addEventListener("change", () => {
        const file = bildInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            vorschauBild.src = reader.result;
            vorschauContainer.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          vorschauContainer.classList.add("hidden");
        }
      });
    // Modales Popup zum Eingeben der Typ-ID
    function zeigeTypPopup(onConfirm) {
      const overlay = document.getElementById("typPopupOverlay");
      const select = document.getElementById("typPopupSelect");
      const confirmBtn = document.getElementById("typPopupConfirm");
      const cancelBtn = document.getElementById("typPopupCancel");

      // Vorherige Optionen löschen
      select.innerHTML = `<option value="">-- Typ auswählen --</option>`;

      // Typen laden
      fetch("/typs/")
        .then((res) => res.json())
        .then((typen) => {
          typen.forEach((typ) => {
            const option = document.createElement("option");
            option.value = typ.id;
            option.textContent = `${typ.name} (${typ.material}, ${typ.farbe}, ${typ.durchmesser}mm)`;
            select.appendChild(option);
          });
        });

      overlay.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");

      const confirmHandler = () => {
        const typId = select.value;
        if (!typId) return;
        overlay.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
        onConfirm(typId);
        confirmBtn.removeEventListener("click", confirmHandler);
      };

      confirmBtn.addEventListener("click", confirmHandler);
      cancelBtn.onclick = () => { overlay.classList.add("hidden"); document.body.classList.remove("overflow-hidden"); };
    }

      if (["helper", "mod", "admin"].includes(benutzerRolle)) {
        // Bereiche beim Laden weiterhin versteckt lassen, keine .classList.remove("hidden")!
        // Token-Blöcke nur DOM hinzufügen, aber nicht sichtbar machen
        if (["mod", "admin"].includes(benutzerRolle)) {
          document.getElementById("tokenBlockContainer").appendChild(tokenBlock);
          document.getElementById("tokenUebersichtBlockContainer").appendChild(tokenUebersichtBlock);
          // Sichtbarkeit wird durch Menü gesteuert, nicht hier!
          // Nach dem Erzeugen des Tokenblocks: Rollen-Optionen beschränken
          const rolleSelect = tokenBlock.querySelector("#rolle");
          const erlaubteOptionen = benutzerRolle === "admin" ? ["user", "helper", "mod", "admin"] : ["user", "helper"];
          [...rolleSelect.options].forEach(opt => {
            if (opt.value && !erlaubteOptionen.includes(opt.value)) {
              opt.remove();
            }
          });
          ladeTokenTabelle();
          const tokenForm = document.getElementById("tokenForm");
          tokenForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const rolle = document.getElementById("rolle").value;
            if (!rolle) {
              zeigeBenachrichtigung("Bitte eine Rolle auswählen", "red");
              return;
            }
            const erlaubteRollen = benutzerRolle === "admin" ? ["user", "helper", "mod", "admin"] : ["user", "helper"];
            if (!erlaubteRollen.includes(rolle)) {
              zeigeBenachrichtigung("Du darfst nur Tokens für niedrigere Rollen erstellen.", "red");
              return;
            }
            try {
              const res = await fetch("/admin/create-token", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ rolle })
              });
              if (!res.ok) throw new Error(await res.text());
              const daten = await res.json();
              document.getElementById("generierterToken").textContent = daten.token;
              document.getElementById("tokenAnzeige").classList.remove("hidden");
              zeigeBenachrichtigung("Token erfolgreich erstellt.", "blue");
            } catch (err) {
              console.error("Token-Erstellung fehlgeschlagen", err);
              zeigeBenachrichtigung("Fehler beim Erstellen des Tokens.", "red");
            }
          });

          if (benutzerRolle === "admin" && discordBotForm) {
            await loadDiscordBotConfig();
            updateDiscordBotFieldState();
            discordBotForm.addEventListener('submit', submitDiscordBotConfig);
            if (discordBotReloadBtn) {
              discordBotReloadBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                await loadDiscordBotConfig({ showStatus: true });
              });
            }
            if (discordBotUseDmInput) {
              discordBotUseDmInput.addEventListener('change', updateDiscordBotFieldState);
            }
          }

          const verbrauchNavBlock = document.getElementById("verbrauchNavBlock");
          const verbrauchTabelleBody = document.getElementById("verbrauchTabelleBody");
          const verbrauchSum = document.getElementById("verbrauchSum");
          const verbrauchCount = document.getElementById("verbrauchCount");
          const verbrauchNeuLaden = document.getElementById("verbrauchNeuLaden");
          const einstellungsMenue = document.getElementById("einstellungsMenue");
          const verbrauchDateFormatter = new Intl.DateTimeFormat("de-DE", { dateStyle: "medium", timeStyle: "short" });
          const verbrauchNumberFormat = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 0, maximumFractionDigits: 2 });
          const verbrauchCountFormat = new Intl.NumberFormat("de-DE");
          let verbrauchGeladen = false;

          const formatVerbrauch = (value) => `${verbrauchNumberFormat.format(value ?? 0)} g`;
          const formatDatum = (value) => {
            if (!value) return "–";
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? "–" : verbrauchDateFormatter.format(date);
          };

          const baueVerbrauchszeile = (entry) => {
            const tr = document.createElement("tr");
            tr.className = "border-b align-top";

            const datumTd = document.createElement("td");
            datumTd.className = "px-4 py-2 whitespace-nowrap";
            datumTd.textContent = formatDatum(entry.datum);

            const infoTd = document.createElement("td");
            infoTd.className = "px-4 py-2";
            const nameDiv = document.createElement("div");
            nameDiv.className = "font-semibold text-white";
            const typLabel = entry.typ_name || (entry.typ_id != null ? `Typ #${entry.typ_id}` : "Unbekannter Typ");
            nameDiv.textContent = typLabel;
            const metaDiv = document.createElement("div");
            metaDiv.className = "text-xs text-gray-400 mt-1";
            const details = [];
            if (entry.material) details.push(entry.material);
            if (entry.farbe) details.push(entry.farbe);
            if (entry.durchmesser !== null && entry.durchmesser !== undefined) {
              details.push(`${entry.durchmesser} mm`);
            }
            const metaParts = [`Typ-ID: ${entry.typ_id ?? "–"}`];
            if (details.length) metaParts.push(details.join(" · "));
            metaDiv.textContent = metaParts.join(" · ");
            const logDiv = document.createElement("div");
            logDiv.className = "text-xs text-gray-500 mt-1";
            logDiv.textContent = `Log-ID: ${entry.id}`;
            infoTd.append(nameDiv, metaDiv, logDiv);

            const wertTd = document.createElement("td");
            wertTd.className = "px-4 py-2 font-semibold text-white whitespace-nowrap";
            wertTd.textContent = formatVerbrauch(entry.verbrauch_in_g);

            const actionTd = document.createElement("td");
            actionTd.className = "px-4 py-2 space-x-2 whitespace-nowrap";

            const editBtn = document.createElement("button");
            editBtn.textContent = "Anpassen";
            editBtn.className = "px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-500";
            editBtn.addEventListener("click", async () => {
              const eingabe = prompt("Neuer Verbrauch in Gramm:", String(entry.verbrauch_in_g));
              if (eingabe === null) return;
              const sanisiert = eingabe.replace(",", ".").trim();
              if (!sanisiert) {
                zeigeBenachrichtigung("Bitte einen Wert eingeben.", "red");
                return;
              }
              const wert = Number(sanisiert);
              if (!Number.isFinite(wert) || wert < 0) {
                zeigeBenachrichtigung("Ungültiger Verbrauchswert.", "red");
                return;
              }
              if (Math.abs(wert - entry.verbrauch_in_g) < 1e-6) {
                return;
              }
              try {
                const res = await fetch(`/admin/verbrauch/${entry.id}`, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ verbrauch_in_g: wert })
                });
                if (!res.ok) throw new Error(await res.text());
                zeigeBenachrichtigung("Verbrauch wurde aktualisiert.", "blue");
                verbrauchGeladen = false;
                ladeVerbrauchsdaten();
              } catch (err) {
                console.error("Fehler beim Aktualisieren des Verbrauchs:", err);
                zeigeBenachrichtigung("Fehler beim Aktualisieren.", "red");
              }
            });

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Löschen";
            deleteBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
            deleteBtn.addEventListener("click", () => {
              zeigePopup("Diesen Verbrauchseintrag wirklich löschen?", async () => {
                try {
                  const res = await fetch(`/admin/verbrauch/${entry.id}`, { method: "DELETE" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Verbrauchseintrag gelöscht.", "blue");
                  verbrauchGeladen = false;
                  ladeVerbrauchsdaten();
                } catch (err) {
                  console.error("Fehler beim Löschen des Verbrauchseintrags:", err);
                  zeigeBenachrichtigung("Fehler beim Löschen.", "red");
                }
              });
            });

            actionTd.append(editBtn, deleteBtn);
            tr.append(datumTd, infoTd, wertTd, actionTd);
            return tr;
          };

          const ladeVerbrauchsdaten = async () => {
            if (!verbrauchTabelleBody) return;
            verbrauchTabelleBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">Lade Daten…</td></tr>`;
            try {
              const res = await fetch("/admin/verbrauch");
              if (!res.ok) throw new Error(await res.text());
              const daten = await res.json();
              if (verbrauchSum) verbrauchSum.textContent = formatVerbrauch(daten.total_sum ?? 0);
              if (verbrauchCount) verbrauchCount.textContent = verbrauchCountFormat.format(daten.total_count ?? 0);
              verbrauchTabelleBody.innerHTML = "";
              if (!Array.isArray(daten.entries) || daten.entries.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="4" class="px-4 py-6 text-center text-gray-400">Keine Verbrauchseinträge vorhanden</td>`;
                verbrauchTabelleBody.appendChild(row);
              } else {
                daten.entries.forEach((entry) => {
                  verbrauchTabelleBody.appendChild(baueVerbrauchszeile(entry));
                });
              }
              verbrauchGeladen = true;
            } catch (err) {
              console.error("Fehler beim Laden der Verbrauchsdaten:", err);
              zeigeBenachrichtigung("Fehler beim Laden der Verbrauchsdaten.", "red");
              verbrauchTabelleBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">Fehler beim Laden</td></tr>`;
            }
          };

          const ensureVerbrauchsdaten = () => {
            if (!verbrauchGeladen) {
              ladeVerbrauchsdaten();
            }
          };

          if (verbrauchNavBlock) {
            verbrauchNavBlock.classList.remove("hidden");
          }
          if (verbrauchNeuLaden) {
            verbrauchNeuLaden.addEventListener("click", (event) => {
              event.preventDefault();
              ladeVerbrauchsdaten();
            });
          }
          if (einstellungsMenue) {
            einstellungsMenue.addEventListener("click", (event) => {
              if (event.target.dataset.ziel === "verbrauchVerwaltungBlock") {
                ensureVerbrauchsdaten();
              }
            });
          }
          ensureVerbrauchsdaten();

        }
      } else {
        const bilderVerwaltung = document.getElementById("bilderVerwaltung");
        if (bilderVerwaltung) bilderVerwaltung.remove();
        const vorhandeneBilderBlock = document.getElementById("vorhandeneBilderBlock");
        if (vorhandeneBilderBlock) vorhandeneBilderBlock.remove();
      }
  // Funktion zum Laden der Token-Tabelle
  async function ladeTokenTabelle() {
    try {
      const res = await fetch("/admin/tokens");
      const tokens = await res.json();
      const tbody = document.getElementById("tokenTabelleBody");
      tbody.innerHTML = "";
      tokens.forEach(t => {
        const row = document.createElement("tr");
        row.className = "border-b";
        // Token
        const tokenCell = document.createElement("td");
        tokenCell.className = "px-4 py-2 font-mono";
        tokenCell.textContent = t.token;
        // Rolle
        const rolleCell = document.createElement("td");
        rolleCell.className = "px-4 py-2";
        rolleCell.textContent = t.rolle;
        // Verwendet
        const verwendetCell = document.createElement("td");
        verwendetCell.className = "px-4 py-2";
        verwendetCell.textContent = t.verwendet ? "✅" : "❌";
        // Aktion
        const loeschBtn = document.createElement("button");
        loeschBtn.textContent = "Löschen";
        loeschBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
        loeschBtn.addEventListener("click", async () => {
          zeigePopup("Diesen Token wirklich löschen?", async () => {
            try {
              const res = await fetch(`/admin/token/${t.token}`, { method: "DELETE" });
              if (!res.ok) throw new Error(await res.text());
              zeigeBenachrichtigung("Token gelöscht.", "blue");
              ladeTokenTabelle();
            } catch (err) {
              console.error("Fehler beim Löschen des Tokens:", err);
              zeigeBenachrichtigung("Fehler beim Löschen des Tokens.", "red");
            }
          });
        });
        const aktionCell = document.createElement("td");
        aktionCell.className = "px-4 py-2";
        aktionCell.appendChild(loeschBtn);
        // Zeile zusammenbauen
        row.appendChild(tokenCell);
        row.appendChild(rolleCell);
        row.appendChild(verwendetCell);
        row.appendChild(aktionCell);
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error("Fehler beim Laden der Tokens:", err);
    }
  }
  // User-Tabelle laden und anzeigen
  // Modales Popup für Rollenbearbeitung
  function zeigeRollenPopup(username, aktuelleRolle, onConfirm) {
    const overlay = document.getElementById("rollePopupOverlay");
    const select = document.getElementById("rollePopupSelect");
    const confirmBtn = document.getElementById("rollePopupConfirm");
    const cancelBtn = document.getElementById("rollePopupCancel");

    select.value = aktuelleRolle;
    overlay.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");

    const confirmHandler = () => {
      const neueRolle = select.value;
      if (!neueRolle || neueRolle === aktuelleRolle) return;
      overlay.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
      onConfirm(neueRolle);
      confirmBtn.removeEventListener("click", confirmHandler);
    };

    confirmBtn.addEventListener("click", confirmHandler);
    cancelBtn.onclick = () => { overlay.classList.add("hidden"); document.body.classList.remove("overflow-hidden"); };
  }

  function formatDateTime(value) {
    if (!value) return "-";
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return value;
    return date.toLocaleString("de-DE", { dateStyle: "short", timeStyle: "short" });
  }

      async function ladeBenutzerTabelle() {
        try {
          const res = await fetch("/admin/users");
          if (!res.ok) throw new Error(await res.text());
          const users = await res.json();
          const tbody = document.getElementById("userTabelleBody");
          tbody.innerHTML = "";
          users.forEach(user => {
            const tr = document.createElement("tr");
            tr.className = "border-b";
            // Benutzername
            const nameTd = document.createElement("td");
            nameTd.className = "px-4 py-2";
            nameTd.textContent = user.username;
            // Rolle
            const rolleTd = document.createElement("td");
            rolleTd.className = "px-4 py-2";
            rolleTd.textContent = user.rolle;
            const erstelltTd = document.createElement("td");
            erstelltTd.className = "px-4 py-2";
            erstelltTd.textContent = formatDateTime(user.created_at);
            const lastSeenTd = document.createElement("td");
            lastSeenTd.className = "px-4 py-2";
            lastSeenTd.textContent = formatDateTime(user.last_seen);
            // Aktionen
            const aktionTd = document.createElement("td");
            aktionTd.className = "px-4 py-2 space-x-2";
            // Rollen-Logik für Aktionen
            const rollenReihenfolge = { user: 0, helper: 1, mod: 2, admin: 3 };
            const eigeneStufe = rollenReihenfolge[benutzerRolle];
            const zielStufe = rollenReihenfolge[user.rolle];

            if (
              (benutzerRolle === "admin") ||
              (benutzerRolle === "mod" && zielStufe < eigeneStufe)
            ) {
              // Button Rolle bearbeiten
              const rolleBtn = document.createElement("button");
              rolleBtn.textContent = "Rolle bearbeiten";
              rolleBtn.className = "px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600";
              rolleBtn.addEventListener("click", () => {
                zeigeRollenPopup(user.username, user.rolle, async (neueRolle) => {
                  try {
                    const res = await fetch(`/admin/user/${encodeURIComponent(user.username)}/rolle`, {
                      method: "PATCH",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ rolle: neueRolle })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    zeigeBenachrichtigung("Rolle geändert.", "blue");
                    ladeBenutzerTabelle();
                  } catch (err) {
                    zeigeBenachrichtigung("Fehler beim Ändern der Rolle.", "red");
                  }
                });
              });
              aktionTd.appendChild(rolleBtn);

              // Button Löschen
              const loeschBtn = document.createElement("button");
              loeschBtn.textContent = "Löschen";
              loeschBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
              loeschBtn.addEventListener("click", () => {
                zeigePopup(`Benutzer ${user.username} wirklich löschen?`, async () => {
                  try {
                    const res = await fetch(`/admin/users/${encodeURIComponent(user.username)}`, { method: "DELETE" });
                    if (!res.ok) throw new Error(await res.text());
                    zeigeBenachrichtigung("Benutzer gelöscht.", "blue");
                    ladeBenutzerTabelle();
                  } catch (err) {
                    zeigeBenachrichtigung("Fehler beim Löschen des Benutzers.", "red");
                  }
                });
              });
              aktionTd.appendChild(loeschBtn);
            } else {
              aktionTd.textContent = "-";
            }

            tr.appendChild(nameTd);
            tr.appendChild(rolleTd);
            tr.appendChild(erstelltTd);
            tr.appendChild(lastSeenTd);
            tr.appendChild(aktionTd);
            tbody.appendChild(tr);
          });
        } catch (err) {
          const tbody = document.getElementById("userTabelleBody");
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-2 text-gray-200">Fehler beim Laden der Benutzerliste.</td></tr>`;
          }
        }
      }

  // User-Tabelle beim Laden anzeigen, wenn Rolle mod oder admin
  if (["mod", "admin"].includes(benutzerRolle)) {
    ladeBenutzerTabelle();
  }
});
  </script>
  <div id="popupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-700 rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p id="popupText" class="mb-4 text-sm text-gray-100">Bist du sicher?</p>
      <div class="flex justify-center gap-4">
        <button id="popupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="popupConfirm" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Ja, bestätigen</button>
      </div>
    </div>
  </div>
  <div id="typPopupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-700 rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p class="mb-2 text-sm text-gray-100">Wähle einen neuen Typ aus:</p>
      <select id="typPopupSelect" class="w-full mb-4 px-3 py-2 border border-gray-500 text-sm text-gray-100 bg-gray-600 focus:outline-none focus:ring">
        <option value="">-- Typ auswählen --</option>
      </select>
      <div class="flex justify-center gap-4">
        <button id="typPopupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="typPopupConfirm" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Typ ändern</button>
      </div>
    </div>
  </div>
  <div id="rollePopupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-700 rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p class="mb-2 text-sm text-gray-100">Wähle eine neue Rolle:</p>
      <select id="rollePopupSelect" class="w-full mb-4 px-3 py-2 border border-gray-500 rounded text-sm text-gray-100 bg-gray-600 focus:outline-none focus:ring">
        <option value="">-- Rolle auswählen --</option>
        <option value="user">User</option>
        <option value="helper">Helper</option>
        <option value="mod">Mod</option>
        <option value="admin">Admin</option>
      </select>
      <div class="flex justify-center gap-4">
        <button id="rollePopupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="rollePopupConfirm" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Rolle ändern</button>
      </div>
    </div>
  </div>
  <div id="benachrichtigung" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded shadow hidden z-50 text-sm"></div>
  </body>
</html>
