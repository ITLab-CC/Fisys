<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Einstellungen | Fisys</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <style>
    .menu-highlight {
      transition: background-color 0.2s ease, transform 0.3s ease;
    }

    .highlight-bar {
      transition: all 0.3s ease;
      position: absolute;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: #0073ffaa; 
      border-radius: 2px;
    }

    .highlight-container {
      position: relative;
    }
  </style>
  <body class="min-h-screen flex bg-gray-800">
    <!-- Sidebar -->
    <aside class="w-64 bg-[#0f172a] text-white flex flex-col justify-between fixed h-full">
      <div>
        <div class="pt-1 pb-1">
          <img src="/static/assets/Fisys Logo.png" alt="Fisys Logo" class="h-20 mx-auto">
        </div>
        <nav class="px-4 space-y-2">
          <a href="/" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Dashboard</a>
          <a href="/spulen.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Spulen</a>
          <a href="/filamentseite.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Filamenttypen</a>
          <hr class="my-2 border-gray-700" />
          <a href="/status" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Status</a>
          <a href="/einstellungen.html" class="block px-4 py-2 rounded bg-gray-800 font-semibold text-white">Einstellungen</a>
        </nav>
      </div>
      <div class="mt-auto">
        <div class="px-4 pb-2" id="authBereich">
          <!-- Wird per JavaScript ersetzt durch Login- oder Logout-Button -->
        </div>
        <div class="p-4 text-xs text-center text-gray-400">© 2025 Fisys</div>
      </div>
    </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col ml-64">
      <header class="bg-gray-800 px-10 py-10 relative">
        <h1 class="text-3xl text-white font-bold">Einstellungen</h1>
        <p class="text-sm text-gray-200 mt-1">Verwalte globale Optionen und Systemeinstellungen</p>
      </header>

      <section class="flex-1 pt-2 px-10 pb-10">
        <div class="flex flex-col xl:flex-row gap-8">
          <!-- Seitenmenü -->
          <aside class="w-full xl:w-1/4 bg-gray-700 border border-gray-600 rounded p-4 self-start">
            <nav id="einstellungsMenue" class="space-y-4 highlight-container">
              <div id="highlightBar" class="highlight-bar hidden"></div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Mein Profil</p>
                <button data-ziel="userSettingsBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Benutzereinstellungen</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Bildeinstellungen</p>
                <button data-ziel="bilderVerwaltung" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Bild hochladen</button>
                <button data-ziel="vorhandeneBilderBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Vorhandene Bilder</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Drucker</p>
                <button data-ziel="printerVerwaltungBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Drucker verwalten</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">Tokens</p>
                <button data-ziel="tokenBlockContainer" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Token erstellen</button>
                <button data-ziel="tokenUebersichtBlockContainer" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Token Übersicht</button>
              </div>
              <div>
                <p class="text-sm font-semibold text-white mb-1">User</p>
                <button data-ziel="userVerwaltungBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">User verwalten</button>
              </div>
              <div id="verbrauchNavBlock" class="hidden">
                <p class="text-sm font-semibold text-white mb-1">Filamentverbrauch</p>
                <button data-ziel="verbrauchVerwaltungBlock" class="block w-full text-gray-200 text-left px-3 py-2 rounded hover:bg-gray-600 text-sm">Verbrauch verwalten</button>
              </div>
            </nav>
          </aside>

          <!-- Inhalt -->
          <div class="flex-1 space-y-10">
            <div id="userSettingsBlock" class="hidden bg-gray-700 p-6 rounded shadow max-w-3xl mt-10">
              <h2 class="text-xl text-white font-semibold mb-4">Benutzereinstellungen</h2>
              <p class="text-sm text-gray-300">Hier kannst du künftig persönliche Einstellungen für dein Konto anpassen.</p>
              <div class="mt-6 rounded border border-dashed border-gray-500 bg-gray-800 p-4 text-sm text-gray-400">Weitere Optionen folgen demnächst.</div>
            </div>
            <!-- Drucker verwalten -->
            <div id="printerVerwaltungBlock" class="hidden bg-gray-700 p-6 rounded shadow max-w-3xl mt-10">
              <h2 class="text-xl text-white font-semibold mb-4">Drucker</h2>
              <form id="printerForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">Name</label>
                  <input type="text" id="pr-name" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="Mein Drucker" required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">IP</label>
                  <input type="text" id="pr-ip" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="192.168.1.10" required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">Serial</label>
                  <input type="text" id="pr-serial" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="X1C123..." required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-100 mb-1">Access-Token</label>
                  <input type="text" id="pr-access" class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2" placeholder="Access Token" required />
                </div>
                <div class="md:col-span-2 flex items-center gap-3 mt-2">
                  <input type="checkbox" id="pr-show" class="h-4 w-4" checked />
                  <label for="pr-show" class="text-sm text-gray-100">Auf Dashboard anzeigen</label>
                </div>
                <div class="md:col-span-2 mt-2">
                  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">Speichern</button>
                </div>
              </form>
              <div>
                <h3 class="text-sm font-medium text-white mb-2">Gespeicherte Drucker</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-sm text-gray-100 text-left border">
                    <thead class="bg-gray-600 border-b">
                      <tr>
                        <th class="px-4 py-2">Name</th>
                        <th class="px-4 py-2">IP</th>
                        <th class="px-4 py-2">Serial</th>
                        <th class="px-4 py-2">Auf Dashboard</th>
                        <th class="px-4 py-2">Aktionen</th>
                      </tr>
                    </thead>
                    <tbody id="printerTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <!-- Filamentbild hochladen -->
            <div id="bilderVerwaltung" class="hidden bg-gray-700 p-6 rounded shadow max-w-xl mt-10">
              <h2 class="text-xl text-white font-semibold mb-4">Filamentbild hochladen</h2>
              <form id="uploadForm" class="space-y-3">
                <div>
                  <label for="bild" class="block text-sm font-medium text-gray-100 mb-1">Bild auswählen</label>
                  <input type="file" id="bild" name="file" accept="image/*" class="block w-full text-sm text-gray-200 border border-gray-400 rounded px-3 py-2">
                </div>
                <div id="bildVorschauContainer" class="mt-1 hidden">
                  <p class="text-sm font-medium text-gray-100 mb-1">Vorschau:</p>
                  <img id="bildVorschau" src="" alt="Bildvorschau" class="h-24 rounded border">
                </div>
                <div>
                  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">Bild hochladen</button>
                </div>
              </form>
            </div>

            <!-- Token erstellen -->
            <div id="tokenBlockContainer" class="hidden"></div>

            <!-- Vorhandene Bilder -->
            <div id="vorhandeneBilderBlock" class="hidden bg-gray-700 p-6 rounded shadow">
              <h2 class="text-xl text-white font-semibold mb-4">Vorhandene Bilder verwalten</h2>
              <div class="overflow-x-auto">
                <table class="min-w-full text-gray-200 text-sm text-left border border-gray-400">
                  <thead class="bg-gray-600 border-b">
                    <tr>
                      <th class="px-4 py-2">Bild</th>
                      <th class="px-4 py-2">Zugewiesener Typ</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="bildVerwaltungTabelle"></tbody>
                </table>
              </div>
            </div>

            <!-- Token-Tabelle -->
            <div id="tokenUebersichtBlockContainer" class="hidden"></div>

            <!-- User-Verwaltung -->
            <div id="userVerwaltungBlock" class="hidden bg-gray-700 p-6 rounded shadow">
              <h2 class="text-xl text-white font-semibold mb-4">User verwalten</h2>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-gray-100 text-left border">
                  <thead class="bg-gray-600 border-b">
                    <tr>
                      <th class="px-4 py-2">Benutzername</th>
                      <th class="px-4 py-2">Rolle</th>
                      <th class="px-4 py-2">Erstellt am</th>
                      <th class="px-4 py-2">Zuletzt aktiv</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="userTabelleBody"></tbody>
                </table>
              </div>
            </div>

            <!-- Verbrauch verwalten -->
            <div id="verbrauchVerwaltungBlock" class="hidden bg-gray-700 p-6 rounded shadow">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                <div>
                  <h2 class="text-xl text-white font-semibold">Filamentverbrauch verwalten</h2>
                  <p class="text-sm text-gray-300">Entferne Testeinträge und passe fehlerhafte Werte an.</p>
                </div>
                <button id="verbrauchNeuLaden" class="self-start md:self-center bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500 text-sm">Aktualisieren</button>
              </div>
              <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 mb-6">
                <div class="bg-gray-800 p-4 rounded border border-gray-600">
                  <p class="text-xs uppercase text-gray-400 tracking-wide">Gesamtverbrauch</p>
                  <p id="verbrauchSum" class="text-lg font-semibold text-white mt-1">–</p>
                </div>
                <div class="bg-gray-800 p-4 rounded border border-gray-600">
                  <p class="text-xs uppercase text-gray-400 tracking-wide">Einträge im Log</p>
                  <p id="verbrauchCount" class="text-lg font-semibold text-white mt-1">–</p>
                </div>
                <div class="bg-gray-800 p-4 rounded border border-gray-600">
                  <p class="text-xs uppercase text-gray-400 tracking-wide">Hinweis</p>
                  <p class="text-sm text-gray-300 mt-1">Änderungen wirken sich direkt auf alle Statistiken aus.</p>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-gray-100 text-left border">
                  <thead class="bg-gray-600 border-b">
                    <tr>
                      <th class="px-4 py-2">Datum</th>
                      <th class="px-4 py-2">Eintrag</th>
                      <th class="px-4 py-2">Verbrauch</th>
                      <th class="px-4 py-2">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="verbrauchTabelleBody">
                    <tr>
                      <td colspan="4" class="px-4 py-6 text-center text-gray-400">Noch keine Daten geladen</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
      const highlightBar = document.getElementById("highlightBar");
      const settingsMenu = document.getElementById("einstellungsMenue");
      if (settingsMenu) {
        settingsMenu.style.visibility = "hidden";
      }
      const ALL_SECTION_IDS = [
        "userSettingsBlock",
        "bilderVerwaltung",
        "vorhandeneBilderBlock",
        "printerVerwaltungBlock",
        "tokenBlockContainer",
        "tokenUebersichtBlockContainer",
        "userVerwaltungBlock",
        "verbrauchVerwaltungBlock"
      ];
      let availableSectionIds = [...ALL_SECTION_IDS];
      let autoActivatedInitialSection = false;

      const navigationPermissions = {
        userSettingsBlock: ["user", "helper", "mod", "admin"],
        bilderVerwaltung: ["helper", "mod", "admin"],
        vorhandeneBilderBlock: ["helper", "mod", "admin"],
        printerVerwaltungBlock: ["helper", "mod", "admin"],
        tokenBlockContainer: ["mod", "admin"],
        tokenUebersichtBlockContainer: ["mod", "admin"],
        userVerwaltungBlock: ["mod", "admin"],
        verbrauchVerwaltungBlock: ["mod", "admin"]
      };

      const normalizeRole = (role) => (typeof role === "string" ? role.toLowerCase().trim() : "");

      const removeAvailableSection = (id) => {
        const idx = availableSectionIds.indexOf(id);
        if (idx !== -1) {
          availableSectionIds.splice(idx, 1);
        }
      };

      const hideAllSections = () => {
        availableSectionIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });
      };

      const activateFirstAvailableSection = () => {
        if (autoActivatedInitialSection) return;
        const firstButton = settingsMenu?.querySelector("button");
        if (firstButton) {
          autoActivatedInitialSection = true;
          firstButton.click();
        }
      };

      const filterSettingsMenuForRole = (role) => {
        const normalizedRole = normalizeRole(role);
        Object.entries(navigationPermissions).forEach(([sectionId, allowedRoles]) => {
          if (!allowedRoles.includes(normalizedRole)) {
            if (settingsMenu) {
              const button = settingsMenu.querySelector(`button[data-ziel="${sectionId}"]`);
              if (button) {
                const parentSection = button.closest("div");
                button.remove();
                if (parentSection && parentSection.querySelectorAll("button").length === 0) {
                  parentSection.remove();
                }
              }
            }
            const area = document.getElementById(sectionId);
            if (area) {
              area.remove();
            }
            removeAvailableSection(sectionId);
          }
        });
        if (settingsMenu) {
          settingsMenu.style.visibility = "visible";
          if (highlightBar && settingsMenu.querySelectorAll("button").length === 0) {
            highlightBar.classList.add("hidden");
          }
        }
      };

      if (settingsMenu) {
        settingsMenu.addEventListener("click", (e) => {
          const ziel = e.target?.dataset?.ziel;
          if (!ziel || !e.target.matches("button")) return;

          settingsMenu.querySelectorAll("button").forEach((btn) => {
            btn.classList.remove("bg-gray-600", "menu-highlight");
          });
          e.target.classList.add("bg-gray-600", "menu-highlight");

          const offsetTop = e.target.offsetTop;
          if (highlightBar) {
            highlightBar.style.top = offsetTop + "px";
            highlightBar.style.height = e.target.offsetHeight + "px";
            highlightBar.classList.remove("hidden");
          }

          hideAllSections();

          const zielElement = document.getElementById(ziel);
          if (zielElement) zielElement.classList.remove("hidden");
        });
      }

      hideAllSections();
      let benutzerRolle = null;
      const tokenBlock = document.createElement("div");
      tokenBlock.className = "bg-gray-700 p-6 rounded shadow max-w-xl mt-10";
      tokenBlock.innerHTML = `
        <h2 class="text-xl text-white font-semibold mb-4">Registrierungstoken erstellen</h2>
        <form id="tokenForm" class="space-y-4">
          <div>
            <label for="rolle" class="block text-sm font-medium text-gray-200 mb-1">Rolle auswählen</label>
            <select id="rolle" name="rolle" required class="block w-full text-sm text-gray-200 bg-gray-600 border border-gray-500 rounded px-3 py-2">
              <option value="">-- auswählen --</option>
              <option value="user">User</option>
              <option value="helper">Helper</option>
              <option value="mod">Mod</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div>
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">Token generieren</button>
          </div>
        </form>
        <div id="tokenAnzeige" class="mt-4 hidden">
          <p class="text-sm text-gray-700">Token:</p>
          <code id="generierterToken" class="block text-center mt-1 text-lg font-mono text-blue-600 bg-blue-200 p-2 rounded">________</code>
        </div>
      `;
      // Token-Übersicht-Block erstellen
      const tokenUebersichtBlock = document.createElement("div");
      tokenUebersichtBlock.className = "bg-gray-700 p-6 rounded shadow max-w-xl mt-6";
      tokenUebersichtBlock.innerHTML = `
        <h2 class="text-xl font-semibold text-white mb-4">Alle Tokens</h2>
        <div id="tokenTabelleWrapper" class="overflow-x-auto">
          <table class="min-w-full text-sm text-gray-100 text-left border">
            <thead class="bg-gray-600 border-b">
              <tr>
                <th class="px-4 py-2">Token</th>
                <th class="px-4 py-2">Rolle</th>
                <th class="px-4 py-2">Verwendet</th>
                <th class="px-4 py-2">Aktion</th>
              </tr>
            </thead>
            <tbody id="tokenTabelleBody"></tbody>
          </table>
        </div>
      `;
      const authBereich = document.getElementById("authBereich");
      try {
        const res = await fetch("/api/userinfo");
        if (!res.ok) throw new Error("Nicht eingeloggt");
        const daten = await res.json();
        benutzerRolle = daten.rolle;
        filterSettingsMenuForRole(benutzerRolle);
        hideAllSections();
        activateFirstAvailableSection();
        // Auth-Bereich dynamisch anpassen (Login/Logout, Benutzername)
        authBereich.innerHTML = `
          <form id="logoutForm" class="flex flex-col items-center">
            <span class="text-sm text-gray-300 mb-1">Angemeldet als ${daten.username}</span>
            <button type="submit" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition w-full">Logout</button>
          </form>
        `;
        document.getElementById("logoutForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const res = await fetch("/logout", { method: "POST" });
            if (res.ok) {
              window.location.href = "/login";
            }
          } catch (err) {
            console.error("Logout fehlgeschlagen", err);
          }
        });
      } catch (err) {
        console.warn("Nicht eingeloggt – Weiterleitung zur Login-Seite");
        window.location.href = "/login";
        return;
      }

      const tableBody = document.getElementById("bildVerwaltungTabelle");

      function zeigeBenachrichtigung(text, farbe = "blue") {
        const box = document.getElementById("benachrichtigung");
        box.textContent = text;
        box.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-${farbe}-600 text-white px-4 py-2 rounded shadow z-50 text-sm`;
        box.classList.remove("hidden");
        setTimeout(() => box.classList.add("hidden"), 3000);
      }

      async function ladeBilder() {
        try {
          const response = await fetch("/bilder/");
          const bilder = await response.json();

          tableBody.innerHTML = "";

          bilder.forEach((bild) => {
            if (bild.bildname === "platzhalter.jpg") return;
            const row = document.createElement("tr");
            row.classList.add("border-b");

            const imgCell = document.createElement("td");
            imgCell.className = "px-4 py-2";
            imgCell.innerHTML = `<img src="/static/assets/images/${bild.bildname}" alt="${bild.bildname}" class="h-16 rounded object-contain" />`;

            const typCell = document.createElement("td");
            typCell.className = "px-4 py-2";
            typCell.innerText = bild.zugewiesen_an
              ? `${bild.zugewiesen_an.name} (${bild.zugewiesen_an.material}, ${bild.zugewiesen_an.farbe}, ${bild.zugewiesen_an.durchmesser}mm)`
              : "Nicht zugewiesen";

            const actionsCell = document.createElement("td");
            actionsCell.className = "px-4 py-2 space-x-2";

            const entknopf = document.createElement("button");
            entknopf.innerText = "Zuweisung entfernen";
            entknopf.className = "px-2 py-1 bg-orange-600 text-white rounded text-xs hover:bg-yellow-600";

            entknopf.addEventListener("click", async () => {
              zeigePopup("Zuweisung dieses Bildes entfernen?", async () => {
                try {
                  const res = await fetch(`/bilder/${bild.bildname}/entferne-typ`, { method: "PATCH" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Zuweisung entfernt", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Entfernen der Zuweisung:", err);
                  zeigeBenachrichtigung("Fehler beim Entfernen der Zuweisung.", "red");
                }
              });
            });

            const typwechsel = document.createElement("button");
            typwechsel.innerText = "Typ ändern";
            typwechsel.className = "px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600";

            typwechsel.addEventListener("click", async () => {
              zeigeTypPopup(async (typId) => {
                try {
                  const formData = new FormData();
                  formData.append("bildname", bild.bildname);
                  const res = await fetch(`/typs/${typId}/bild`, {
                    method: "PATCH",
                    body: formData,
                  });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Typ erfolgreich zugewiesen.", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Typwechsel:", err);
                  zeigeBenachrichtigung("Fehler beim Zuweisen des Typs.", "red");
                }
              });
            });

            const löschen = document.createElement("button");
            löschen.innerText = "Löschen";
            löschen.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";

            löschen.addEventListener("click", async () => {
              zeigePopup("Dieses Bild wirklich löschen?", async () => {
                try {
                  const res = await fetch(`/bilder/${bild.bildname}`, { method: "DELETE" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Bild gelöscht.", "blue");
                  ladeBilder();
                } catch (err) {
                  console.error("Fehler beim Löschen:", err);
                  zeigeBenachrichtigung("Fehler beim Löschen des Bildes.", "red");
                }
              });
            });

            actionsCell.append(entknopf, typwechsel, löschen);
            row.append(imgCell, typCell, actionsCell);
            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Fehler beim Laden der Bilder:", err);
        }
      }

      ladeBilder();

      // Drucker-Verwaltung
      const printerForm = document.getElementById("printerForm");
      const prName = document.getElementById("pr-name");
      const prIp = document.getElementById("pr-ip");
      const prSerial = document.getElementById("pr-serial");
      const prAccess = document.getElementById("pr-access");
      const prShow = document.getElementById("pr-show");
      const prTableBody = document.getElementById("printerTableBody");

      async function ladePrinter() {
        try {
          const res = await fetch('/api/printers');
          const list = await res.json();
          prTableBody.innerHTML = '';
          (list || []).forEach(p => {
            const tr = document.createElement('tr');
            tr.className = 'border-b';
            tr.innerHTML = `
              <td class="px-4 py-2">${p.name}</td>
              <td class="px-4 py-2">${p.ip}</td>
              <td class="px-4 py-2">${p.serial}</td>
              <td class="px-4 py-2">
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" ${p.show_on_dashboard ? 'checked' : ''} data-action="toggle" data-id="${p.id}" class="h-4 w-4" />
                  <span>anzeigen</span>
                </label>
              </td>
              <td class="px-4 py-2 space-x-2">
                <button data-action="delete" data-id="${p.id}" class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Löschen</button>
              </td>`;
            prTableBody.appendChild(tr);
          });

          // Events zuweisen
          prTableBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', async (e) => {
              const id = e.target.dataset.id;
              const checked = e.target.checked;
              try {
                const res = await fetch(`/api/printers/${id}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ show_on_dashboard: checked })
                });
                if (!res.ok) throw new Error(await res.text());
                zeigeBenachrichtigung('Drucker aktualisiert', 'blue');
              } catch (err) {
                zeigeBenachrichtigung('Fehler beim Aktualisieren', 'red');
              }
            });
          });

          prTableBody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.dataset.id;
              zeigePopup('Drucker wirklich löschen?', async () => {
                try {
                  const res = await fetch(`/api/printers/${id}`, { method: 'DELETE' });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung('Drucker gelöscht', 'blue');
                  ladePrinter();
                } catch (err) {
                  zeigeBenachrichtigung('Fehler beim Löschen', 'red');
                }
              });
            });
          });
        } catch (err) {
          console.error('Fehler beim Laden der Drucker', err);
        }
      }

      if (printerForm) {
        printerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          try {
            const res = await fetch('/api/printers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: prName.value.trim(),
                ip: prIp.value.trim(),
                serial: prSerial.value.trim(),
                access_token: prAccess.value.trim(),
                show_on_dashboard: !!prShow.checked
              })
            });
            if (!res.ok) throw new Error(await res.text());
            prName.value = '';
            prIp.value = '';
            prSerial.value = '';
            prAccess.value = '';
            prShow.checked = true;
            zeigeBenachrichtigung('Drucker gespeichert', 'blue');
            ladePrinter();
          } catch (err) {
            console.error('Fehler beim Speichern des Druckers', err);
            zeigeBenachrichtigung('Fehler beim Speichern', 'red');
          }
        });
        // Beim Start die Liste laden
        ladePrinter();
      }

      function zeigePopup(text, onConfirm) {
        const overlay = document.getElementById("popupOverlay");
        const popupText = document.getElementById("popupText");
        const popupConfirm = document.getElementById("popupConfirm");
        const popupCancel = document.getElementById("popupCancel");

        popupText.innerText = text;
        overlay.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");

        const confirmHandler = () => {
          overlay.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
          onConfirm();
          popupConfirm.removeEventListener("click", confirmHandler);
        };

        popupConfirm.addEventListener("click", confirmHandler);
        popupCancel.onclick = () => { overlay.classList.add("hidden"); document.body.classList.remove("overflow-hidden"); };
      }

      const uploadForm = document.getElementById("uploadForm");
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        const file = formData.get("file");
        if (!file || !file.name) {
          zeigeBenachrichtigung("Bitte ein Bild auswählen.", "red");
          return;
        }
        try {
          const response = await fetch("/upload-image/", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) {
            const error = await response.text();
            throw new Error(error);
          }
          zeigeBenachrichtigung("Bild erfolgreich hochgeladen!", "blue");
          uploadForm.reset();
          ladeBilder();
        } catch (err) {
          console.error("Fehler beim Hochladen:", err);
          zeigeBenachrichtigung("Fehler beim Hochladen des Bildes.", "red");
        }
      });

      // Bild-Vorschau anzeigen
      const bildInput = document.getElementById("bild");
      const vorschauContainer = document.getElementById("bildVorschauContainer");
      const vorschauBild = document.getElementById("bildVorschau");

      bildInput.addEventListener("change", () => {
        const file = bildInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            vorschauBild.src = reader.result;
            vorschauContainer.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          vorschauContainer.classList.add("hidden");
        }
      });
    // Modales Popup zum Eingeben der Typ-ID
    function zeigeTypPopup(onConfirm) {
      const overlay = document.getElementById("typPopupOverlay");
      const select = document.getElementById("typPopupSelect");
      const confirmBtn = document.getElementById("typPopupConfirm");
      const cancelBtn = document.getElementById("typPopupCancel");

      // Vorherige Optionen löschen
      select.innerHTML = `<option value="">-- Typ auswählen --</option>`;

      // Typen laden
      fetch("/typs/")
        .then((res) => res.json())
        .then((typen) => {
          typen.forEach((typ) => {
            const option = document.createElement("option");
            option.value = typ.id;
            option.textContent = `${typ.name} (${typ.material}, ${typ.farbe}, ${typ.durchmesser}mm)`;
            select.appendChild(option);
          });
        });

      overlay.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");

      const confirmHandler = () => {
        const typId = select.value;
        if (!typId) return;
        overlay.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
        onConfirm(typId);
        confirmBtn.removeEventListener("click", confirmHandler);
      };

      confirmBtn.addEventListener("click", confirmHandler);
      cancelBtn.onclick = () => { overlay.classList.add("hidden"); document.body.classList.remove("overflow-hidden"); };
    }

      if (["helper", "mod", "admin"].includes(benutzerRolle)) {
        // Bereiche beim Laden weiterhin versteckt lassen, keine .classList.remove("hidden")!
        // Token-Blöcke nur DOM hinzufügen, aber nicht sichtbar machen
        if (["mod", "admin"].includes(benutzerRolle)) {
          document.getElementById("tokenBlockContainer").appendChild(tokenBlock);
          document.getElementById("tokenUebersichtBlockContainer").appendChild(tokenUebersichtBlock);
          // Sichtbarkeit wird durch Menü gesteuert, nicht hier!
          // Nach dem Erzeugen des Tokenblocks: Rollen-Optionen beschränken
          const rolleSelect = tokenBlock.querySelector("#rolle");
          const erlaubteOptionen = benutzerRolle === "admin" ? ["user", "helper", "mod", "admin"] : ["user", "helper"];
          [...rolleSelect.options].forEach(opt => {
            if (opt.value && !erlaubteOptionen.includes(opt.value)) {
              opt.remove();
            }
          });
          ladeTokenTabelle();
          const tokenForm = document.getElementById("tokenForm");
          tokenForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const rolle = document.getElementById("rolle").value;
            if (!rolle) {
              zeigeBenachrichtigung("Bitte eine Rolle auswählen", "red");
              return;
            }
            const erlaubteRollen = benutzerRolle === "admin" ? ["user", "helper", "mod", "admin"] : ["user", "helper"];
            if (!erlaubteRollen.includes(rolle)) {
              zeigeBenachrichtigung("Du darfst nur Tokens für niedrigere Rollen erstellen.", "red");
              return;
            }
            try {
              const res = await fetch("/admin/create-token", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ rolle })
              });
              if (!res.ok) throw new Error(await res.text());
              const daten = await res.json();
              document.getElementById("generierterToken").textContent = daten.token;
              document.getElementById("tokenAnzeige").classList.remove("hidden");
              zeigeBenachrichtigung("Token erfolgreich erstellt.", "blue");
            } catch (err) {
              console.error("Token-Erstellung fehlgeschlagen", err);
              zeigeBenachrichtigung("Fehler beim Erstellen des Tokens.", "red");
            }
          });

          const verbrauchNavBlock = document.getElementById("verbrauchNavBlock");
          const verbrauchTabelleBody = document.getElementById("verbrauchTabelleBody");
          const verbrauchSum = document.getElementById("verbrauchSum");
          const verbrauchCount = document.getElementById("verbrauchCount");
          const verbrauchNeuLaden = document.getElementById("verbrauchNeuLaden");
          const einstellungsMenue = document.getElementById("einstellungsMenue");
          const verbrauchDateFormatter = new Intl.DateTimeFormat("de-DE", { dateStyle: "medium", timeStyle: "short" });
          const verbrauchNumberFormat = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 0, maximumFractionDigits: 2 });
          const verbrauchCountFormat = new Intl.NumberFormat("de-DE");
          let verbrauchGeladen = false;

          const formatVerbrauch = (value) => `${verbrauchNumberFormat.format(value ?? 0)} g`;
          const formatDatum = (value) => {
            if (!value) return "–";
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? "–" : verbrauchDateFormatter.format(date);
          };

          const baueVerbrauchszeile = (entry) => {
            const tr = document.createElement("tr");
            tr.className = "border-b align-top";

            const datumTd = document.createElement("td");
            datumTd.className = "px-4 py-2 whitespace-nowrap";
            datumTd.textContent = formatDatum(entry.datum);

            const infoTd = document.createElement("td");
            infoTd.className = "px-4 py-2";
            const nameDiv = document.createElement("div");
            nameDiv.className = "font-semibold text-white";
            const typLabel = entry.typ_name || (entry.typ_id != null ? `Typ #${entry.typ_id}` : "Unbekannter Typ");
            nameDiv.textContent = typLabel;
            const metaDiv = document.createElement("div");
            metaDiv.className = "text-xs text-gray-400 mt-1";
            const details = [];
            if (entry.material) details.push(entry.material);
            if (entry.farbe) details.push(entry.farbe);
            if (entry.durchmesser !== null && entry.durchmesser !== undefined) {
              details.push(`${entry.durchmesser} mm`);
            }
            const metaParts = [`Typ-ID: ${entry.typ_id ?? "–"}`];
            if (details.length) metaParts.push(details.join(" · "));
            metaDiv.textContent = metaParts.join(" · ");
            const logDiv = document.createElement("div");
            logDiv.className = "text-xs text-gray-500 mt-1";
            logDiv.textContent = `Log-ID: ${entry.id}`;
            infoTd.append(nameDiv, metaDiv, logDiv);

            const wertTd = document.createElement("td");
            wertTd.className = "px-4 py-2 font-semibold text-white whitespace-nowrap";
            wertTd.textContent = formatVerbrauch(entry.verbrauch_in_g);

            const actionTd = document.createElement("td");
            actionTd.className = "px-4 py-2 space-x-2 whitespace-nowrap";

            const editBtn = document.createElement("button");
            editBtn.textContent = "Anpassen";
            editBtn.className = "px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-500";
            editBtn.addEventListener("click", async () => {
              const eingabe = prompt("Neuer Verbrauch in Gramm:", String(entry.verbrauch_in_g));
              if (eingabe === null) return;
              const sanisiert = eingabe.replace(",", ".").trim();
              if (!sanisiert) {
                zeigeBenachrichtigung("Bitte einen Wert eingeben.", "red");
                return;
              }
              const wert = Number(sanisiert);
              if (!Number.isFinite(wert) || wert < 0) {
                zeigeBenachrichtigung("Ungültiger Verbrauchswert.", "red");
                return;
              }
              if (Math.abs(wert - entry.verbrauch_in_g) < 1e-6) {
                return;
              }
              try {
                const res = await fetch(`/admin/verbrauch/${entry.id}`, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ verbrauch_in_g: wert })
                });
                if (!res.ok) throw new Error(await res.text());
                zeigeBenachrichtigung("Verbrauch wurde aktualisiert.", "blue");
                verbrauchGeladen = false;
                ladeVerbrauchsdaten();
              } catch (err) {
                console.error("Fehler beim Aktualisieren des Verbrauchs:", err);
                zeigeBenachrichtigung("Fehler beim Aktualisieren.", "red");
              }
            });

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Löschen";
            deleteBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
            deleteBtn.addEventListener("click", () => {
              zeigePopup("Diesen Verbrauchseintrag wirklich löschen?", async () => {
                try {
                  const res = await fetch(`/admin/verbrauch/${entry.id}`, { method: "DELETE" });
                  if (!res.ok) throw new Error(await res.text());
                  zeigeBenachrichtigung("Verbrauchseintrag gelöscht.", "blue");
                  verbrauchGeladen = false;
                  ladeVerbrauchsdaten();
                } catch (err) {
                  console.error("Fehler beim Löschen des Verbrauchseintrags:", err);
                  zeigeBenachrichtigung("Fehler beim Löschen.", "red");
                }
              });
            });

            actionTd.append(editBtn, deleteBtn);
            tr.append(datumTd, infoTd, wertTd, actionTd);
            return tr;
          };

          const ladeVerbrauchsdaten = async () => {
            if (!verbrauchTabelleBody) return;
            verbrauchTabelleBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">Lade Daten…</td></tr>`;
            try {
              const res = await fetch("/admin/verbrauch");
              if (!res.ok) throw new Error(await res.text());
              const daten = await res.json();
              if (verbrauchSum) verbrauchSum.textContent = formatVerbrauch(daten.total_sum ?? 0);
              if (verbrauchCount) verbrauchCount.textContent = verbrauchCountFormat.format(daten.total_count ?? 0);
              verbrauchTabelleBody.innerHTML = "";
              if (!Array.isArray(daten.entries) || daten.entries.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="4" class="px-4 py-6 text-center text-gray-400">Keine Verbrauchseinträge vorhanden</td>`;
                verbrauchTabelleBody.appendChild(row);
              } else {
                daten.entries.forEach((entry) => {
                  verbrauchTabelleBody.appendChild(baueVerbrauchszeile(entry));
                });
              }
              verbrauchGeladen = true;
            } catch (err) {
              console.error("Fehler beim Laden der Verbrauchsdaten:", err);
              zeigeBenachrichtigung("Fehler beim Laden der Verbrauchsdaten.", "red");
              verbrauchTabelleBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-400">Fehler beim Laden</td></tr>`;
            }
          };

          const ensureVerbrauchsdaten = () => {
            if (!verbrauchGeladen) {
              ladeVerbrauchsdaten();
            }
          };

          if (verbrauchNavBlock) {
            verbrauchNavBlock.classList.remove("hidden");
          }
          if (verbrauchNeuLaden) {
            verbrauchNeuLaden.addEventListener("click", (event) => {
              event.preventDefault();
              ladeVerbrauchsdaten();
            });
          }
          if (einstellungsMenue) {
            einstellungsMenue.addEventListener("click", (event) => {
              if (event.target.dataset.ziel === "verbrauchVerwaltungBlock") {
                ensureVerbrauchsdaten();
              }
            });
          }
          ensureVerbrauchsdaten();

        }
      } else {
        const bilderVerwaltung = document.getElementById("bilderVerwaltung");
        if (bilderVerwaltung) bilderVerwaltung.remove();
        const vorhandeneBilderBlock = document.getElementById("vorhandeneBilderBlock");
        if (vorhandeneBilderBlock) vorhandeneBilderBlock.remove();
      }
  // Funktion zum Laden der Token-Tabelle
  async function ladeTokenTabelle() {
    try {
      const res = await fetch("/admin/tokens");
      const tokens = await res.json();
      const tbody = document.getElementById("tokenTabelleBody");
      tbody.innerHTML = "";
      tokens.forEach(t => {
        const row = document.createElement("tr");
        row.className = "border-b";
        // Token
        const tokenCell = document.createElement("td");
        tokenCell.className = "px-4 py-2 font-mono";
        tokenCell.textContent = t.token;
        // Rolle
        const rolleCell = document.createElement("td");
        rolleCell.className = "px-4 py-2";
        rolleCell.textContent = t.rolle;
        // Verwendet
        const verwendetCell = document.createElement("td");
        verwendetCell.className = "px-4 py-2";
        verwendetCell.textContent = t.verwendet ? "✅" : "❌";
        // Aktion
        const loeschBtn = document.createElement("button");
        loeschBtn.textContent = "Löschen";
        loeschBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
        loeschBtn.addEventListener("click", async () => {
          zeigePopup("Diesen Token wirklich löschen?", async () => {
            try {
              const res = await fetch(`/admin/token/${t.token}`, { method: "DELETE" });
              if (!res.ok) throw new Error(await res.text());
              zeigeBenachrichtigung("Token gelöscht.", "blue");
              ladeTokenTabelle();
            } catch (err) {
              console.error("Fehler beim Löschen des Tokens:", err);
              zeigeBenachrichtigung("Fehler beim Löschen des Tokens.", "red");
            }
          });
        });
        const aktionCell = document.createElement("td");
        aktionCell.className = "px-4 py-2";
        aktionCell.appendChild(loeschBtn);
        // Zeile zusammenbauen
        row.appendChild(tokenCell);
        row.appendChild(rolleCell);
        row.appendChild(verwendetCell);
        row.appendChild(aktionCell);
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error("Fehler beim Laden der Tokens:", err);
    }
  }
  // User-Tabelle laden und anzeigen
  // Modales Popup für Rollenbearbeitung
  function zeigeRollenPopup(username, aktuelleRolle, onConfirm) {
    const overlay = document.getElementById("rollePopupOverlay");
    const select = document.getElementById("rollePopupSelect");
    const confirmBtn = document.getElementById("rollePopupConfirm");
    const cancelBtn = document.getElementById("rollePopupCancel");

    select.value = aktuelleRolle;
    overlay.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");

    const confirmHandler = () => {
      const neueRolle = select.value;
      if (!neueRolle || neueRolle === aktuelleRolle) return;
      overlay.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
      onConfirm(neueRolle);
      confirmBtn.removeEventListener("click", confirmHandler);
    };

    confirmBtn.addEventListener("click", confirmHandler);
    cancelBtn.onclick = () => { overlay.classList.add("hidden"); document.body.classList.remove("overflow-hidden"); };
  }

  function formatDateTime(value) {
    if (!value) return "-";
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return value;
    return date.toLocaleString("de-DE", { dateStyle: "short", timeStyle: "short" });
  }

      async function ladeBenutzerTabelle() {
        try {
          const res = await fetch("/admin/users");
          if (!res.ok) throw new Error(await res.text());
          const users = await res.json();
          const tbody = document.getElementById("userTabelleBody");
          tbody.innerHTML = "";
          users.forEach(user => {
            const tr = document.createElement("tr");
            tr.className = "border-b";
            // Benutzername
            const nameTd = document.createElement("td");
            nameTd.className = "px-4 py-2";
            nameTd.textContent = user.username;
            // Rolle
            const rolleTd = document.createElement("td");
            rolleTd.className = "px-4 py-2";
            rolleTd.textContent = user.rolle;
            const erstelltTd = document.createElement("td");
            erstelltTd.className = "px-4 py-2";
            erstelltTd.textContent = formatDateTime(user.created_at);
            const lastSeenTd = document.createElement("td");
            lastSeenTd.className = "px-4 py-2";
            lastSeenTd.textContent = formatDateTime(user.last_seen);
            // Aktionen
            const aktionTd = document.createElement("td");
            aktionTd.className = "px-4 py-2 space-x-2";
            // Rollen-Logik für Aktionen
            const rollenReihenfolge = { user: 0, helper: 1, mod: 2, admin: 3 };
            const eigeneStufe = rollenReihenfolge[benutzerRolle];
            const zielStufe = rollenReihenfolge[user.rolle];

            if (
              (benutzerRolle === "admin") ||
              (benutzerRolle === "mod" && zielStufe < eigeneStufe)
            ) {
              // Button Rolle bearbeiten
              const rolleBtn = document.createElement("button");
              rolleBtn.textContent = "Rolle bearbeiten";
              rolleBtn.className = "px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600";
              rolleBtn.addEventListener("click", () => {
                zeigeRollenPopup(user.username, user.rolle, async (neueRolle) => {
                  try {
                    const res = await fetch(`/admin/user/${encodeURIComponent(user.username)}/rolle`, {
                      method: "PATCH",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ rolle: neueRolle })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    zeigeBenachrichtigung("Rolle geändert.", "blue");
                    ladeBenutzerTabelle();
                  } catch (err) {
                    zeigeBenachrichtigung("Fehler beim Ändern der Rolle.", "red");
                  }
                });
              });
              aktionTd.appendChild(rolleBtn);

              // Button Löschen
              const loeschBtn = document.createElement("button");
              loeschBtn.textContent = "Löschen";
              loeschBtn.className = "px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700";
              loeschBtn.addEventListener("click", () => {
                zeigePopup(`Benutzer ${user.username} wirklich löschen?`, async () => {
                  try {
                    const res = await fetch(`/admin/users/${encodeURIComponent(user.username)}`, { method: "DELETE" });
                    if (!res.ok) throw new Error(await res.text());
                    zeigeBenachrichtigung("Benutzer gelöscht.", "blue");
                    ladeBenutzerTabelle();
                  } catch (err) {
                    zeigeBenachrichtigung("Fehler beim Löschen des Benutzers.", "red");
                  }
                });
              });
              aktionTd.appendChild(loeschBtn);
            } else {
              aktionTd.textContent = "-";
            }

            tr.appendChild(nameTd);
            tr.appendChild(rolleTd);
            tr.appendChild(erstelltTd);
            tr.appendChild(lastSeenTd);
            tr.appendChild(aktionTd);
            tbody.appendChild(tr);
          });
        } catch (err) {
          const tbody = document.getElementById("userTabelleBody");
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-2 text-gray-200">Fehler beim Laden der Benutzerliste.</td></tr>`;
          }
        }
      }

  // User-Tabelle beim Laden anzeigen, wenn Rolle mod oder admin
  if (["mod", "admin"].includes(benutzerRolle)) {
    ladeBenutzerTabelle();
  }
});
  </script>
  <div id="popupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-700 rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p id="popupText" class="mb-4 text-sm text-gray-100">Bist du sicher?</p>
      <div class="flex justify-center gap-4">
        <button id="popupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="popupConfirm" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Ja, bestätigen</button>
      </div>
    </div>
  </div>
  <div id="typPopupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-700 rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p class="mb-2 text-sm text-gray-100">Wähle einen neuen Typ aus:</p>
      <select id="typPopupSelect" class="w-full mb-4 px-3 py-2 border border-gray-500 text-sm text-gray-100 bg-gray-600 focus:outline-none focus:ring">
        <option value="">-- Typ auswählen --</option>
      </select>
      <div class="flex justify-center gap-4">
        <button id="typPopupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="typPopupConfirm" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Typ ändern</button>
      </div>
    </div>
  </div>
  <div id="rollePopupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-700 rounded shadow-lg p-6 max-w-sm w-full text-center">
      <p class="mb-2 text-sm text-gray-100">Wähle eine neue Rolle:</p>
      <select id="rollePopupSelect" class="w-full mb-4 px-3 py-2 border border-gray-500 rounded text-sm text-gray-100 bg-gray-600 focus:outline-none focus:ring">
        <option value="">-- Rolle auswählen --</option>
        <option value="user">User</option>
        <option value="helper">Helper</option>
        <option value="mod">Mod</option>
        <option value="admin">Admin</option>
      </select>
      <div class="flex justify-center gap-4">
        <button id="rollePopupCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-sm">Abbrechen</button>
        <button id="rollePopupConfirm" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Rolle ändern</button>
      </div>
    </div>
  </div>
  <div id="benachrichtigung" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded shadow hidden z-50 text-sm"></div>
  </body>
</html>
