<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Spulendetails</title>
    <base href="/" />
    <link rel="stylesheet" href="/static/assets/style2.css">
    <meta name="theme-color" content="#222">
    <style>
      html {
        background-color: #222;
      }
      .restmenge-bar-wrapper {
          background-color: white;
      }

      .restmenge-bar {
          background-color: limegreen;
      }

      .restmenge-bar.in-printer {
        background-color: orange;
        width: 100% !important;
        position: relative;
      }

      .restmenge-bar.in-printer::after {
        content: "Im Drucker";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        color: white;
      }

      #toggle-in-printer {
        background-color: #444;
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        font-size: 0.95rem;
        font-weight: normal;
        cursor: pointer;
        margin-top: 12px;
      }

      #toggle-in-printer:hover {
        background-color: #555;
      }

      .spule-details {
          background: linear-gradient(135deg, rgba(40, 40, 40, 0.95), rgba(30, 30, 30, 0.95));
          border-radius: 20px;
          padding: 1.5em;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
          backdrop-filter: blur(5px);
          overflow: hidden;
      }

      .spulenbild {
        position: relative;
      }

      .download-qrcode {
        position: absolute;
        top: 5px;
        left: 5px;
        background-color: #444;
        padding: 8px 10px;
        border-radius: 8px;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .download-qrcode svg {
        fill: white;
        width: 20px;
        height: 20px;
      }

      .print-qrcode {
        position: absolute;
        left: 5px;
        bottom: 37px;
        background-color: #444;
        padding: 8px 10px;
        border-radius: 8px;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .print-qrcode svg {
        fill: white;
        width: 20px;
        height: 20px;
      }

      .download-qrcode span,
      .print-qrcode span {
        color: white;
        font-size: 0.85em;
        margin-left: 4px;
      }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(270deg, #111, #222, #333, #222, #111);
      background-size: 400% 400%;
      animation: animated-bg 20s linear infinite;
      z-index: -1;
      pointer-events: none;
    }

    @keyframes animated-bg {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 0%; }
      100% { background-position: 0% 0%; }
    }
      html {
        height: 100%;
      }

      body {
        min-height: 100%;
        position: relative;
        margin: 0;
        padding: 0;
        z-index: 0;
      }
    </style>
</head>
<body>
    <div class="logo">
        <a href="/"><img src="/static/assets/Fisys Logo.png" alt="Fisys Logo"></a>
    </div>

    <main>
        <div class="container">
            <h1 class="spulentitel">Spulendetails</h1>
            <div id="spule-details" class="spule-details">
                <div class="spulenbild">
                    <img id="spulenbild" src="" alt="Spulenbild">
                    <div class="restmenge-bar-wrapper">
                        <div class="restmenge-bar" id="restmenge-bar"></div>
                    </div>
                    <a class="download-qrcode" id="qrcode-download-link" href="#" download title="QR-Code herunterladen">
                      <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M5 20h14v-2H5v2zm7-18v12l4-4h-3V4h-2v6h-3l4 4z"/>
                      </svg>
                      <span>QR-Code</span>
                    </a>
                    <a class="print-qrcode" href="#" title="QR-Code drucken">
                      <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M19 8h-1V3H6v5H5c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-9c0-1.1-.9-2-2-2zM6 5h10v3H6V5zm13 14H5v-9h14v9z"/>
                      </svg>
                      <span>QR-Code drucken</span>
                    </a>
                </div>
                <div class="infos">
                    <p><span>ID:</span> <span id="spule-id"></span></p>
                    <p><span>Typ:</span> <span id="spule-typ"></span></p>
                    <p><span>Farbe:</span> <span id="spule-farbe"></span></p>
                    <p><span>Material:</span> <span id="spule-material"></span></p>
                    <p><span>Durchmesser:</span> <span id="spule-durchmesser"></span> mm</p>
                    <p><span>Gesamtmenge:</span> <span id="spule-gesamtmenge"></span> g</p>
                    <p><span>Restmenge:</span> <span id="spule-restmenge"></span> g</p>
                    <button id="toggle-in-printer">In Drucker setzen</button>
                </div>
            </div>
            <div class="spulendetail-action">
                <button id="zur-typseite">Weitere Spulen dieses Typs anzeigen</button>
            </div>
        </div>
    </main>

    <script>
        // Spulen-ID und Typ-ID aus Pfad lesen
        const pathParts = window.location.pathname.split('/');
        const typId = pathParts[2];
        const spuleId = pathParts[3].replace('id', '');

        // 1. Ganz oben im Skript:
        let aktuelleSpule = null;

        async function toggleInPrinter() {
            if (!aktuelleSpule) return;
            try {
                const res = await fetch(`/api/spule/${spuleId}/toggle_in_printer`, { method: 'PATCH' });
                if (!res.ok) {
                    const data = await res.json();
                    alert(data.detail || "Fehler beim Umschalten.");
                    return;
                }
                const data = await res.json();
                // 3. Innerhalb toggleInPrinter() nach erfolgreicher PATCH-Antwort:
                aktuelleSpule.in_printer = data.in_printer;
                const toggleButton = document.getElementById('toggle-in-printer');
                toggleButton.textContent = aktuelleSpule.in_printer ? "Aus Drucker entfernen" : "In Drucker setzen";

                const bar = document.getElementById('restmenge-bar');
                if (aktuelleSpule.in_printer) {
                    bar.classList.add('in-printer');
                    bar.style.width = '100%';
                } else {
                    bar.classList.remove('in-printer');
                    const prozent = Math.round((aktuelleSpule.restmenge / aktuelleSpule.gewicht) * 100);
                    bar.style.width = prozent + '%';
                }
            } catch (err) {
                console.error('Fehler beim Umschalten von in_printer:', err);
            }
        }

        async function ladeSpule() {
            try {
                const res = await fetch(`/api/typ/${typId}/id${spuleId}`);
                const spule = await res.json();

                // 2. In ladeSpule() nach const spule = await res.json();
                aktuelleSpule = spule;

                try {
                    const printerRes = await fetch(`/api/spule/${spuleId}/in_printer`);
                    const printerData = await printerRes.json();
                    aktuelleSpule.in_printer = printerData.in_printer;
                } catch (err) {
                    console.error('Fehler beim Abrufen von in_printer:', err);
                }

                document.getElementById('spulenbild').src = "/static/assets/images/" + spule.bild;
                document.getElementById('spulenbild').alt = spule.material;
                document.getElementById('spule-id').textContent = spule.id;
                document.getElementById('spule-typ').textContent = spule.typ;
                document.getElementById('spule-farbe').textContent = spule.farbe;
                document.getElementById('spule-material').textContent = spule.material;
                document.getElementById('spule-durchmesser').textContent = spule.durchmesser || '';
                document.getElementById('spule-gesamtmenge').textContent = spule.gewicht;
                document.getElementById('spule-restmenge').textContent = spule.restmenge;
                const prozent = Math.round((spule.restmenge / spule.gewicht) * 100);
                const bar = document.getElementById('restmenge-bar');
                bar.style.width = prozent + '%';

                if (aktuelleSpule.in_printer) {
                    bar.classList.add('in-printer');
                } else {
                    bar.classList.remove('in-printer');
                }

                const qrLink = document.getElementById('qrcode-download-link');
                qrLink.href = `/static/assets/images/qrcodes/qrcode_spule_id_${spule.id}.png`;

                // 5. Innerhalb ladeSpule() ganz unten:
                const toggleButton = document.getElementById('toggle-in-printer');
                toggleButton.textContent = aktuelleSpule.in_printer ? "Aus Drucker entfernen" : "In Drucker setzen";
                toggleButton.onclick = toggleInPrinter;

                document.getElementById('zur-typseite').onclick = () => {
                    window.location.href = `/typ/${typId}`;
                };
                // Rahmenfarbe dynamisch setzen
                const spulenCard = document.getElementById('spule-details');
                const farbenKlassen = [
                    'border-blau', 'border-rot', 'border-grau', 'border-magenta', 'border-pink',
                    'border-cyan', 'border-birke', 'border-gelb', 'border-schwarz', 'border-weiß',
                    'border-grün', 'border-orange', 'border-violett', 'border-silber', 'border-gold',
                    'border-kupfer', 'border-transparent', 'border-natur'
                ];
                spulenCard.classList.remove(...farbenKlassen);

                // Ähnliche Farben auf Basisfarben reduzieren
                const farbe = spule.farbe.toLowerCase().replace(/\s+/g, '');
                let farbschlüssel = '';
                if (farbe.includes('blau')) farbschlüssel = 'blau';
                else if (farbe.includes('rot')) farbschlüssel = 'rot';
                else if (farbe.includes('grau')) farbschlüssel = 'grau';
                else if (farbe.includes('magenta')) farbschlüssel = 'magenta';
                else if (farbe.includes('pink')) farbschlüssel = 'pink';
                else if (farbe.includes('cyan')) farbschlüssel = 'cyan';
                else if (farbe.includes('birke')) farbschlüssel = 'birke';
                else if (farbe.includes('gelb')) farbschlüssel = 'gelb';
                else if (farbe.includes('schwarz')) farbschlüssel = 'schwarz';
                else if (farbe.includes('weiß') || farbe.includes('weiss')) farbschlüssel = 'weiß';
                else if (farbe.includes('grün')) farbschlüssel = 'grün';
                else if (farbe.includes('orange')) farbschlüssel = 'orange';
                else if (farbe.includes('violett')) farbschlüssel = 'violett';
                else if (farbe.includes('silber')) farbschlüssel = 'silber';
                else if (farbe.includes('gold')) farbschlüssel = 'gold';
                else if (farbe.includes('kupfer')) farbschlüssel = 'kupfer';
                else if (farbe.includes('transparent')) farbschlüssel = 'transparent';
                else if (farbe.includes('natur')) farbschlüssel = 'natur';
                else if (farbe.includes("braun")) farbschlüssel = "braun";

                const farbenMap = {
                    'blau': 'border-blau',
                    'rot': 'border-rot',
                    'grau': 'border-grau',
                    'magenta': 'border-magenta',
                    'pink': 'border-pink',
                    'cyan': 'border-cyan',
                    'birke': 'border-birke',
                    'gelb': 'border-gelb',
                    'schwarz': 'border-schwarz',
                    'weiß': 'border-weiß',
                    'grün': 'border-grün',
                    'orange': 'border-orange',
                    'violett': 'border-violett',
                    'silber': 'border-silber',
                    'gold': 'border-gold',
                    'kupfer': 'border-kupfer',
                    'transparent': 'border-transparent',
                    'natur': 'border-natur',
                    'braun': 'border-braun'
                };
                if (farbenMap[farbschlüssel]) {
                    spulenCard.classList.add(farbenMap[farbschlüssel]);
                }
            } catch (err) {
                console.error('Fehler beim Laden der Spule:', err);
            }
        }

        ladeSpule();
    </script>
</body>
</html>