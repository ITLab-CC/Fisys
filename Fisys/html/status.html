<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Status | Fisys</title>
  <link rel="stylesheet" href="/static/assets/css/tailwind.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
  <style>
    .scroll-card,
    .chart-card {
      display: flex;
      flex-direction: column;
      border-radius: 0.75rem;
      background-color: rgba(55, 65, 81, 1);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
    }
    .scroll-card {
      min-height: 22rem;
    }
    .scroll-card.scroll-card--tall {
      min-height: 26rem;
    }
    .scroll-card__body {
      flex: 1 1 auto;
      overflow-y: auto;
      padding-right: 0.25rem;
      margin-right: -0.25rem;
    }
    .chart-card {
      min-height: 24rem;
      padding-bottom: 0.75rem;
    }
    .chart-area {
      flex: 1 1 auto;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chart-area canvas {
      width: 100% !important;
      height: 100% !important;
      min-height: 220px;
    }
    @keyframes page-spinner {
      to {
        transform: rotate(360deg);
      }
    }
    #page-loading-overlay {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 16rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: rgba(15, 23, 42, 0.95);
      z-index: 70;
      transition: opacity 0.35s ease;
    }
    #page-loading-overlay.page-loading-overlay--hidden {
      opacity: 0;
      pointer-events: none;
    }
    .page-loading-spinner {
      width: 3.5rem;
      height: 3.5rem;
      border-radius: 9999px;
      border: 4px solid rgba(255, 255, 255, 0.15);
      border-top-color: #38bdf8;
      animation: page-spinner 0.9s linear infinite;
    }
    @media (max-width: 1024px) {
      #page-loading-overlay {
        left: 0;
      }
    }
  </style>
</head>
<body class="bg-gray-800 min-h-screen flex">
  <div id="page-loading-overlay" role="status" aria-live="polite">
    <div class="page-loading-spinner" aria-hidden="true"></div>
    <p class="text-gray-200 text-sm mt-4">Lade Inhalte …</p>
  </div>

  <!-- Sidebar -->
  <aside class="w-64 bg-[#0f172a] text-white flex flex-col justify-between fixed h-full">
    <div>
      <div class="pt-1 pb-1">
        <img src="/static/assets/Fisys Logo.png" alt="Fisys Logo" class="h-20 mx-auto" />
      </div>
      <nav class="px-4 space-y-2">
        <a href="/" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Dashboard</a>
        <a href="/spulen.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Spulen</a>
        <a href="/filamentseite.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Filamenttypen</a>
        <hr class="my-2 border-gray-700" />
        <a href="/status" class="block px-4 py-2 rounded bg-gray-800 font-semibold text-white">Status</a>
        <a href="/einstellungen.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Einstellungen</a>
      </nav>
    </div>
    <div class="mt-auto">
      <div class="px-4 pb-2" id="user-info-container">
        <!-- Wird per JS geladen -->
      </div>
      <div class="p-4 text-xs text-center text-gray-400">© 2025 Fisys</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col ml-64">
    <header class="bg-gray-800 px-10 pt-10 pb-6">
      <h1 class="text-3xl text-white font-bold">Status</h1>
      <p class="text-sm text-gray-200 mt-1">System- und Druckerstatus im Überblick</p>
    </header>

    <section class="flex-1 pt-4 px-10 pb-10">
      <div class="grid gap-6 grid-cols-1 md:grid-cols-2 xl:grid-cols-3">

        <!-- Fast leere oder leere Typen -->
        <div class="scroll-card scroll-card--tall p-6 text-gray-100">
          <h2 class="text-lg font-semibold mb-4 border-b border-gray-600 pb-2">Fast leere oder leere Typen</h2>
          <ul id="low-stock-list" class="scroll-card__body space-y-3 text-sm text-white">
            <li class="text-white">Lade Daten...</li>
          </ul>
        </div>

        <!-- Meistgenutzte Filamente -->
        <div class="scroll-card p-6 text-gray-100">
          <h2 class="text-lg font-semibold mb-4 border-b border-gray-600 pb-2">Meistgenutzte Filamente</h2>
          <ul id="top-filaments-list" class="scroll-card__body space-y-3 text-sm text-white">
            <li class="text-white">Lade Daten...</li>
          </ul>
        </div>

        <!-- Verbrauch pro Typ -->
        <div class="scroll-card scroll-card--tall p-6 text-gray-100">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4 border-b border-gray-600 pb-2">
            <h2 class="text-lg font-semibold">
              Verbrauch pro Typ <span id="usage-period-label" class="text-sm text-gray-300">(diese Woche)</span>
            </h2>
            <div class="inline-flex items-center gap-1 bg-gray-800 p-1 rounded-md">
              <button type="button" data-usage-period="day" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">Tag</button>
              <button type="button" data-usage-period="week" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">Woche</button>
              <button type="button" data-usage-period="month" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">Monat</button>
            </div>
          </div>
          <ul id="usage-list" class="scroll-card__body space-y-3 text-sm text-white">
            <li class="text-white">Lade Daten...</li>
          </ul>
        </div>

        <!-- Gesamtverbrauch -->
        <div class="chart-card p-6 text-gray-100 gap-4">
          <div class="flex flex-wrap items-center justify-between gap-3 border-b border-gray-600 pb-2">
            <h2 class="text-lg font-semibold">
              Gesamtverbrauch
              <span id="consumption-days-label" class="text-sm text-gray-300">(30 Tage)</span>
            </h2>
            <div class="inline-flex items-center gap-1 bg-gray-800 p-1 rounded-md">
              <button type="button" data-consumption-days="7" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">7T</button>
              <button type="button" data-consumption-days="30" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">30T</button>
              <button type="button" data-consumption-days="90" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">90T</button>
            </div>
          </div>
          <div class="chart-area">
            <canvas id="consumption-trend-chart"></canvas>
            <p id="consumption-trend-empty" class="absolute inset-0 flex items-center justify-center text-sm text-gray-200 text-center hidden">Keine Verbrauchsdaten für diesen Zeitraum.</p>
          </div>
        </div>

        <!-- Farbnutzung -->
        <div class="chart-card p-6 text-gray-100 gap-4">
          <div class="flex flex-wrap items-center justify-between gap-3 border-b border-gray-600 pb-2">
            <h2 class="text-lg font-semibold">
              Farbnutzung
              <span id="color-usage-period-label" class="text-sm text-gray-300">(dieser Monat)</span>
            </h2>
            <div class="inline-flex items-center gap-1 bg-gray-800 p-1 rounded-md">
              <button type="button" data-color-period="month" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">Monat</button>
              <button type="button" data-color-period="year" class="px-2 py-1 text-xs font-semibold rounded bg-gray-700 text-gray-200 hover:bg-gray-600 transition">Jahr</button>
            </div>
          </div>
          <div class="chart-area">
            <canvas id="color-usage-chart"></canvas>
            <p id="color-usage-empty" class="absolute inset-0 flex items-center justify-center text-sm text-gray-200 text-center hidden">Keine Verbrauchsdaten für diesen Zeitraum.</p>
          </div>
        </div>

      </div>
    </section>

    <script>
const pageLoadingOverlay = document.getElementById("page-loading-overlay");

function hidePageLoadingOverlay() {
  if (!pageLoadingOverlay || pageLoadingOverlay.dataset.dismissed === "1") {
    return;
  }
  pageLoadingOverlay.dataset.dismissed = "1";
  pageLoadingOverlay.classList.add("page-loading-overlay--hidden");
  setTimeout(() => {
    pageLoadingOverlay.remove();
  }, 400);
}

async function loadUserInfo() {
  const container = document.getElementById("user-info-container");
  if (!container) return;
  try {
    const res = await fetch("/api/userinfo");
    if (res.ok) {
      const user = await res.json();
      container.innerHTML = `
  <form id="logoutForm" class="flex flex-col items-center">
    <span class="text-sm text-gray-300 mb-1">Angemeldet als ${user.username}</span>
    <button type="submit" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition w-full">Logout</button>
  </form>
`;
      const logoutForm = container.querySelector("#logoutForm");
      if (logoutForm) {
        logoutForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          await fetch("/logout", { method: "POST" });
          window.location.href = "/login";
        });
      }
    } else {
      container.innerHTML = `
        <a href="/login" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition">Login</a>
      `;
    }
  } catch {
    container.innerHTML = `
      <a href="/login" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition">Login</a>
    `;
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  try {
  const createListItem = (id, name, extra, details, statusColor = "bg-gray-50", material = "", farbe = "", durchmesser = "") => `
  <li class="${statusColor} p-0 rounded border">
    <a href="/spulen.html?typ_id=${id}" class="flex items-center justify-between p-3 rounded hover:bg-gray-500 transition block" aria-label="Spulen von Typ ${name} ansehen">
      <div>
        <div class="font-medium">${name}</div>
        <div class="text-xs text-gray-200">
          Typ-ID: ${id}
          ${material ? " • Material: " + material : ""}
          ${farbe ? " • Farbe: " + farbe : ""}
          ${durchmesser ? " • " + durchmesser + "mm" : ""}
          ${details ? " • " + details : ""}
        </div>
      </div>
      ${extra ? `<div class="text-right text-sm text-gray-200">${extra}</div>` : ""}
    </a>
  </li>
`;

  // Fast leere oder leere Typen – aus /fastleere_data
  try {
    const res = await fetch("/fastleere_data");
    const items = res.ok ? await res.json() : [];

    items.sort((a, b) => (a.status === "leer" ? 0 : 1) - (b.status === "leer" ? 0 : 1));

    const lowStockList = document.getElementById("low-stock-list");
    lowStockList.innerHTML = items.length
      ? items.map(t => {
          let color = "bg-gray-600";
          if (t.status === "leer") color = "border-red-500 bg-gray-600";
          else if (t.status === "fastleer") color = "border-orange-500 bg-gray-600";

          const statusText = t.status === "leer" ? "Leer" : (t.status === "fastleer" ? "Fast leer" : "");
          let detailsText = "";
          if (t.spulen_anzahl !== undefined && t.spulen_anzahl !== null) {
            detailsText += `Spulen: ${t.spulen_anzahl}`;
          }
          if (t.restmenge !== undefined && t.restmenge !== null) {
            if (detailsText.length > 0) detailsText += " • ";
            detailsText += `Rest: ${t.restmenge}g`;
          }

          return createListItem(
            t.id,
            t.name,
            statusText,              // extra rechts
            detailsText,            // Detailszeile mit Spulenanzahl und Restmenge
            color,
            t.material || "",
            t.farbe || "",
            t.durchmesser || ""
          );
        }).join("")
      : "<li class='text-gray-400'>Keine fast leeren Typen</li>";
  } catch {
    const lowStockList = document.getElementById("low-stock-list");
    lowStockList.innerHTML = "<li class='text-white'>Fehler beim Laden</li>";
  }

  // Meistgenutzte Filamente
  const topFilamentsRes = await fetch("/api/status/top_filaments");
  const topFilaments = await topFilamentsRes.json();
  const topFilamentsList = document.getElementById("top-filaments-list");
  topFilamentsList.innerHTML = topFilaments.length
    ? topFilaments.map(f => createListItem(
        f.id,
        f.name,
        `${f.verbrauch}g gesamt`,
        null,
        "bg-gray-600",
        f.material || "",
        f.farbe || "",
        f.durchmesser || ""
      )).join("")
    : "<li class='text-white'>Keine Verbrauchsdaten</li>";

  // Verbrauch pro Typ mit auswählbarem Zeitraum
  const usageList = document.getElementById("usage-list");
  const usagePeriodLabel = document.getElementById("usage-period-label");
  const usageButtons = document.querySelectorAll("[data-usage-period]");
  const usagePeriodLabelMap = {
    day: "heute",
    week: "diese Woche",
    month: "dieser Monat",
  };
  const activeButtonClasses = ["bg-blue-600", "text-white"];
  const inactiveButtonClasses = ["bg-gray-700", "text-gray-200"];
  let currentUsagePeriod = "week";

  function updateUsageButtons() {
    usageButtons.forEach(btn => {
      const isActive = btn.dataset.usagePeriod === currentUsagePeriod;
      activeButtonClasses.forEach(cls => btn.classList.toggle(cls, isActive));
      inactiveButtonClasses.forEach(cls => btn.classList.toggle(cls, !isActive));
    });
  }

  async function loadUsage(period) {
    const normalized = (period || "week").toLowerCase();
    if (!(normalized in usagePeriodLabelMap)) {
      return loadUsage("week");
    }

    currentUsagePeriod = normalized;
    updateUsageButtons();
    usagePeriodLabel.textContent = `(${usagePeriodLabelMap[currentUsagePeriod]})`;
    usageList.innerHTML = "<li class='text-white'>Lade Daten...</li>";

    try {
      const res = await fetch(`/api/status/usage?period=${currentUsagePeriod}`);
      if (!res.ok) throw new Error(`Antwortstatus ${res.status}`);
      const daten = await res.json();
      usageList.innerHTML = daten.length
        ? daten.map(u => `
              <li class="p-3 rounded border border-blue-500 bg-gray-600">
                <div class="flex justify-between">
                  <div>
                    <div class="font-medium">${u.name}</div>
                    <div class="text-xs text-gray-200">
                      Typ-ID: ${u.id}
                      ${u.material ? " • Material: " + u.material : ""}
                      ${u.farbe ? " • Farbe: " + u.farbe : ""}
                      ${u.durchmesser ? " • " + u.durchmesser + "mm" : ""}
                    </div>
                  </div>
                  <div class="text-sm text-gray-200">${u.verbrauch}g</div>
                </div>
              </li>`).join("")
        : "<li class='text-white'>Keine Daten für diesen Zeitraum</li>";
    } catch (err) {
      console.error("Fehler beim Laden der Verbrauchsdaten:", err);
      usageList.innerHTML = "<li class='text-white'>Fehler beim Laden</li>";
    }
  }

  usageButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.dataset.usagePeriod && btn.dataset.usagePeriod !== currentUsagePeriod) {
        loadUsage(btn.dataset.usagePeriod);
      }
    });
  });

  const chartIsAvailable = typeof window.Chart !== "undefined";
  if (chartIsAvailable) {
    Chart.defaults.color = "#e2e8f0";
    Chart.defaults.borderColor = "rgba(148, 163, 184, 0.25)";
    if (Chart.defaults.font) {
      Chart.defaults.font.family = "'Inter', 'system-ui', sans-serif";
    }
  }

  const consumptionCanvas = document.getElementById("consumption-trend-chart");
  const consumptionEmpty = document.getElementById("consumption-trend-empty");
  const consumptionButtons = document.querySelectorAll("[data-consumption-days]");
  const consumptionDaysLabel = document.getElementById("consumption-days-label");
  const consumptionDaysLabelMap = {
    7: "7 Tage",
    30: "30 Tage",
    90: "90 Tage",
  };
  let currentConsumptionDays = 30;
  let consumptionChart = null;

  function updateConsumptionButtons() {
    consumptionButtons.forEach(btn => {
      const days = Number(btn.dataset.consumptionDays);
      const isActive = days === currentConsumptionDays;
      activeButtonClasses.forEach(cls => btn.classList.toggle(cls, isActive));
      inactiveButtonClasses.forEach(cls => btn.classList.toggle(cls, !isActive));
    });
  }

  function formatDateLabel(dateString) {
    if (typeof dateString !== "string") return dateString;
    const parts = dateString.split("-");
    if (parts.length === 3) {
      const [year, month, day] = parts;
      return `${day}.${month}.${year.slice(-2)}`;
    }
    return dateString;
  }

  async function loadConsumptionTrend(days) {
    const numericDays = Number(days);
    const normalized = Number.isFinite(numericDays) && numericDays > 0 ? numericDays : 30;
    currentConsumptionDays = normalized;
    updateConsumptionButtons();
    if (consumptionDaysLabel) {
      const label = consumptionDaysLabelMap[normalized] || `${normalized} Tage`;
      consumptionDaysLabel.textContent = `(${label})`;
    }

    if (!chartIsAvailable || !consumptionCanvas) {
      if (consumptionEmpty) {
        const message = chartIsAvailable ? "Keine Verbrauchsdaten für diesen Zeitraum." : "Diagrammbibliothek konnte nicht geladen werden.";
        consumptionEmpty.textContent = message;
        consumptionEmpty.classList.remove("hidden");
      }
      return;
    }

    consumptionEmpty.classList.add("hidden");
    consumptionCanvas.classList.remove("hidden");

    try {
      const res = await fetch(`/api/status/consumption_trend?days=${normalized}`);
      if (!res.ok) {
        throw new Error(`Antwortstatus ${res.status}`);
      }
      const daten = await res.json();
      const labels = [];
      const dailyValues = [];
      daten.forEach(entry => {
        labels.push(formatDateLabel(entry.date));
        dailyValues.push(Number(entry.verbrauch) || 0);
      });
      const hasData = dailyValues.some(v => v > 0);

      const cumulativeValues = [];
      dailyValues.reduce((sum, value, index) => {
        const next = sum + value;
        cumulativeValues[index] = next;
        return next;
      }, 0);

      if (!hasData) {
        if (consumptionChart) {
          consumptionChart.destroy();
          consumptionChart = null;
        }
        consumptionCanvas.classList.add("hidden");
        if (consumptionEmpty) {
          consumptionEmpty.textContent = "Keine Verbrauchsdaten für diesen Zeitraum.";
          consumptionEmpty.classList.remove("hidden");
        }
        return;
      }

      if (consumptionChart) {
        consumptionChart.destroy();
      }
      consumptionChart = new Chart(consumptionCanvas, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Verbrauch (g)",
              data: cumulativeValues,
              tension: 0.1,
              fill: false,
              borderColor: "#38bdf8",
              backgroundColor: "rgba(56, 189, 248, 0.3)",
              pointRadius: 0,
              pointHoverRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => `${value} g`,
              },
              grid: {
                color: "rgba(148, 163, 184, 0.25)",
              },
            },
            x: {
              grid: {
                color: "rgba(148, 163, 184, 0.15)",
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              intersect: false,
              callbacks: {
                label: context => {
                  const cumulative = context.parsed.y || 0;
                  const daily = dailyValues[context.dataIndex] || 0;
                  return [
                    `Gesamt: ${cumulative.toLocaleString("de-DE")} g`,
                    `Tag: ${daily.toLocaleString("de-DE")} g`,
                  ];
                },
              },
            },
          },
        },
      });
    } catch (error) {
      console.error("Fehler beim Laden des Verbrauchstrends:", error);
      if (consumptionChart) {
        consumptionChart.destroy();
        consumptionChart = null;
      }
      consumptionCanvas.classList.add("hidden");
      if (consumptionEmpty) {
        consumptionEmpty.textContent = "Fehler beim Laden der Verbrauchsdaten.";
        consumptionEmpty.classList.remove("hidden");
      }
    }
  }

  consumptionButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const days = Number(btn.dataset.consumptionDays);
      if (days && days !== currentConsumptionDays) {
        loadConsumptionTrend(days);
      }
    });
  });

  const colorCanvas = document.getElementById("color-usage-chart");
  const colorEmpty = document.getElementById("color-usage-empty");
  const colorButtons = document.querySelectorAll("[data-color-period]");
  const colorPeriodLabel = document.getElementById("color-usage-period-label");
  const colorPeriodLabelMap = {
    month: "dieser Monat",
    year: "dieses Jahr",
  };
  const fallbackPalette = [
    "#38bdf8",
    "#f472b6",
    "#f97316",
    "#a855f7",
    "#22d3ee",
    "#84cc16",
    "#facc15",
    "#14b8a6",
    "#ef4444",
    "#c084fc",
    "#fb7185",
  ];
  let currentColorPeriod = "month";
  let colorChart = null;

  const colorNameMap = {
    "schwarz": "#111827",
    "weiß": "#f9fafb",
    "weiss": "#f9fafb",
    "grau": "#6b7280",
    "silber": "#9ca3af",
    "anthrazit": "#1f2937",
    "rot": "#ef4444",
    "grün": "#22c55e",
    "gruen": "#22c55e",
    "blau": "#3b82f6",
    "hellblau": "#60a5fa",
    "dunkelblau": "#1d4ed8",
    "gelb": "#facc15",
    "orange": "#f97316",
    "lila": "#a855f7",
    "violett": "#8b5cf6",
    "pink": "#f472b6",
    "rosa": "#fbcfe8",
    "magenta": "#db2777",
    "cyan": "#22d3ee",
    "türkis": "#14b8a6",
    "tuerkis": "#14b8a6",
    "braun": "#92400e",
    "beige": "#f5e6c8",
    "gold": "#d97706",
    "kupfer": "#b45309",
    "birke": "#d6ba8c",
    "transparent": "rgba(148, 163, 184, 0.35)",
  };

  function pickColorForLabel(label, fallbackIndex) {
    if (!label) {
      return fallbackPalette[fallbackIndex % fallbackPalette.length];
    }
    const raw = String(label).trim();
    if (!raw) {
      return fallbackPalette[fallbackIndex % fallbackPalette.length];
    }
    if (/^#?[0-9a-fA-F]{3,8}$/.test(raw)) {
      return raw.startsWith("#") ? raw : `#${raw}`;
    }
    const lower = raw.toLowerCase();
    if (colorNameMap[lower]) {
      return colorNameMap[lower];
    }
    const partialMatch = Object.keys(colorNameMap).find(name => lower.includes(name));
    if (partialMatch) {
      return colorNameMap[partialMatch];
    }
    const testEl = document.createElement("span");
    testEl.style.color = raw;
    if (testEl.style.color) {
      return raw;
    }
    return fallbackPalette[fallbackIndex % fallbackPalette.length];
  }

  function updateColorButtons() {
    colorButtons.forEach(btn => {
      const isActive = (btn.dataset.colorPeriod || "").toLowerCase() === currentColorPeriod;
      activeButtonClasses.forEach(cls => btn.classList.toggle(cls, isActive));
      inactiveButtonClasses.forEach(cls => btn.classList.toggle(cls, !isActive));
    });
  }

  async function loadColorUsage(period) {
    const normalized = (period || "month").toLowerCase();
    if (!(normalized in colorPeriodLabelMap)) {
      return loadColorUsage("month");
    }

    currentColorPeriod = normalized;
    updateColorButtons();
    if (colorPeriodLabel) {
      colorPeriodLabel.textContent = `(${colorPeriodLabelMap[currentColorPeriod]})`;
    }

    if (!chartIsAvailable || !colorCanvas) {
      if (colorEmpty) {
        const message = chartIsAvailable ? "Keine Verbrauchsdaten für diesen Zeitraum." : "Diagrammbibliothek konnte nicht geladen werden.";
        colorEmpty.textContent = message;
        colorEmpty.classList.remove("hidden");
      }
      return;
    }

    colorEmpty.classList.add("hidden");
    colorCanvas.classList.remove("hidden");

    try {
      const res = await fetch(`/api/status/color_usage?period=${currentColorPeriod}`);
      if (!res.ok) {
        throw new Error(`Antwortstatus ${res.status}`);
      }
      const daten = await res.json();
      const labels = [];
      const values = [];
      daten.forEach(entry => {
        labels.push(entry.farbe || "Unbekannt");
        values.push(Number(entry.verbrauch) || 0);
      });
      const total = values.reduce((sum, v) => sum + v, 0);
      const hasData = total > 0;

      if (!hasData) {
        if (colorChart) {
          colorChart.destroy();
          colorChart = null;
        }
        colorCanvas.classList.add("hidden");
        if (colorEmpty) {
          colorEmpty.textContent = "Keine Verbrauchsdaten für diesen Zeitraum.";
          colorEmpty.classList.remove("hidden");
        }
        return;
      }

      const backgroundColors = labels.map((label, index) => pickColorForLabel(label, index));

      if (colorChart) {
        colorChart.destroy();
      }

      colorChart = new Chart(colorCanvas, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              label: "Verbrauch nach Farbe",
              data: values,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors.map(color => color.startsWith("rgba") ? color : color),
              borderWidth: 1.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              callbacks: {
                label: context => {
                  const label = context.label || "Unbekannt";
                  const value = context.parsed || 0;
                  const percent = total ? ((value / total) * 100).toFixed(1) : "0.0";
                  return `${label}: ${value.toLocaleString("de-DE")} g (${percent}%)`;
                },
              },
            },
          },
        },
      });
    } catch (error) {
      console.error("Fehler beim Laden der Farbnutzungsdaten:", error);
      if (colorChart) {
        colorChart.destroy();
        colorChart = null;
      }
      colorCanvas.classList.add("hidden");
      if (colorEmpty) {
        colorEmpty.textContent = "Fehler beim Laden der Verbrauchsdaten.";
        colorEmpty.classList.remove("hidden");
      }
    }
  }

  colorButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const period = (btn.dataset.colorPeriod || "").toLowerCase();
      if (period && period !== currentColorPeriod) {
        loadColorUsage(period);
      }
    });
  });

  updateConsumptionButtons();
  updateColorButtons();

  if (chartIsAvailable) {
    await loadConsumptionTrend(currentConsumptionDays);
    await loadColorUsage(currentColorPeriod);
  } else {
    if (consumptionEmpty) {
      consumptionEmpty.textContent = "Diagramme konnten nicht geladen werden.";
      consumptionEmpty.classList.remove("hidden");
    }
    if (colorEmpty) {
      colorEmpty.textContent = "Diagramme konnten nicht geladen werden.";
      colorEmpty.classList.remove("hidden");
    }
  }

  await loadUsage(currentUsagePeriod);
  } catch (error) {
    console.error("Fehler beim Laden der Statusseite:", error);
  } finally {
    try {
      await loadUserInfo();
    } catch (userInfoError) {
      console.error("Fehler beim Laden der Benutzerinfos:", userInfoError);
    }
    hidePageLoadingOverlay();
  }
});
    </script>
  </main>

</body>
</html>
