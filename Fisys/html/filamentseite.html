<!DOCTYPE html>
<html lang="de">
<head>
  
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#222">
  <title>Fisys Produktdetails</title>
  
  <link rel="stylesheet" type="text/css" href="/static/assets/style.css" >

  <style>
    html {
      background-color: #222;
    }
    html {
      height: 100%;
    }

    body {
      min-height: 100%;
      position: relative;
      margin: 0;
      padding: 0;
      z-index: 0;
    }
    .popup-buttons button {
      font-size: 1rem;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 8px;
    }

    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 1em;
    }

    .popup-buttons button#confirm-print {
      background-color: #007b5e; /* dunkles Türkisgrün passend zur Website */
      color: white;
    }

    .popup-buttons button.cancel-print {
      background-color: #b80028; /* dunkles, warmes Rot */
      color: white;
    }
    .blurred::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      backdrop-filter: blur(5px);
      z-index: 10;
    }

    .blur-popup {
      z-index: 100;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e1e1e;
      padding: 1em;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .restmenge-bar.in-printer {
      background-color: orange !important;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
    }

    .download-qrcode {
      position: absolute;
      top: 8px;
      left: 5px;
      background-color: #444;
      padding: 6px;
      border-radius: 8px;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .download-qrcode svg {
      fill: white;
      width: 18px;
      height: 18px;
    }

    .download-qrcode span {
      color: white;
      font-size: 0.75em;
      margin-left: 4px;
    }

    .print-qrcode {
      position: absolute;
      left: 5px;
      bottom: 8px;
      background-color: #444;
      padding: 6px;
      border-radius: 8px;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .print-qrcode svg {
      fill: white;
      width: 18px;
      height: 18px;
    }

    .print-qrcode span {
      color: white;
      font-size: 0.75em;
      margin-left: 4px;
    }

    .spulenbild-wrapper {
      position: relative;
    }

    .verpackt-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: red;
      color: white;
      padding: 6px 12px;
      font-weight: bold;
      border-radius: 4px;
      font-size: 1em;
      z-index: 20;
      pointer-events: none;
    }

    .spule-card {
      cursor: pointer;
    }

    .popup-content {
      background: #2c2c2c;
      color: #f0f0f0;
      font-family: "Helvetica Neue", sans-serif;
      border-radius: 10px;
      padding: 20px 30px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      min-width: 300px;
      max-width: 90vw;
    }

    .popup-content h3 {
      font-size: 1.5em;
      margin-bottom: 0.5em;
      color: #ffffff;
      text-align: center;
    }

    .popup-content p {
      font-size: 1em;
      margin-bottom: 1em;
      color: #dddddd;
      text-align: center;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(270deg, #111, #222, #333, #222, #111);
      background-size: 400% 400%;
      animation: animated-bg 20s linear infinite;
      z-index: -1;
      pointer-events: none;
    }

    @keyframes animated-bg {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 0%; }
      100% { background-position: 0% 0%; }
    }
  </style>
</head>

<body>


  <div class="logo">
    <a href="/"><img src="/static/assets/Fisys Logo.png" alt="Fisys Logo"></a>
  </div>

    <div class="center-container">
  
  <div id="typ-details">
    <h1 id="filament-title">[Filamenttyp]</h1>
    <p><strong>Material:</strong> <span id="typ-material"></span></p>
    <p><strong>Farbe:</strong> <span id="typ-farbe"></span></p>
    <p><strong>Durchmesser:</strong> <span id="typ-durchmesser"></span> mm</p>
    <p><strong>Hersteller:</strong> <span id="typ-hersteller"></span></p>
    <p><strong>Leergewicht:</strong> <span id="typ-leergewicht"></span> g</p>
  </div>

  <div id="spulen-container" class="spulen-grid">
    <template id="spule-template">
      <div class="spule-card">
        <div class="spulenbild-wrapper">
          <div class="verpackt-label" style="display: none;">VERPACKT</div>
          <a class="download-qrcode" href="" download title="QR-Code herunterladen">
            <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18">
              <path d="M0 0h24v24H0z" fill="none"/>
              <path d="M5 20h14v-2H5v2zm7-18v12l4-4h-3V4h-2v6h-3l4 4z"/>
            </svg>
            <span>QR-Code</span>
          </a>
          <img src="" alt="Spulenbild">
          <button class="bearbeiten-button" data-id="" title="Bearbeiten">
            <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18" fill="#ffffff">
              <path d="M0 0h24v24H0z" fill="none"/>
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
            </svg>
          </button>
          <a class="print-qrcode" href="#" title="QR-Code drucken">
            <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18">
              <path d="M0 0h24v24H0z" fill="none"/>
              <path d="M19 8h-1V3H6v5H5c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-9c0-1.1-.9-2-2-2zM6 5h10v3H6V5zm13 14H5v-9h14v9z"/>
            </svg>
            <span>QR-Code drucken</span>
          </a>
        </div>
        <div class="spule-info">
          <p><strong>Spulen-ID:</strong> <span class="spule-id"></span></p>
          <p><strong>Gesamtmenge:</strong> <span class="spule-gesamtmenge"></span> g</p>
          <p><strong>Restmenge:</strong> <span class="spule-restmenge"></span> g</p>
        </div>
        <div class="restmenge-bar-wrapper">
          <div class="restmenge-bar" style="width: 75%;"></div>
        </div>
      </div>
    </template>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  let typId = null;

  // Versuch 1: Query-Parameter
  const urlParams = new URLSearchParams(window.location.search);
  typId = urlParams.get("typ_id");

  // Versuch 2: Pfad aus URL auslesen, falls keine Query
  if (!typId) {
    const pathParts = window.location.pathname.split('/');
    if (pathParts.length > 2) {
      typId = pathParts[2];
    }
  }

  if (!typId) return;

  fetch(`/typs/${typId}`)
    .then(response => response.json())
    .then(typ => {
      document.getElementById("filament-title").textContent = typ.name;
      document.getElementById("typ-material").textContent = typ.material;
      document.getElementById("typ-farbe").textContent = typ.farbe;
      document.getElementById("typ-durchmesser").textContent = typ.durchmesser;
      document.getElementById("typ-hersteller").textContent = typ.hersteller || "-";
      document.getElementById("typ-leergewicht").textContent = typ.leergewicht || "-";

      const container = document.getElementById("spulen-container");
      const template = document.getElementById("spule-template");

      typ.spulen.forEach(spule => {
        const clone = template.content.cloneNode(true);
        const img = clone.querySelector("img");
        const bildName = (typ.bildname || 'platzhalter.jpg').split('/').pop();
        img.src = `/static/assets/images/${bildName}`;
        img.onerror = function() {
          this.onerror = null;
          this.src = '/static/assets/images/platzhalter.jpg';
        };
        clone.querySelector(".spule-id").textContent = spule.spulen_id;
        clone.querySelector(".download-qrcode").href = `/static/assets/images/qrcodes/qrcode_spule_id_${spule.spulen_id}.png`;
        const printBtn = clone.querySelector(".print-qrcode");
        printBtn.setAttribute("data-id", spule.spulen_id);
        printBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          selectedSpuleId = spule.spulen_id;
          showQrPopup();
        });
        clone.querySelector(".spule-restmenge").textContent = spule.restmenge;
        clone.querySelector(".spule-gesamtmenge").textContent = spule.gesamtmenge;
        const restBar = clone.querySelector(".restmenge-bar");
        const rest = Math.round((spule.restmenge / spule.gesamtmenge) * 100);
        if (spule.in_printer) {
          restBar.style.width = "100%";
          restBar.classList.add("in-printer");
          restBar.textContent = "Im Drucker";
        } else {
          restBar.style.width = rest + "%";
          restBar.textContent = "";
        }
        if (spule.verpackt) {
          clone.querySelector(".verpackt-label").style.display = "block";
        }

        const spuleCard = clone.querySelector(".spule-card");
        // --- Farbklassenzuweisung (Farbrand) ---
        const farbe = typ.farbe?.toLowerCase().replace(/\s+/g, "") || "";
        let farbschlüssel = "";
        if (farbe.includes("blau")) farbschlüssel = "blau";
        else if (farbe.includes("rot")) farbschlüssel = "rot";
        else if (farbe.includes("grau")) farbschlüssel = "grau";
        else if (farbe.includes("magenta")) farbschlüssel = "magenta";
        else if (farbe.includes("pink")) farbschlüssel = "pink";
        else if (farbe.includes("cyan")) farbschlüssel = "cyan";
        else if (farbe.includes("birke")) farbschlüssel = "birke";
        else if (farbe.includes("gelb")) farbschlüssel = "gelb";
        else if (farbe.includes("schwarz")) farbschlüssel = "schwarz";
        else if (farbe.includes("weiß") || farbe.includes("weiss")) farbschlüssel = "weiß";
        else if (farbe.includes("grün")) farbschlüssel = "grün";
        else if (farbe.includes("orange")) farbschlüssel = "orange";
        else if (farbe.includes("violett")) farbschlüssel = "violett";
        else if (farbe.includes("silber")) farbschlüssel = "silber";
        else if (farbe.includes("gold")) farbschlüssel = "gold";
        else if (farbe.includes("kupfer")) farbschlüssel = "kupfer";
        else if (farbe.includes("transparent")) farbschlüssel = "transparent";
        else if (farbe.includes("natur")) farbschlüssel = "natur";
        else if (farbe.includes("braun")) farbschlüssel = "braun";
        if (farbschlüssel) spuleCard.classList.add("border-" + farbschlüssel);
        // --- Ende Farbklassenzuweisung ---
        spuleCard.dataset.typId = typId;
        spuleCard.dataset.spulenId = spule.spulen_id;
        spuleCard.addEventListener("click", () => {
          window.location.href = `/typ/${typId}/id${spule.spulen_id}`;
        });

        const editBtn = clone.querySelector(".bearbeiten-button");
        editBtn.setAttribute("data-id", spule.spulen_id);
        editBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          selectedSpuleId = spule.spulen_id;
          document.getElementById("edit-restmenge").value = spule.restmenge;
          document.getElementById("edit-gesamtmenge").value = spule.gesamtmenge;
          document.getElementById("edit-in-printer").checked = spule.in_printer;
          document.getElementById("spulen-bearbeiten-popup").classList.remove("hidden");
          document.body.classList.add("blurred");
        });


        container.appendChild(clone);
      });
    });
  // Keydown event for closing popups with Escape
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      const popup = document.getElementById("spulen-bearbeiten-popup");
      if (!popup.classList.contains("hidden")) {
        closeSpulenPopup();
      }

      const qrPopup = document.getElementById("qr-confirm-popup");
      if (!qrPopup.classList.contains("hidden")) {
        closeQrPopup();
      }
    }
  });

  // Attach save and delete handlers after DOM is ready and popup elements exist
  document.getElementById("save-edit").addEventListener("click", () => {
    const menge = document.getElementById("edit-restmenge").value;
    fetch(`/spulen/${selectedSpuleId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        restmenge: menge,
        gesamtmenge: document.getElementById("edit-gesamtmenge").value,
        in_printer: document.getElementById("edit-in-printer").checked
      })
    }).then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          alert(data.detail || "Fehler beim Speichern.");
          throw new Error(data.detail);
        });
      }
      closeSpulenPopup();
      location.reload();
    });
  });

  document.getElementById("delete-spule").addEventListener("click", () => {
    fetch(`/spulen/${selectedSpuleId}`, {
      method: "DELETE"
    }).then(() => {
      closeSpulenPopup();
      location.reload();
    });
  });
});

let selectedSpuleId = null;


function closeSpulenPopup() {
  document.getElementById('spulen-bearbeiten-popup').classList.add('hidden');

  // Only remove blur if no other popups are open
  const anyVisiblePopup = document.querySelectorAll('.popup:not(.hidden)').length > 0;
  if (!anyVisiblePopup) {
    document.body.classList.remove('blurred');
  }
}

</script>

<div id="spulen-bearbeiten-popup" class="popup hidden blur-popup">
  <div class="popup-content">
    <h3>Spule bearbeiten</h3>
    <label for="edit-gesamtmenge">Gesamtmenge (g):</label>
    <input type="number" id="edit-gesamtmenge" class="popup-input" />
    <label for="edit-restmenge">Restmenge (g):</label>
    <input type="number" id="edit-restmenge" class="popup-input" />
    <label for="edit-in-printer" style="display: block; margin: 0.5em 0;">
      <input type="checkbox" id="edit-in-printer" />
      Im Drucker
    </label>
    <div class="popup-buttons">
      <button class="save" id="save-edit">Speichern</button>
      <button class="delete" id="delete-spule">🗑️ Löschen</button>
      <button class="cancel" onclick="closeSpulenPopup()">Abbrechen</button>
    </div>
  </div>
</div>

<script>
function showQrPopup() {
  const popup = document.getElementById('qr-confirm-popup');
  if (popup) {
    popup.classList.remove('hidden');
    document.body.classList.add('blurred');
  }
}

function closeQrPopup() {
  const popup = document.getElementById('qr-confirm-popup');
  if (popup) {
    popup.classList.add('hidden');
    // Only remove blur if no other popups are open
    const anyVisiblePopup = document.querySelectorAll('.popup:not(.hidden)').length > 0;
    if (!anyVisiblePopup) {
      document.body.classList.remove('blurred');
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const confirmButton = document.getElementById("confirm-print");
  confirmButton.addEventListener("click", () => {
    closeQrPopup();
    fetch(`/print_qrcode/${selectedSpuleId}`, {
      method: "POST"
    })
    .then(res => {
      if (res.ok) {
        alert("QR-Code wurde gedruckt.");
      } else {
        return res.text().then(text => { throw new Error(text); });
      }
    })
    .catch(err => alert("Fehler beim Drucken: " + err.message));
  });
});
</script>

<div id="qr-confirm-popup" class="popup hidden blur-popup">
  <div class="popup-content">
    <h3>QR-Code drucken</h3>
    <p>Möchtest du wirklich einen QR-Code-Sticker für die ausgewählte Spule drucken?</p>
    <div class="popup-buttons">
      <button class="cancel-print" onclick="closeQrPopup()">Abbrechen</button>
      <button id="confirm-print">Drucken</button>
    </div>
  </div>
</div>

</body>
</html>