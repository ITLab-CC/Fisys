<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Filamenttypen | Fisys</title>
  <link rel="stylesheet" href="/static/assets/css/tailwind.css" />
</head>
<body class="min-h-screen flex bg-gray-800">
  <!-- Sidebar -->
  <aside class="w-64 bg-[#0f172a] text-white flex flex-col justify-between fixed h-full">
    <div>
      <div class="pt-1 pb-1">
        <img src="/static/assets/Fisys Logo.png" alt="Fisys Logo" class="h-20 mx-auto">
      </div>
      <nav class="px-4 space-y-2">
        <a href="/" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Dashboard</a>
        <a href="/spulen.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Spulen</a>
        <a href="/filamentseite.html" class="block px-4 py-2 rounded bg-gray-800 font-semibold text-white">Filamenttypen</a>
        <hr class="my-2 border-gray-700" />
        <a href="/status" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Status</a>
        <a href="/einstellungen.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition text-gray-300">Einstellungen</a>
      </nav>
    </div>
    <div class="mt-auto">
      <div class="px-4 pb-2">
        <div id="auth-bereich" class="text-center text-sm text-gray-300"></div>
      </div>
      <div class="p-4 text-xs text-center text-gray-400">© 2025 Fisys</div>
    </div>
  </aside>

  <!-- Main content -->
  <div class="flex-1 flex flex-col ml-64">
    <header class="bg-gray-800 px-10 py-10">
      <h1 class="text-3xl text-white font-bold">Filamenttypen</h1>
      <p class="text-sm text-gray-200 mt-1">Alle verfügbaren Typen im Überblick</p>
    </header>

    <section class="flex-1 pt-2 px-10 pb-10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <input
          type="text"
          id="suchfeld"
          placeholder="Filamenttyp suchen..."
          maxlength="50"
          class="w-full md:w-1/3 px-4 py-2 text-white bg-gray-700 border border-gray-200 rounded shadow-sm text-sm focus:outline-none focus:ring focus:border-blue-300"
        />
        <div class="flex gap-2" id="button-container" style="display: none;">
          <button id="btn-typ-hinzufuegen" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">+ Typ hinzufügen</button>
          <button id="btn-spule-hinzufuegen" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">+ Spule hinzufügen</button>
        </div>
      </div>
      <!-- Modal Spule hinzufügen -->
      <div id="modal-spule" class="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 rounded-lg w-full max-w-md p-6">
          <h2 class="text-xl text-white font-bold mb-4">Neue Spule hinzufügen</h2>
          <form id="modal-spule-form" class="space-y-4">
            <div>
              <label for="spule-typ" class="block text-white font-medium mb-1">Filamenttyp <span class="text-red-500">*</span></label>
              <div class="relative">
                <button id="dropdown-button" type="button" class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-left focus:outline-none focus:ring focus:border-blue-500 flex justify-between items-center">
                  <span id="dropdown-selected" class="text-white">Bitte wählen</span>
                  <svg class="w-4 h-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div id="dropdown-container" class="absolute z-10 hidden text-white w-full bg-gray-600 border border-gray-500 rounded mt-1 shadow-lg">
                  <input type="text" id="dropdown-search" placeholder="Suchen..." maxlength="50" class="w-full px-3 py-2 bg-gray-600 text-white border-b border-gray-300 text-sm focus:outline-none">
                  <ul id="dropdown-list" class="max-h-48 overflow-auto"></ul>
                </div>
              </div>
              <input type="hidden" id="spule-typ" name="spule-typ" required />
            </div>
            <div>
              <label for="gesamtmenge" class="block text-white font-medium mb-1">Gesamtmenge (g) <span class="text-red-500">*</span></label>
              <input type="number" id="gesamtmenge" name="gesamtmenge" min="1" max="99999" step="1" inputmode="numeric" oninput="this.value = this.value.replace(/\D/g,'').slice(0,5)" required class="w-full bg-gray-600 text-white border border-gray-500 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
            </div>
            <div>
              <label for="spulen-anzahl" class="block text-white font-medium mb-1">Anzahl Spulen <span class="text-red-500">*</span></label>
              <input type="number" id="spulen-anzahl" name="spulen-anzahl" value="1" min="1" max="50" step="1" inputmode="numeric" oninput="this.value = this.value.replace(/\\D/g,'').slice(0,2)" required class="w-full bg-gray-600 text-white border border-gray-500 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
            </div>
            <div class="flex justify-end gap-2 pt-4">
              <button type="button" id="modal-spule-cancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Abbrechen</button>
              <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Speichern</button>
            </div>
          </form>
        </div>
      </div>
      <div id="spulen-container" class="grid gap-8 mt-4 justify-center grid-cols-[repeat(auto-fill,minmax(384px,384px))]"></div>
    </section>
  </div>

  <script>
// Stelle sicher, dass das Modal für "+ Spule hinzufügen" zuverlässig geöffnet wird
window.addEventListener("DOMContentLoaded", () => {
  // Für Typenmodal Abbrechen-Button
  const cancelTypBtn = document.getElementById("modal-cancel");
  const modalTyp = document.getElementById("modal");
  if (cancelTypBtn && modalTyp) {
    cancelTypBtn.addEventListener("click", () => {
      modalTyp.classList.add("hidden");
    });
  }

  async function loadTypen() {
    // Hole Benutzerrolle
    const userInfo = await fetch("/api/userinfo");
    const daten = userInfo.ok ? await userInfo.json() : {};
    const res = await fetch("/typs/");
    const typen = await res.json();

    const container = document.getElementById("spulen-container");
    container.innerHTML = "";

    typen.forEach(typ => {
      const el = document.createElement("div");
      el.innerHTML = `
        <div class="bg-gray-700 rounded-xl shadow-sm max-w-sm w-full mx-auto flex flex-col overflow-hidden border border-gray-200">
          <div class="relative">
            <img src="/static/assets/images/${typ.bildname && typ.bildname !== 'null' ? typ.bildname : 'platzhalter.jpg'}" alt="${typ.name}" class="w-full h-32 object-cover" />
            <div class="absolute top-2 right-2 bg-gray-700 text-white text-sm px-2 py-0.5 rounded-lg">
              ${typ.spulen.length}
            </div>
          </div>
          <div class="p-4 flex flex-col space-y-1 text-sm text-gray-200">
            <div class="font-semibold text-white text-base">${typ.name}</div>
            <div class="flex justify-between"><span>Material:</span><span>${typ.material}</span></div>
            <div class="flex justify-between"><span>Farbe:</span><span>${typ.farbe}</span></div>
            <div class="flex justify-between"><span>Durchmesser:</span><span>${typ.durchmesser} mm</span></div>
            <div class="flex justify-between"><span>Hersteller:</span><span>${typ.hersteller || '–'}</span></div>
            <div class="flex justify-between"><span>Leergewicht:</span><span>${typ.leergewicht ?? 0} g</span></div>
            ${typ.hinweise ? `<p class="text-gray-500 text-xs italic mt-2">${typ.hinweise}</p>` : ''}
            <div class="pt-2 flex gap-2">
              <a href="/spulen.html?typ_id=${typ.id}" class="flex-1 inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm font-medium text-center">
                Spulen ansehen
              </a>
              ${["mod", "admin"].includes(daten.rolle) ? `
                <button data-id="${typ.id}" class="bearbeite-typ-btn px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition text-sm font-medium">
                  Bearbeiten
                </button>
              ` : ""}
              ${["mod", "admin"].includes(daten.rolle) ? `
                <button data-id="${typ.id}" class="delete-typ-btn px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm font-medium">
                  Löschen
                </button>
              ` : ""}
            </div>
          </div>
        </div>
      `;
      container.appendChild(el);
      // Bearbeiten-Button Event-Listener nur hinzufügen, wenn Button existiert
      const bearbeiteBtn = el.querySelector(".bearbeite-typ-btn");
      if (bearbeiteBtn) {
        bearbeiteBtn.addEventListener("click", () => {
          // Modal öffnen
          const modal = document.getElementById("modal");
          const form = document.getElementById("modal-form");
          modal.classList.remove("hidden");
          document.body.style.overflow = "hidden";
          document.body.classList.add("overflow-hidden");

          // Formular mit bestehenden Daten füllen
          form.name.value = typ.name;
          form.material.value = typ.material;
          form.farbe.value = typ.farbe;
          form.durchmesser.value = typ.durchmesser;
          form.hersteller.value = typ.hersteller || "";
          form.hinweise.value = typ.hinweise || "";
          form.leergewicht.value = typ.leergewicht ?? 0;

          form.setAttribute("data-mode", "edit");
          form.setAttribute("data-id", typ.id);
        });
      }
      // Löschen-Button Event-Listener nur hinzufügen, wenn Button existiert
      const deleteBtn = el.querySelector(".delete-typ-btn");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", async () => {
          if (typ.spulen.length > 0) {
            zeigeHinweis("Dieser Typ kann nicht gelöscht werden, da ihm noch Spulen zugeordnet sind.", "bg-red-600");
            return;
          }

          const confirmModal = document.getElementById("confirm-modal");
          const confirmOk = document.getElementById("confirm-ok");
          const confirmCancel = document.getElementById("confirm-cancel");

          confirmModal.classList.remove("hidden");
          document.body.classList.add("overflow-hidden");

          // Remove previous handlers first, to avoid stacking
          confirmOk.onclick = null;
          confirmCancel.onclick = null;

          confirmOk.onclick = async () => {
            confirmModal.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
            const res = await fetch(`/typs/${typ.id}`, { method: "DELETE" });
            if (res.ok) {
              loadTypen();
            } else {
              zeigeHinweis("Fehler beim Löschen des Typs.", "bg-red-600");
            }
          };
          confirmCancel.onclick = () => {
            confirmModal.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
          };
        });
      }
    });

    const modal = document.getElementById("modal");
    const addTypBtn = document.querySelector('button.bg-green-600');
    const cancelBtn = document.getElementById("modal-cancel");

    addTypBtn.addEventListener("click", async () => {
      const res = await fetch("/api/userinfo");
      if (!res.ok) {
        zeigeHinweis("Nicht berechtigt.", "bg-red-600");
        return;
      }
      const data = await res.json();
      if (!["helper", "mod", "admin"].includes(data.rolle)) {
        zeigeHinweis("Keine Berechtigung, um einen Typ hinzuzufügen.", "bg-red-600");
        return;
      }
      modal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      document.body.classList.add("overflow-hidden");
    });

    cancelBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
      document.body.style.overflow = "";
      document.body.classList.remove("overflow-hidden");
    });
  }

  // Suchfunktion für Filamenttypen
  const suchfeld = document.getElementById("suchfeld");
  suchfeld.addEventListener("input", () => {
    const searchTerm = suchfeld.value.toLowerCase();
    const cards = document.querySelectorAll("#spulen-container > div");
    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(searchTerm) ? "" : "none";
    });
  });

  // --- Modal "+ Spule hinzufügen" mit Dropdown ---
  const modalSpule = document.getElementById("modal-spule");
  const formSpule = document.getElementById("modal-spule-form");
  const addSpuleBtn = document.querySelector('button.bg-blue-600'); // Der blaue Button neben Typ hinzufügen
  const cancelSpuleBtn = document.getElementById("modal-spule-cancel");
  const spulenContainer = document.getElementById("spulen-container");

  const dropdownButton = document.getElementById("dropdown-button");
  const dropdownContainer = document.getElementById("dropdown-container");
  const dropdownList = document.getElementById("dropdown-list");
  const dropdownSearch = document.getElementById("dropdown-search");
  const dropdownSelected = document.getElementById("dropdown-selected");
  const hiddenSelect = document.getElementById("spule-typ");
  const spulenAnzahlInput = document.getElementById("spulen-anzahl");
  const gesamtmengeInput = document.getElementById("gesamtmenge");

  // Toggle dropdown visibility und passe Popup-Höhe dynamisch an
  const popupContent = modalSpule.querySelector("div.bg-white");

  dropdownButton.addEventListener("click", () => {
    dropdownContainer.classList.toggle("hidden");

    if (!dropdownContainer.classList.contains("hidden")) {
      popupContent.style.maxHeight = "95vh"; // Popup vergrößern
    } else {
      popupContent.style.maxHeight = "90vh"; // Zurück zur Standardhöhe
    }
  });

  // Close dropdown on outside click
  document.addEventListener("click", (e) => {
    if (!dropdownButton.contains(e.target) && !dropdownContainer.contains(e.target)) {
      dropdownContainer.classList.add("hidden");
    }
  });

  // Typen werden global zwischengespeichert
  let typenCache = [];

  // Populate dropdown with types, cache sie in typenCache
  async function loadTypenDropdown() {
    const res = await fetch("/typs/");
    typenCache = await res.json();

    dropdownList.innerHTML = "";
    typenCache.forEach(typ => {
      const li = document.createElement("li");
      li.className = "px-3 py-2 hover:bg-gray-500 cursor-pointer";
      li.innerHTML = `
        <div class="font-semibold">${typ.name}</div>
        <div class="text-xs text-gray-200">${typ.material}, ${typ.farbe}, ${typ.durchmesser} mm</div>
      `;
      li.addEventListener("click", () => {
        dropdownSelected.innerHTML = `
          <div class="flex flex-col text-xs leading-tight">
            <span class="font-semibold">${typ.name}</span>
            <span>${typ.material}, ${typ.farbe}, ${typ.durchmesser} mm</span>
          </div>
        `;
        hiddenSelect.value = typ.id;
        dropdownContainer.classList.add("hidden");
      });
      dropdownList.appendChild(li);
    });
    // Reset search and add search event
    dropdownSearch.value = "";
    dropdownSearch.addEventListener("input", () => {
      const searchTerm = dropdownSearch.value.toLowerCase();
      const items = dropdownList.querySelectorAll("li");
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? "" : "none";
      });
    });
  }

  // Klasse zum Abdunkeln des Hintergrunds beim Öffnen des Modals
  function darkenSpulenContainer() {
    spulenContainer.classList.add("spulen-dimmed");
  }
  function undarkenSpulenContainer() {
    spulenContainer.classList.remove("spulen-dimmed");
  }

  function resetSpuleForm() {
    formSpule.reset();
    dropdownSelected.textContent = "Bitte wählen";
    hiddenSelect.value = "";
    if (dropdownSearch) {
      dropdownSearch.value = "";
    }
    dropdownContainer.classList.add("hidden");
    spulenAnzahlInput.value = "1";
  }

  addSpuleBtn.addEventListener("click", async () => {
    const res = await fetch("/api/userinfo");
    if (!res.ok) {
      zeigeHinweis("Nicht berechtigt.", "bg-red-600");
      return;
    }
    const data = await res.json();
    if (!["helper", "mod", "admin"].includes(data.rolle)) {
      zeigeHinweis("Keine Berechtigung, um eine Spule hinzuzufügen.", "bg-red-600");
      return;
    }
    resetSpuleForm();
    await loadTypenDropdown();
    modalSpule.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    document.body.classList.add("overflow-hidden");
    darkenSpulenContainer();
  });

  cancelSpuleBtn.addEventListener("click", () => {
    modalSpule.classList.add("hidden");
    document.body.style.overflow = "";
    document.body.classList.remove("overflow-hidden");
    resetSpuleForm();
    undarkenSpulenContainer();
  });

  formSpule.addEventListener("submit", async (e) => {
    e.preventDefault();

    const typId = hiddenSelect.value;
    const gesamtmenge = parseInt(gesamtmengeInput.value, 10);
    const anzahl = parseInt(spulenAnzahlInput.value, 10);

    if (!typId) {
      zeigeHinweis("Bitte wählen Sie einen Typ aus.", "bg-yellow-600");
      return;
    }

    if (!Number.isFinite(gesamtmenge) || gesamtmenge <= 0) {
      zeigeHinweis("Bitte geben Sie eine gültige Gesamtmenge ein.", "bg-yellow-600");
      gesamtmengeInput.focus();
      return;
    }

    if (!Number.isInteger(anzahl) || anzahl <= 0) {
      zeigeHinweis("Bitte geben Sie eine gültige Anzahl an Spulen ein.", "bg-yellow-600");
      spulenAnzahlInput.focus();
      return;
    }

    if (anzahl > 50) {
      zeigeHinweis("Maximal 50 Spulen können auf einmal angelegt werden.", "bg-yellow-600");
      spulenAnzahlInput.focus();
      return;
    }

    const typ = typenCache.find(t => t.id === parseInt(typId, 10));

    if (!typ) {
      zeigeHinweis("Der ausgewählte Typ wurde nicht gefunden.", "bg-yellow-600");
      return;
    }

    const payload = {
      name: typ.name,
      material: typ.material,
      farbe: typ.farbe,
      durchmesser: typ.durchmesser,
      hersteller: typ.hersteller,
      leergewicht: typ.leergewicht,
      gesamtmenge: gesamtmenge,
      restmenge: gesamtmenge,
      verpackt: true,
      in_printer: false
    };

    let createdCount = 0;
    let errorDetail = "";

    for (let i = 0; i < anzahl; i++) {
      const response = await fetch("/spulen/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        try {
          const err = await response.json();
          errorDetail = typeof err === "string" ? err : err.detail || err.message || response.statusText;
        } catch (_) {
          errorDetail = response.statusText;
        }
        break;
      }

      createdCount += 1;
    }

    if (createdCount === anzahl) {
      resetSpuleForm();
      modalSpule.classList.add("hidden");
      document.body.style.overflow = "";
      document.body.classList.remove("overflow-hidden");
      undarkenSpulenContainer();
      loadTypen();
      const successMsg = `${anzahl} Spule${anzahl > 1 ? "n" : ""} erfolgreich hinzugefügt.`;
      zeigeHinweis(successMsg, "bg-green-600");
    } else if (createdCount > 0) {
      loadTypen();
      const partialMsg = `${createdCount} von ${anzahl} Spulen hinzugefügt. ${errorDetail || "Bitte erneut versuchen."}`;
      zeigeHinweis(partialMsg.trim(), "bg-yellow-600");
    } else {
      const errorMsg = errorDetail ? `Fehler beim Hinzufügen der Spulen: ${errorDetail}` : "Fehler beim Hinzufügen der Spulen";
      zeigeHinweis(errorMsg, "bg-red-600");
    }
  });

  // Optional: Entferne Abdunklung, falls Modal-Spule durch andere Aktionen geschlossen wird
  // (z. B. Escape-Taste oder Klick außerhalb)
  document.addEventListener("keydown", (e) => {
    if (!modalSpule.classList.contains("hidden") && e.key === "Escape") {
      modalSpule.classList.add("hidden");
      document.body.style.overflow = "";
      document.body.classList.remove("overflow-hidden");
      resetSpuleForm();
      undarkenSpulenContainer();
    }
  });

  // Optional: Klick auf Overlay schließt Modal
  modalSpule.addEventListener("click", (e) => {
    if (e.target === modalSpule) {
      modalSpule.classList.add("hidden");
      document.body.style.overflow = "";
      document.body.classList.remove("overflow-hidden");
      resetSpuleForm();
      undarkenSpulenContainer();
    }
  });
  // Style für das Abdunkeln von #spulen-container
  const style = document.createElement("style");
  style.innerHTML = `
    #spulen-container.spulen-dimmed {
      opacity: 0.3;
      pointer-events: none;
      transition: opacity 0.2s;
    }
  `;
  document.head.appendChild(style);

  const modal = document.getElementById("modal");
  const form = document.getElementById("modal-form");
  const addTypBtn = document.querySelector('button.bg-green-600');
  const cancelBtn = document.getElementById("modal-cancel");

  addTypBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    document.body.classList.add("overflow-hidden");
  });

  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    document.body.style.overflow = "";
    document.body.classList.remove("overflow-hidden");
  });

  // Schließen bei Escape
  document.addEventListener("keydown", (e) => {
    if (!modal.classList.contains("hidden") && e.key === "Escape") {
      modal.classList.add("hidden");
      document.body.style.overflow = "";
      document.body.classList.remove("overflow-hidden");
    }
  });

  // Schließen bei Klick außerhalb
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
      document.body.style.overflow = "";
      document.body.classList.remove("overflow-hidden");
    }
  });

  // Registriere den Submit-Listener für das Typen-Formular nur einmal beim Laden der Seite
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const mode = form.getAttribute("data-mode");
    const typId = form.getAttribute("data-id");
    const typ = typenCache.find(t => t.id === parseInt(typId, 10));
    const data = {
      name: formData.get("name"),
      material: formData.get("material"),
      farbe: formData.get("farbe"),
      durchmesser: parseFloat(formData.get("durchmesser")),
      hersteller: formData.get("hersteller") || null,
      hinweise: formData.get("hinweise") || null,
      leergewicht: parseFloat(formData.get("leergewicht")) || 0
    };

    if (mode === "edit" && typ?.bildname && typ.bildname !== "null") {
      data.bildname = typ.bildname;
    }

    const response = await fetch(mode === "edit" ? `/typs/${typId}` : "/typs/", {
      method: mode === "edit" ? "PATCH" : "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      modal.classList.add("hidden");
      form.reset();
      form.removeAttribute("data-mode");
      form.removeAttribute("data-id");
      document.body.style.overflow = "";
      document.body.classList.remove("overflow-hidden");
      loadTypen();
    } else {
      zeigeHinweis("Fehler beim Hinzufügen", "bg-red-600");
    }
  });
// Benachrichtigungssystem
function zeigeHinweis(nachricht, farbe = "bg-gray-800") {
  const box = document.getElementById("benachrichtigung");
  box.textContent = nachricht;
  box.className = `fixed bottom-6 right-6 text-white text-sm px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-300 ${farbe}`;
  box.classList.remove("hidden");
  box.style.opacity = 1;

  setTimeout(() => {
    box.style.opacity = 0;
    setTimeout(() => box.classList.add("hidden"), 300);
  }, 3000);
}

  loadTypen();

  // Auth-Bereich (Login/Logout)
  const authBereich = document.getElementById("auth-bereich");

  async function ladeAuthStatus() {
    try {
      const res = await fetch("/api/userinfo");
      if (res.ok) {
        const daten = await res.json();
        authBereich.innerHTML = `
          <form id="logoutForm" class="flex flex-col items-center">
            <span class="text-sm text-gray-300 mb-1">Angemeldet als ${daten.username}</span>
            <button type="submit" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition w-full">Logout</button>
          </form>
        `;
        const logoutForm = document.getElementById("logoutForm");
        logoutForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          await fetch("/logout", { method: "POST" });
          location.reload();
        });
      } else {
        authBereich.innerHTML = `
          <a href="/login" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition">Login</a>
        `;
      }
    } catch (err) {
      authBereich.innerHTML = `
        <a href="/login" class="block px-4 py-2 rounded text-white text-sm text-center bg-gray-800 hover:bg-gray-700 transition">Login</a>
      `;
    }
  }

  ladeAuthStatus();

  // Buttons nur für berechtigte Rollen anzeigen
  (async () => {
    const buttonContainer = document.getElementById("button-container");
    const btnTyp = document.getElementById("btn-typ-hinzufuegen");
    const btnSpule = document.getElementById("btn-spule-hinzufuegen");
    try {
      const res = await fetch("/api/userinfo");
      if (res.ok) {
        const daten = await res.json();
        if (["helper", "mod", "admin"].includes(daten.rolle)) {
          buttonContainer.style.display = "flex";
        }
      }
    } catch (err) {
      // Bei Fehler nichts anzeigen
    }
  })();
});
  </script>
  <!-- Bestätigungs-Modal für Typ-Löschen -->
  <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-700 rounded-lg w-full max-w-sm p-6 text-center">
      <h3 class="text-lg text-white font-semibold mb-4">Typ löschen?</h3>
      <p class="text-sm text-gray-200 mb-6">Möchten Sie diesen Typ wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.</p>
      <div class="flex justify-center gap-4">
        <button id="confirm-cancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Abbrechen</button>
        <button id="confirm-ok" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Löschen</button>
      </div>
    </div>
  </div>
  <div id="benachrichtigung" class="fixed bottom-6 right-6 bg-gray-800 text-white text-sm px-4 py-2 rounded shadow-lg z-50 hidden transition-opacity duration-300"></div>
</body>
<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-gray-700 rounded-lg w-full max-w-md p-6">
    <h2 class="text-xl text-white font-bold mb-4">Neuen Filamenttyp hinzufügen</h2>
    <form id="modal-form" class="space-y-4">
  <div>
    <label for="name" class="block text-white font-medium mb-1">Name <span class="text-red-500">*</span></label>
    <input type="text" id="name" name="name" required placeholder="z. B. Bambu Basic" maxlength="25" class="w-full border border-gray-500 bg-gray-600 text-white px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
  </div>
  <div>
    <label for="material" class="block text-white font-medium mb-1">Material <span class="text-red-500">*</span></label>
    <input type="text" id="material" name="material" required placeholder="z. B. PLA, PETG" maxlength="10" class="w-full border border-gray-500 bg-gray-600 text-white rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
  </div>
  <div>
    <label for="farbe" class="block text-white font-medium mb-1">Farbe <span class="text-red-500">*</span></label>
    <input type="text" id="farbe" name="farbe" required placeholder="z. B. Schwarz, Rot" maxlength="25" class="w-full border border-gray-500 bg-gray-600 text-white rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
  </div>
  <div>
    <label for="durchmesser" class="block text-white font-medium mb-1">Durchmesser (mm) <span class="text-red-500">*</span></label>
    <input type="number" step="0.01" id="durchmesser" name="durchmesser" value="1.75" inputmode="decimal" oninput="if(this.value && this.value.toString().length>10){this.value=this.value.toString().slice(0,10)}" required class="w-full border border-gray-500 bg-gray-600 text-white rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
  </div>
  <div>
    <label for="hersteller" class="block text-white font-medium mb-1">Hersteller</label>
    <input type="text" id="hersteller" name="hersteller" placeholder="Optional" maxlength="25" class="w-full border border-gray-500 bg-gray-600 text-white rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
  </div>
  <div>
    <label for="hinweise" class="block text-white font-medium mb-1">Hinweise</label>
    <textarea id="hinweise" name="hinweise" rows="3" placeholder="Optional" maxlength="100" class="w-full border border-gray-500 bg-gray-600 text-white rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500 resize-none"></textarea>
  </div>
  <div>
    <label for="leergewicht" class="block text-white font-medium mb-1">Leergewicht (g) <span class="text-red-500">*</span></label>
    <input type="number" step="1" min="0" max="99999" id="leergewicht" name="leergewicht" placeholder="Gewicht der Spule ohne Filament" inputmode="numeric" oninput="this.value = this.value.replace(/\D/g,'').slice(0,5)" required class="w-full border border-gray-500 bg-gray-600 text-white rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
  </div>
  <div class="flex justify-end gap-2 pt-4">
    <button type="button" id="modal-cancel" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Abbrechen</button>
    <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Speichern</button>
  </div>
</form>
  </div>
</div>
</html>
